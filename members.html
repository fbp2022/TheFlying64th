<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Members – The Flying 64th</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#0b1117; --ink:#e6edf3; --muted:#9fb1c3;
      --panel:#0f1722; --panel2:#0c141f; --rule:#1f2a38; --accent:#58a6ff;
      --ok:#2e7d32; --bad:#9b2d2d;
      --radius:16px;
    }
    *{box-sizing:border-box}
    html,body{margin:0;height:100%}
    body{font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--ink)}

    /* NAV */
    .site-header{position:sticky;top:0;z-index:50;backdrop-filter:saturate(160%) blur(8px);
      background:rgba(11,17,23,.75);border-bottom:1px solid var(--rule)}
    .nav{max-width:1200px;margin:0 auto;padding:12px 18px;display:flex;align-items:center;justify-content:space-between;gap:12px}
    .brand{display:flex;align-items:center;gap:10px;color:var(--ink);text-decoration:none;font-weight:800;font-size:22px}
    .brand img{height:34px;width:auto}
    header nav{display:flex;align-items:center;gap:18px}
    header nav a{color:var(--muted);text-decoration:none;padding:8px 12px;border-radius:10px;transition:all .18s ease}
    header nav a.active{background:var(--accent);color:#001a33;font-weight:700}
    header nav a:hover{color:var(--ink);background:rgba(255,255,255,.06)}
    .btn{border:1px solid var(--rule);background:#121b29;color:#e6edf3;padding:8px 12px;border-radius:10px;cursor:pointer}
    .btn.primary{background:var(--accent);border-color:transparent;color:#001a33;font-weight:700}
    .btn.ghost{background:transparent}
    .btn.warn{background:#1e1717;border-color:#4b2a2a}
    .btn.ok{background:#16311f;border-color:#2d5f3b}

    /* LAYOUT */
    .container{max-width:1100px;margin:16px auto;padding:0 18px 36px}
    .card{background:linear-gradient(180deg,var(--panel),var(--panel2));border:1px solid var(--rule);
      border-radius:14px;padding:16px 16px 14px}
    .top-row{display:flex;align-items:center;justify-content:space-between;gap:12px;margin:12px 0}
    .muted{color:var(--muted)}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:900px){.grid{grid-template-columns:1fr}}

    /* MEMBER ITEM */
    .member{border:1px solid var(--rule);border-radius:14px;padding:14px;background:#0e1520}
    .m-top{display:flex;align-items:center;justify-content:space-between;gap:10px}
    .m-name{font-weight:800;font-size:18px}
    .m-email{color:var(--muted);font-size:14px;margin-top:2px}
    .chips{display:flex;gap:8px;flex-wrap:wrap}
    .chip{display:inline-flex;align-items:center;gap:6px;background:#132031;border:1px solid #203148;color:#cfe1ff;padding:6px 10px;border-radius:999px;font-size:12px}
    .chip.ok{background:#152a1f;border-color:#224a2f;color:#a0e1b2}
    .chip.bad{background:#2a1515;border-color:#4a2525;color:#ffbaba}
    .actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}

    /* ADMIN PANEL */
    .admin-panel{display:none;margin:18px 0 12px}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .invite{display:flex;gap:10px;align-items:center;background:#0e1520;border:1px dashed var(--rule);
      padding:10px 12px;border-radius:12px}
    .code{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;
      background:#121b29;border:1px solid var(--rule);padding:8px 10px;border-radius:8px}
    .hint{min-height:18px;color:#9fb1c3;margin-top:6px}
  </style>
</head>
<body>

  <!-- NAV -->
  <header class="site-header">
    <div class="nav">
      <a class="brand" href="home.html">
        <img src="images/flying64thlogo.png" alt="The Flying 64th Logo"/>
        <span>The Flying 64th</span>
      </a>
      <nav>
        <a id="signinBtn" class="btn">Sign In</a>
        <a href="home.html">Home</a>
        <a href="calendar.html">Calendar</a>
        <a class="active" href="members.html">Members</a>
        <a href="photos.html">Photos</a>
        <a href="poh&manuals.html">POH &amp; Manuals</a>
      </nav>
    </div>
  </header>

  <main class="container">

    <!-- Heading + Admin tools -->
    <div class="top-row">
      <h1 style="margin:0;font-size:24px;font-weight:800">Members</h1>
      <div class="muted" id="meNote"></div>
    </div>

    <!-- Admin-only simple invite display -->
    <section id="adminPanel" class="card admin-panel" aria-live="polite">
      <h3 style="margin:0 0 10px 0">Admin Tools</h3>
      <div class="invite">
        <div class="muted">Club Invite Code (display-only):</div>
        <div id="inviteCode" class="code">F64-CHRIS-2025-9QK7ATJ3</div>
        <button id="copyInvite" class="btn">Copy</button>
      </div>
      <div id="adminMsg" class="hint"></div>
    </section>

    <!-- Members list -->
    <section class="card">
      <div class="top-row" style="margin-top:0">
        <div class="muted">Tap buttons below each card to manage status (admins only). Role badges are hidden from public view.</div>
      </div>
      <div id="membersGrid" class="grid"></div>
      <div id="listMsg" class="hint"></div>
    </section>

  </main>

  <!-- Auth modal is centralized in calendar/home; here we just open via #signin -->
  <script>
    // allow /members.html#signin to open the site-wide auth modal
    window.addEventListener('hashchange', ()=>{ if(location.hash==="#signin"){ const a=document.getElementById('signinBtn'); a && a.click(); }});
  </script>

  <script type="module">
    import { auth, db, onAuthChanged, signOut } from './auth.js';
    import {
      doc, getDoc, setDoc, updateDoc,
      collection, query, orderBy, onSnapshot
    } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";
    import {
      signInWithEmailAndPassword, sendPasswordResetEmail
    } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";

    // UI refs
    const signinBtn   = document.getElementById('signinBtn');
    const meNote      = document.getElementById('meNote');
    const grid        = document.getElementById('membersGrid');
    const listMsg     = document.getElementById('listMsg');
    const adminPanel  = document.getElementById('adminPanel');
    const copyInvite  = document.getElementById('copyInvite');
    const adminMsg    = document.getElementById('adminMsg');

    // helpers
    const sayList = (t,isErr=false)=>{ listMsg.textContent=t||""; listMsg.style.color=isErr?'#ffb4b4':'#9fb1c3'; };
    const sayAdmin= (t,isErr=false)=>{ adminMsg.textContent=t||""; adminMsg.style.color=isErr?'#ffb4b4':'#9fb1c3'; };
    const escapeHtml = (s)=> (s||"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;");

    let currentUser = null;
    let iAmAdmin = false;

    // Open auth modal implemented on other pages
    function openAuthModal(){
      // try to navigate to a page that has the modal with hash
      if (location.pathname.endsWith('members.html')){
        // if your header script on this page wires a modal, call it; else bounce to home with #signin
        try{
          const evt = new Event('click');
          signinBtn.dispatchEvent(evt);
        }catch{
          location.href = 'home.html#signin';
        }
      }
    }
    signinBtn.addEventListener('click', ()=>{ location.href = 'home.html#signin'; });

    // Load my role and show admin panel if needed
    async function loadMyRole(){
      iAmAdmin = false;
      if (!currentUser) return;
      try{
        const p = await getDoc(doc(db,'profiles', currentUser.uid));
        const role = (p.exists() ? (p.data().role||'') : '').toLowerCase();
        if (role === 'admin' || role === 'superadmin') iAmAdmin = true;
      }catch(e){ /* ignore */ }
      adminPanel.style.display = iAmAdmin ? 'block' : 'none';
    }

    // Render members
    function renderMembers(docs){
      grid.innerHTML = '';
      if (!docs.length){ sayList('No members found.'); return; }
      sayList('');

      docs.forEach(snap=>{
        const d = snap.data();
        const uid   = snap.id;
        const first = d.firstName || '';
        const last  = d.lastName || '';
        const name  = (first || last) ? `${first} ${last}`.trim() : (d.displayName || 'Member');
        const email = d.email || '';
        const active = d.active !== false;   // default active if field missing
        const role = (d.role||'user').toLowerCase();

        const card = document.createElement('div');
        card.className = 'member';
        card.innerHTML = `
          <div class="m-top">
            <div>
              <div class="m-name">${escapeHtml(name)}</div>
              <div class="m-email">${escapeHtml(email)}</div>
            </div>
            <div class="chips">
              <span class="chip ${active?'ok':''}">${active?'Active':'Inactive'}</span>
              <!-- role badge intentionally hidden from public; not rendered -->
            </div>
          </div>

          ${ iAmAdmin ? `
          <div class="actions">
            <button class="btn ${role==='admin' || role==='superadmin' ? 'ghost' : 'ok'}" data-act="toggle-admin" data-uid="${uid}" data-current="${role}">
              ${ role==='admin' || role==='superadmin' ? 'Remove Admin' : 'Make Admin' }
            </button>
            <button class="btn ${active?'warn':'ok'}" data-act="toggle-active" data-uid="${uid}" data-current="${active?'active':'inactive'}">
              ${ active ? 'Deactivate' : 'Activate' }
            </button>
          </div>` : ``}
        `;
        grid.appendChild(card);
      });

      // wire admin buttons
      if (iAmAdmin){
        grid.querySelectorAll('[data-act="toggle-admin"]').forEach(btn=>{
          btn.addEventListener('click', async ()=>{
            const uid = btn.getAttribute('data-uid');
            const cur = (btn.getAttribute('data-current')||'user').toLowerCase();
            const toAdmin = !(cur==='admin' || cur==='superadmin');
            try{
              await Promise.all([
                updateDoc(doc(db,'profiles',uid), { role: toAdmin ? 'admin' : 'user' }),
                updateDoc(doc(db,'members' ,uid), { role: toAdmin ? 'admin' : 'user' })
              ]);
              sayList(toAdmin?'Made admin.':'Removed admin.');
            }catch(e){ sayList(e.message,true); }
          });
        });

        grid.querySelectorAll('[data-act="toggle-active"]').forEach(btn=>{
          btn.addEventListener('click', async ()=>{
            const uid = btn.getAttribute('data-uid');
            const cur = (btn.getAttribute('data-current')||'active').toLowerCase()==='active';
            const newVal = !cur;
            try{
              await Promise.all([
                updateDoc(doc(db,'profiles',uid), { active: newVal }),
                updateDoc(doc(db,'members' ,uid), { active: newVal })
              ]);
              sayList(newVal?'Activated.':'Deactivated.');
            }catch(e){ sayList(e.message,true); }
          });
        });
      }
    }

    // Live query: order by firstName then lastName to ensure *all* show
    function startLiveList(){
      const q = query(collection(db,'profiles'), orderBy('firstName'), orderBy('lastName'));
      onSnapshot(q, (snap)=>{
        const docs = [];
        snap.forEach(d=> docs.push(d));   // collect all, not just the first
        renderMembers(docs);
      }, (err)=> sayList(err.message,true));
    }

    // Copy invite code
    copyInvite.addEventListener('click', async ()=>{
      try{
        const code = document.getElementById('inviteCode').textContent.trim();
        await navigator.clipboard.writeText(code);
        sayAdmin('Invite code copied.');
      }catch(e){ sayAdmin('Could not copy.', true); }
    });

    // auth state
    onAuthChanged(async (user)=>{
      currentUser = user || null;

      if (currentUser){
        const shortEmail = currentUser.email && currentUser.email.length>25
          ? currentUser.email.slice(0,25)+'…' : (currentUser.email||'');
        document.getElementById('signinBtn').textContent = `Account – ${shortEmail}`;
        meNote.textContent = currentUser.emailVerified ? 'Signed in (verified).' : 'Signed in (verify your email).';

        await loadMyRole();
        startLiveList();
      }else{
        document.getElementById('signinBtn').textContent = 'Sign In';
        meNote.textContent = 'Sign in to view member details.';
        adminPanel.style.display = 'none';
        grid.innerHTML = '';
        sayList('Please sign in to view members.');
      }
    });
  </script>
</body>
</html>
