<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Members – The Flying 64th</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#0b1117; --ink:#e6edf3; --muted:#9fb1c3;
      --panel:#0f1722; --panel2:#0c141f; --rule:#1f2a38; --accent:#58a6ff;
      --ok:#2e7d32; --bad:#9b2d2d;
      --radius:16px;
    }
    *{box-sizing:border-box}
    html,body{margin:0;height:100%}
    body{font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--ink)}

    /* NAV */
    .site-header{position:sticky;top:0;z-index:50;backdrop-filter:saturate(160%) blur(8px);
      background:rgba(11,17,23,.75);border-bottom:1px solid var(--rule)}
    .nav{max-width:1200px;margin:0 auto;padding:12px 18px;display:flex;align-items:center;justify-content:space-between;gap:12px}
    .brand{display:flex;align-items:center;gap:10px;color:var(--ink);text-decoration:none;font-weight:800;font-size:22px}
    .brand img{height:34px;width:auto}
    header nav{display:flex;align-items:center;gap:18px}
    header nav a{color:var(--muted);text-decoration:none;padding:8px 12px;border-radius:10px;transition:all .18s ease}
    header nav a.active{background:var(--accent);color:#001a33;font-weight:700}
    header nav a:hover{color:var(--ink);background:rgba(255,255,255,.06)}
    .btn{border:1px solid var(--rule);background:#121b29;color:#e6edf3;padding:8px 12px;border-radius:10px;cursor:pointer}
    .btn.primary{background:var(--accent);border-color:transparent;color:#001a33;font-weight:700}
    .btn.ghost{background:transparent}
    .btn.warn{background:#1e1717;border-color:#4b2a2a}
    .btn.ok{background:#16311f;border-color:#2d5f3b}

    /* LAYOUT */
    .container{max-width:1100px;margin:16px auto;padding:0 18px 36px}
    .card{background:linear-gradient(180deg,var(--panel),var(--panel2));border:1px solid var(--rule);
      border-radius:14px;padding:16px 16px 14px}
    .top-row{display:flex;align-items:center;justify-content:space-between;gap:12px;margin:12px 0}
    .muted{color:var(--muted)}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:900px){.grid{grid-template-columns:1fr}}

    /* MEMBER ITEM */
    .member{border:1px solid var(--rule);border-radius:14px;padding:14px;background:#0e1520}
    .m-top{display:flex;align-items:center;justify-content:space-between;gap:10px}
    .m-name{font-weight:800;font-size:18px}
    .m-email{color:var(--muted);font-size:14px;margin-top:2px}
    .chips{display:flex;gap:8px;flex-wrap:wrap}
    .chip{display:inline-flex;align-items:center;gap:6px;background:#132031;border:1px solid #203148;color:#cfe1ff;padding:6px 10px;border-radius:999px;font-size:12px}
    .chip.ok{background:#152a1f;border-color:#224a2f;color:#a0e1b2}
    .chip.bad{background:#2a1515;border-color:#4a2525;color:#ffbaba}
    .actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}

    /* ADMIN PANEL */
    .admin-panel{display:none;margin:18px 0 12px}
    .invite{display:flex;gap:10px;align-items:center;background:#0e1520;border:1px dashed var(--rule);
      padding:10px 12px;border-radius:12px}
    .code{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;
      background:#121b29;border:1px solid var(--rule);padding:8px 10px;border-radius:8px}
    .hint{min-height:18px;color:#9fb1c3;margin-top:6px}

    /* AUTH MODAL (local) */
    .auth-modal{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;place-items:center;z-index:1000}
    .auth-modal.open{display:grid}
    .auth-card{width:min(460px,92vw);background:#0f1722;color:#e6edf3;border:1px solid #1f2a38;border-radius:14px;padding:18px 18px 12px;position:relative}
    .auth-x{position:absolute;right:14px;top:12px;border:0;background:transparent;color:#9fb1c3;font-size:18px;cursor:pointer}
    .auth-title{margin:0 0 10px 0;font-size:20px;font-weight:800}
    .auth-label{display:block;margin-top:10px;margin-bottom:4px;color:#9fb1c3;font-size:13px}
    .auth-input{width:100%;padding:10px 12px;border-radius:10px;border:1px solid #1f2a38;background:#0b1117;color:#e6edf3}
    .auth-row{display:flex;gap:10px;align-items:center;justify-content:space-between;margin-top:12px}
    .auth-btn{flex:1;padding:10px 12px;border-radius:10px;border:1px solid #1f2a38;background:#141b26;color:#e6edf3;cursor:pointer}
    .auth-btn.primary{background:#58a6ff;color:#001a33;border-color:transparent;font-weight:700}
    .auth-link{background:none;border:0;color:#9fb1c3;cursor:pointer}
    .auth-msg{min-height:18px;color:#9fb1c3;margin:8px 0 4px}
  </style>
</head>
<body>

  <!-- NAV -->
  <header class="site-header">
    <div class="nav">
      <a class="brand" href="home.html">
        <img src="images/flying64thlogo.png" alt="The Flying 64th Logo"/>
        <span>The Flying 64th</span>
      </a>
      <nav>
        <a id="signinBtn" class="btn">Sign In</a>
        <a href="home.html">Home</a>
        <a href="calendar.html">Calendar</a>
        <a class="active" href="members.html">Members</a>
        <a href="photos.html">Photos</a>
        <a href="poh&manuals.html">POH &amp; Manuals</a>
      </nav>
    </div>
  </header>

  <main class="container">

    <!-- Heading + Admin tools -->
    <div class="top-row">
      <h1 style="margin:0;font-size:24px;font-weight:800">Members</h1>
      <div class="muted" id="meNote"></div>
    </div>

    <!-- Admin-only invite display -->
    <section id="adminPanel" class="card admin-panel" aria-live="polite">
      <h3 style="margin:0 0 10px 0">Admin Tools</h3>
      <div class="invite">
        <div class="muted">Club Invite Code (display-only):</div>
        <div id="inviteCode" class="code">F64-CHRIS-2025-9QK7ATJ3</div>
        <button id="copyInvite" class="btn">Copy</button>
      </div>
      <div id="adminMsg" class="hint"></div>
    </section>

    <!-- Members list -->
    <section class="card">
      <div class="top-row" style="margin-top:0">
        <div class="muted">Tap buttons below each card to manage status (admins only).</div>
      </div>
      <div id="membersGrid" class="grid"></div>
      <div id="listMsg" class="hint"></div>
    </section>

  </main>

  <!-- LOCAL AUTH MODAL -->
  <div id="authModal" class="auth-modal" aria-hidden="true">
    <div class="auth-card" role="dialog" aria-modal="true" aria-labelledby="authTitle">
      <button id="closeModal" class="auth-x" aria-label="Close">✕</button>
      <h3 id="authTitle" class="auth-title">Member Sign In</h3>

      <!-- First/Last name only used for sign-up -->
      <label class="auth-label" for="firstName">First name (sign up)</label>
      <input id="firstName" class="auth-input" type="text" placeholder="First name">

      <label class="auth-label" for="lastName">Last name (sign up)</label>
      <input id="lastName" class="auth-input" type="text" placeholder="Last name">

      <label class="auth-label" for="email">Email</label>
      <input id="email" class="auth-input" type="email" placeholder="you@example.com" autocomplete="email">

      <label class="auth-label" for="password">Password</label>
      <input id="password" class="auth-input" type="password" placeholder="••••••••" autocomplete="current-password">

      <div class="auth-row">
        <button id="doReset" class="auth-btn" type="button">Forgot password?</button>
        <button id="doSignUp" class="auth-btn" type="button">Create Account</button>
        <button id="doSignIn" class="auth-btn primary" type="button">Sign In</button>
        <div class="invite-wrap">
      <label class="auth-label" for="invite">Invite Code (new accounts)</label>
      <input id="invite" class="auth-input" type="text" placeholder="Board Admin Will Provide Invite Code" required>
    </div>
      </div>

      <div class="auth-row">
        <button id="signOutBtn" class="auth-link" type="button">Sign out</button>
      </div>

      <p id="authMsg" class="auth-msg"></p>
    </div>
  </div>

  <script type="module">
    import { auth, db, onAuthChanged, signOut } from './auth.js';
    import {
      doc, getDoc, setDoc, updateDoc, serverTimestamp,
      collection, query, orderBy, onSnapshot
    } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";
    import {
      signInWithEmailAndPassword, createUserWithEmailAndPassword,
      sendPasswordResetEmail, sendEmailVerification
    } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";

    // UI refs
    const signinBtn   = document.getElementById('signinBtn');
    const meNote      = document.getElementById('meNote');
    const grid        = document.getElementById('membersGrid');
    const listMsg     = document.getElementById('listMsg');
    const adminPanel  = document.getElementById('adminPanel');
    const copyInvite  = document.getElementById('copyInvite');
    const adminMsg    = document.getElementById('adminMsg');

    // Auth modal refs
    const modal     = document.getElementById('authModal');
    const closeBtn  = document.getElementById('closeModal');
    const firstEl   = document.getElementById('firstName');
    const lastEl    = document.getElementById('lastName');
    const emailEl   = document.getElementById('email');
    const passEl    = document.getElementById('password');
    const doSignIn  = document.getElementById('doSignIn');
    const doSignUp  = document.getElementById('doSignUp');
    const doReset   = document.getElementById('doReset');
    const signOutBtn= document.getElementById('signOutBtn');
    const authMsg   = document.getElementById('authMsg');

    // Helpers
    const sayList = (t,isErr=false)=>{ listMsg.textContent=t||""; listMsg.style.color=isErr?'#ffb4b4':'#9fb1c3'; };
    const sayAdmin= (t,isErr=false)=>{ adminMsg.textContent=t||""; adminMsg.style.color=isErr?'#ffb4b4':'#9fb1c3'; };
    const sayAuth = (t,isErr=false)=>{ authMsg.textContent=t||""; authMsg.style.color=isErr?'#ffb4b4':'#9fb1c3'; };
    const escapeHtml = (s)=> (s||"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;");

    let currentUser = null;
    let iAmAdmin = false;

    /* ===== Auth modal open/close (local) ===== */
    function openAuth(){ modal.classList.add('open'); modal.setAttribute('aria-hidden','false'); sayAuth(''); }
    function closeAuth(){ modal.classList.remove('open'); modal.setAttribute('aria-hidden','true'); }
    signinBtn.addEventListener('click', openAuth);
    closeBtn.addEventListener('click', closeAuth);
    modal.addEventListener('click', e=>{ if(e.target===modal) closeAuth(); });
    // deep link support: members.html#signin
    if (location.hash === '#signin') openAuth();
    window.addEventListener('hashchange', ()=>{ if(location.hash==='#signin') openAuth(); });

    /* ===== Auth actions ===== */
    doSignIn.addEventListener('click', async ()=>{
      const email=(emailEl.value||'').trim(); const pass=passEl.value;
      if(!email||!pass) return sayAuth('Enter email and password.', true);
      try{ await signInWithEmailAndPassword(auth,email,pass); sayAuth('Signed in.'); closeAuth(); }
      catch(e){ sayAuth(e.message,true); }
    });

    doSignUp.addEventListener('click', async ()=>{
      const email=(emailEl.value||'').trim(); const pass=passEl.value;
      const first=(firstEl.value||'').trim(); const last=(lastEl.value||'').trim();
      if(!first||!last||!email||!pass) return sayAuth('First, last, email, password are required.', true);
      try{
        const cred = await createUserWithEmailAndPassword(auth,email,pass);
        await sendEmailVerification(cred.user);

        const base = {
          uid: cred.user.uid,
          email, firstName:first, lastName:last,
          role:'user', active:true,
          emailVerified:false,
          createdAt: serverTimestamp(),
          updatedAt: serverTimestamp()
        };
        await Promise.all([
          setDoc(doc(db,'profiles', cred.user.uid), base, {merge:true}),
          setDoc(doc(db,'members',  cred.user.uid), base, {merge:true})
        ]);

        sayAuth('Account created! Check your email to verify.');
      }catch(e){ sayAuth(e.message,true); }
    });

    doReset.addEventListener('click', async ()=>{
      const email=(emailEl.value||'').trim();
      if(!email) return sayAuth('Enter your email first.', true);
      try{ await sendPasswordResetEmail(auth,email); sayAuth('Password reset email sent.'); }
      catch(e){ sayAuth(e.message,true); }
    });

    signOutBtn.addEventListener('click', async ()=>{ await signOut(auth); sayAuth('Signed out.'); });

    /* ===== Role and admin panel ===== */
    async function loadMyRole(){
      iAmAdmin = false;
      if (!currentUser) return;
      try{
        const p = await getDoc(doc(db,'profiles', currentUser.uid));
        const role = (p.exists() ? (p.data().role||'') : '').toLowerCase();
        if (role === 'admin' || role === 'superadmin') iAmAdmin = true;
      }catch(e){ /* ignore */ }
      adminPanel.style.display = iAmAdmin ? 'block' : 'none';
    }

    /* ===== Render members ===== */
    function renderMembers(docs){
      grid.innerHTML = '';
      if (!docs.length){ sayList('No members found.'); return; }
      sayList('');

      docs.forEach(snap=>{
        const d = snap.data();
        const uid   = snap.id;
        const first = d.firstName || '';
        const last  = d.lastName || '';
        const name  = (first || last) ? `${first} ${last}`.trim() : (d.displayName || 'Member');
        const email = d.email || '';
        const active = d.active !== false;
        const role = (d.role||'user').toLowerCase();

        const card = document.createElement('div');
        card.className = 'member';
        card.innerHTML = `
          <div class="m-top">
            <div>
              <div class="m-name">${escapeHtml(name)}</div>
              <div class="m-email">${escapeHtml(email)}</div>
            </div>
            <div class="chips">
              <span class="chip ${active?'ok':''}">${active?'Active':'Inactive'}</span>
            </div>
          </div>

          ${ iAmAdmin ? `
          <div class="actions">
            <button class="btn ${role==='admin' || role==='superadmin' ? 'ghost' : 'ok'}"
                    data-act="toggle-admin" data-uid="${uid}" data-current="${role}">
              ${ role==='admin' || role==='superadmin' ? 'Remove Admin' : 'Make Admin' }
            </button>
            <button class="btn ${active?'warn':'ok'}"
                    data-act="toggle-active" data-uid="${uid}" data-current="${active?'active':'inactive'}">
              ${ active ? 'Deactivate' : 'Activate' }
            </button>
          </div>` : ``}
        `;
        grid.appendChild(card);
      });

      // wire admin buttons
      if (iAmAdmin){
        grid.querySelectorAll('[data-act="toggle-admin"]').forEach(btn=>{
          btn.addEventListener('click', async ()=>{
            const uid = btn.getAttribute('data-uid');
            const cur = (btn.getAttribute('data-current')||'user').toLowerCase();
            const toAdmin = !(cur==='admin' || cur==='superadmin');
            try{
              await Promise.all([
                updateDoc(doc(db,'profiles',uid), { role: toAdmin ? 'admin' : 'user', updatedAt: serverTimestamp() }),
                updateDoc(doc(db,'members' ,uid), { role: toAdmin ? 'admin' : 'user', updatedAt: serverTimestamp() })
              ]);
              sayList(toAdmin?'Made admin.':'Removed admin.');
            }catch(e){ sayList(e.message,true); }
          });
        });

        grid.querySelectorAll('[data-act="toggle-active"]').forEach(btn=>{
          btn.addEventListener('click', async ()=>{
            const uid = btn.getAttribute('data-uid');
            const curIsActive = (btn.getAttribute('data-current')||'active').toLowerCase()==='active';
            const newVal = !curIsActive;
            try{
              await Promise.all([
                updateDoc(doc(db,'profiles',uid), { active: newVal, updatedAt: serverTimestamp() }),
                updateDoc(doc(db,'members' ,uid), { active: newVal, updatedAt: serverTimestamp() })
              ]);
              sayList(newVal?'Activated.':'Deactivated.');
            }catch(e){ sayList(e.message,true); }
          });
        });
      }
    }

    /* ===== Live list (show everyone) ===== */
    function startLiveList(){
      const qy = query(collection(db,'profiles'), orderBy('firstName'), orderBy('lastName'));
      onSnapshot(qy, (snap)=>{
        const docs=[]; snap.forEach(d=>docs.push(d));
        renderMembers(docs);
      }, (err)=> sayList(err.message,true));
    }

    /* ===== Copy invite code ===== */
    copyInvite.addEventListener('click', async ()=>{
      try{
        const code = document.getElementById('inviteCode').textContent.trim();
        await navigator.clipboard.writeText(code);
        sayAdmin('Invite code copied.');
      }catch(e){ sayAdmin('Could not copy.', true); }
    });

    /* ===== Auth state ===== */
    onAuthChanged(async (user)=>{
      currentUser = user || null;

      if (currentUser){
        const shortEmail = currentUser.email && currentUser.email.length>25
          ? currentUser.email.slice(0,25)+'…' : (currentUser.email||'');
        document.getElementById('signinBtn').textContent = `Account – ${shortEmail}`;
        meNote.textContent = currentUser.emailVerified ? 'Signed in (verified).' : 'Signed in (verify your email).';

        await loadMyRole();
        startLiveList();
      }else{
        document.getElementById('signinBtn').textContent = 'Sign In';
        meNote.textContent = 'Sign in to view member details.';
        adminPanel.style.display = 'none';
        grid.innerHTML = '';
        sayList('Please sign in to view members.');
      }
    });
  </script>
</body>
</html>
