<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>The Flying 64th â€“ Home</title>
  <meta name="description" content="The Flying 64th Flying Club â€“ affordable general aviation in East Tennessee based at Oliver Springs Airport (Braden Field). Operates Cessna 172 & 150." />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#0b1117; --ink:#e6edf3; --muted:#9fb1c3; --panel:#0f1722; --rule:#1f2a38; --accent:#58a6ff;
      --card:#0f1722cc;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius:16px;
    }
    *{box-sizing:border-box}
    html,body{margin:0;height:100%}
    body{font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--ink);line-height:1.6}

    /* ===== NAV ===== */
    .site-header{
      position:sticky; top:0; z-index:50;
      backdrop-filter:saturate(160%) blur(8px);
      background:rgba(11,17,23,.75);
      border-bottom:1px solid var(--rule);
    }
    .nav{
      max-width:1200px; margin:0 auto; padding:12px 18px;
      display:flex; align-items:center; justify-content:space-between; gap:12px;
    }
    .brand{
      display:flex; align-items:center; gap:10px; font-weight:800; letter-spacing:.2px;
      color:var(--ink); text-decoration:none; font-size:22px; white-space:nowrap;
    }
    .brand img{ height:34px; width:auto }
    header nav{
      display:flex; align-items:center; gap:18px; flex-wrap:nowrap;
    }
    header nav a{
      color:var(--muted); text-decoration:none; padding:8px 12px; border-radius:10px;
      transition:all .18s ease;
    }
    header nav a:hover{ color:var(--ink); background:rgba(255,255,255,.06) }
    header nav a.active{ color:#001a33; background:var(--accent); font-weight:700 }
    .btn{
      border:1px solid var(--rule);
      background:#111827;
      color:#e6edf3;
      padding:8px 12px;
      border-radius:10px;
      cursor:pointer;
      font-weight:600;
    }
    .btn.primary{
      background:#58a6ff;
      border-color:#58a6ff;
      color:#001a33;
    }
    @media (max-width:900px){
      .nav{ padding:10px 14px; flex-wrap:wrap }
      header nav{ width:100%; gap:10px; overflow-x:auto; -webkit-overflow-scrolling:touch; scrollbar-width:none }
      header nav::-webkit-scrollbar{ display:none }
      header nav a{ padding:8px 10px; font-size:15px }
    }

    /* ===== HERO ===== */
    .hero{
      position:relative;min-height:56vh;display:grid;place-items:end;
      isolation:isolate;
      background:#000 url("images/bothplanes_homepage.jpg") center/cover no-repeat;
    }
    .hero::after{
      content:"";position:absolute;inset:0;z-index:0;
      background:linear-gradient(180deg, rgba(11,17,23,.15) 0%, rgba(11,17,23,.65) 55%, rgba(11,17,23,1) 100%);
    }
    .hero-inner{
      position:relative;z-index:1;max-width:1100px;margin:0 auto;padding:48px 18px 24px;
      width:100%;
    }
    .hero h1{margin:0 0 8px;font-size:clamp(28px,4vw,44px);font-weight:800}
    .hero p{margin:0;color:#d0d9e3;max-width:900px}

    /* ===== CONTENT ===== */
    .container{max-width:1100px;margin:0 auto;padding:28px 18px}
    .grid{display:grid;gap:16px}
    .grid.cols-3{grid-template-columns:1fr 1fr 1fr}
    @media (max-width:1100px){ .grid.cols-3{grid-template-columns:1fr 1fr} }
    @media (max-width:760px){ .grid.cols-3{grid-template-columns:1fr} }

    .card{
      background:var(--card);
      border:1px solid var(--rule);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:18px 18px;
    }
    .card h2{margin:0 0 8px;font-size:1.25rem}
    .muted{color:var(--muted)}
    .list{padding-left:18px;margin:8px 0}
    .list li{margin:6px 0}
    .iconbtn{background:none;border:1px solid var(--rule);color:var(--ink);padding:6px 10px;border-radius:8px;cursor:pointer}
    .iconbtn:hover{background:rgba(255,255,255,.06)}

    /* ===== MESSAGE BOARD SCROLL AREA ===== */
    #messages{
      display:grid; gap:12px;
      max-height:48vh;
      overflow:auto;
      padding-right:4px;
    }
    @media (max-width:760px){
      #messages{ max-height:40vh; }
    }
    .msg{border:1px solid var(--rule);border-radius:12px;padding:10px 12px;background:#0e1520}
    .msg-top{display:flex;justify-content:space-between;gap:10px}
    .msg-meta{font-size:12px;color:#9fb1c3}

    /* ===== AUTH MODAL (new tabbed version) ===== */
    .auth-modal{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.5);
      display:none;
      place-items:center;
      z-index:1000;
    }
    .auth-modal.open{ display:grid; }
    .auth-card{
      width:min(480px,92vw);
      background:#0f1722;
      color:#e6edf3;
      border:1px solid #1f2a38;
      border-radius:14px;
      padding:18px 18px 12px;
      position:relative;
    }
    .auth-title{
      margin:0 0 12px 0;
      font-size:20px;
      font-weight:800;
    }
    .auth-x{
      position:absolute;
      right:14px;
      top:12px;
      border:0;
      background:transparent;
      color:#9fb1c3;
      font-size:18px;
      cursor:pointer;
    }
    .auth-label{
      display:block;
      margin-top:10px;
      margin-bottom:4px;
      color:#9fb1c3;
      font-size:13px;
    }
    .auth-input{
      width:100%;
      padding:10px 12px;
      border-radius:10px;
      border:1px solid #1f2a38;
      background:#0b1117;
      color:#e6edf3;
    }
    .auth-row{
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      margin-top:12px;
    }
    .auth-btn{
      flex:1;
      padding:10px 12px;
      border-radius:10px;
      border:1px solid #1f2a38;
      background:#141b26;
      color:#e6edf3;
      cursor:pointer;
    }
    .auth-btn.primary{
      background:#58a6ff;
      color:#001a33;
      border-color:transparent;
      font-weight:700;
    }
    .auth-link{
      background:none;
      border:0;
      color:#9fb1c3;
      cursor:pointer;
    }
    .auth-msg{
      min-height:18px;
      color:#9fb1c3;
      margin:8px 0 4px;
    }
    .tabs{
      display:flex;
      gap:8px;
      margin-bottom:8px;
    }
    .tab{
      flex:1;
      padding:8px 10px;
      border:1px solid #1f2a38;
      border-radius:10px;
      background:#141b26;
      color:#e6edf3;
      cursor:pointer;
    }
    .tab.active{
      background:#58a6ff;
      color:#001a33;
      font-weight:700;
      border-color:transparent;
    }
    .view{ display:none; }
    .view.active{ display:block; }

    /* ===== NEW POST MODAL ===== */
    .post-modal{
      position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;place-items:center;z-index:1000
    }
    .post-modal.open{display:grid}
    .post-card{
      width:min(460px,92vw);background:#0f1722;color:#e6edf3;
      border:1px solid #1f2a38;border-radius:14px;padding:18px 18px 12px;position:relative
    }
    .post-title{margin:0 0 10px 0;font-size:20px;font-weight:800}
    .post-x{position:absolute;right:14px;top:12px;border:0;background:transparent;color:#9fb1c3;font-size:18px;cursor:pointer}
    .post-label{display:block;margin-top:10px;margin-bottom:4px;color:#9fb1c3;font-size:13px}
    .post-input,
    .post-text{width:100%;padding:10px 12px;border-radius:10px;border:1px solid #1f2a38;background:#0b1117;color:#e6edf3}
    .post-row{display:flex;gap:10px;align-items:center;justify-content:space-between;margin-top:12px}
    .post-btn{flex:1;padding:10px 12px;border-radius:10px;border:1px solid #1f2a38;background:#141b26;color:#e6edf3;cursor:pointer}
    .post-btn.primary{background:#58a6ff;color:#001a33;border-color:transparent;font-weight:700}

    /* ===== FOOTER ===== */
    .site-footer{
      border-top:1px solid var(--rule);
      padding:12px 18px 20px;
      color:var(--muted);
      font-size:14px;
    }
    .foot{
      max-width:1100px;
      margin:0 auto;
    }
  </style>
</head>
<body>

<!-- ===== NAV ===== -->
<header class="site-header">
  <div class="nav">
    <a class="brand" href="home.html">
      <img src="images/flying64thlogo.png" alt="The Flying 64th Logo" style="width:80px;height:auto;">
      <span>The Flying 64th</span>
    </a>
    <nav>
      <a id="signinBtn" class="btn" style="margin-left:8px;">Sign In</a>
      <a class="active" href="home.html">Home</a>
      <a href="calendar.html">Calendar</a>
      <a href="becomeamember.html">Become a Member</a>
      <a href="photos.html">Photos</a>
      <a href="members.html">Members</a>
      <a href="poh&manuals.html">POH &amp; Manuals</a>
    </nav>
  </div>
</header>

<!-- ===== HERO ===== -->
<section class="hero">
  <div class="hero-inner">
    <h1>Affordable General Aviation in East Tennessee</h1>
    <p>The Flying 64th is a member-owned flying club based at Oliver Springs Airport (Braden Field). We operate a Cessna 172K and a Cessna 150L, both ADS-B equipped and maintained to FAA standards.</p>
  </div>
</section>

<!-- ===== CONTENT ===== -->
<main class="container">
  <div class="grid cols-3">
    <article class="card">
      <h2>About the Club</h2>
      <p class="muted">The Flying 64th is a general aviation flying club offering the most affordable flying in East Tennessee. Convenient to Oak Ridge, West Knoxville, Lenoir City, Harriman, and Oliver Springs, members buy into the club rather than simply renting from a pool. Every member is an owner in each aircraft.</p>
      <p class="muted">The club has a <strong>Cessna 172K</strong> and a <strong>Cessna 150L</strong>. Both planes are equipped with ADSB-IN/OUT. The 172 is equipped with Garmin 355 GPS Navigation.</p>
      <p class="muted">The Flying 64th has been operating out of Oliver Springs Airport as a club for pilots of all ages and skill levels since its formation in 1954 by the merger of two smaller clubs which trace their roots to 1946. The name originated from the association of charter members with the 9964th local Air Force Reserve Squadron.</p>
    </article>

    <aside class="card">
      <h2>Why Join?</h2>
      <ul class="list">
        <li>Shared ownership keeps costs low</li>
        <li>Two well-equipped aircraft (2-seat &amp; 4-seat)</li>
        <li>Supportive pilot community &amp; mentorship</li>
        <li>Great for training and time-building</li>
      </ul>
    </aside>

    <!-- ===== MEMBER MESSAGE BOARD ===== -->
    <section class="card" id="board">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;">
        <h2 style="margin:0;">Member Message Board</h2>
        <button id="newPostBtn" class="btn primary" style="display:none;">Post</button>
      </div>
      <p id="msgHint" class="muted" style="margin-top:8px;">
        Board notices and member updates appear here. All members can read; only admins can post.
      </p>

      <!-- Scrollable feed -->
      <div id="messages"></div>
    </section>
  </div>
</main>

<!-- ===== FOOTER ===== -->
<footer class="site-footer">
  <div class="foot">
    Â© <span id="y"></span> The Flying 64th â€¢ Oliver Springs, Tennessee
  </div>
</footer>

<!-- ===== AUTH MODAL (tabbed) ===== -->
<div id="authModal" class="auth-modal" aria-hidden="true">
  <div class="auth-card" role="dialog" aria-modal="true" aria-labelledby="authTitle">
    <button id="closeAuth" class="auth-x" aria-label="Close">âœ•</button>

    <div class="tabs">
      <button id="tabSignIn" class="tab active">Sign In</button>
      <button id="tabSignUp" class="tab">Create Account</button>
    </div>

    <!-- Sign In view -->
    <section id="viewSignIn" class="view active" aria-labelledby="authTitle">
      <h3 id="authTitle" class="auth-title">Member Sign In</h3>
      <label class="auth-label" for="si_email">Email</label>
      <input id="si_email" class="auth-input" type="email" placeholder="you@example.com" autocomplete="email">
      <label class="auth-label" for="si_password">Password</label>
      <input id="si_password" class="auth-input" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" autocomplete="current-password">

      <div class="auth-row">
        <button id="doSignIn" class="auth-btn primary">Sign In</button>
      </div>
      <div class="auth-row">
        <button id="doReset" class="auth-link" type="button">Forgot password?</button>
        <button id="signOutBtn" class="auth-link" type="button">Sign out</button>
      </div>
      <p id="authMsg" class="auth-msg"></p>
    </section>

    <!-- Create Account view -->
    <section id="viewSignUp" class="view" aria-labelledby="createTitle">
      <h3 id="createTitle" class="auth-title">Create a New Account</h3>
      <label class="auth-label" for="su_first">First Name</label>
      <input id="su_first" class="auth-input" type="text" placeholder="Your first name" required>
      <label class="auth-label" for="su_last">Last Name</label>
      <input id="su_last" class="auth-input" type="text" placeholder="Your last name" required>
      <label class="auth-label" for="su_email">Email</label>
      <input id="su_email" class="auth-input" type="email" placeholder="you@example.com" autocomplete="email" required>
      <label class="auth-label" for="su_password">Password</label>
      <input id="su_password" class="auth-input" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" autocomplete="new-password" required>
      <label class="auth-label" for="su_invite">Invite Code</label>
      <input id="su_invite" class="auth-input" type="text" placeholder="Board Admin Will Provide Invite Code" required>

      <div class="auth-row">
        <button id="doSignUp" class="auth-btn primary">Create Account</button>
      </div>
      <p id="createMsg" class="auth-msg"></p>
    </section>
  </div>
</div>

<!-- ===== NEW POST MODAL ===== -->
<div id="postModal" class="post-modal" aria-hidden="true">
  <div class="post-card" role="dialog" aria-modal="true" aria-labelledby="postTitle">
    <button id="closePost" class="post-x" aria-label="Close">âœ•</button>
    <h3 id="postTitle" class="post-title">New Message</h3>

    <label class="post-label" for="postName">Display Name</label>
    <input id="postName" class="post-input" type="text" placeholder="e.g., Chris B.">

    <label class="post-label" for="postEmail">Email (from your account)</label>
    <input id="postEmail" class="post-input" type="email" readonly>

    <label class="post-label" for="postWhen">Post Date &amp; Time</label>
    <input id="postWhen" class="post-input" type="datetime-local">

    <label class="post-label" for="postText">Message</label>
    <textarea id="postText" class="post-text" rows="5" placeholder="Write your update for membersâ€¦"></textarea>

    <div class="post-row">
      <button id="postCancel" class="post-btn">Cancel</button>
      <button id="postSubmitOnly" class="post-btn">Submit Only</button>
      <button id="postSubmitNotify" class="post-btn primary">Submit &amp; Notify</button>
    </div>
    <p id="postMsg" class="auth-msg"></p>
  </div>
</div>

<script>
  document.getElementById("y").textContent = new Date().getFullYear();
</script>

<!-- ===== Firebase + Auth + Board Logic ===== -->
<script type="module">
  import {
    auth,
    db,
    onAuthChanged,
    signInEmailPassword,
    signUpWithInvite,
    resetPassword,
    signOut
  } from './auth.js';

  import {
    doc, getDoc, serverTimestamp,
    collection, query, orderBy, onSnapshot,
    addDoc, deleteDoc, getDocs, where, Timestamp
  } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";

  // ===== Admin allow-list (fallback while profiles populate) =====
  const BOARD_EMAILS = ["theflying64@gmail.com"];
  const FALLBACK_EMAILS = [];

  let currentUser = null;
  let isAdmin = false;

  // ===== Auth UI refs =====
  const signinBtn  = document.getElementById('signinBtn');

  const authModal  = document.getElementById('authModal');
  const closeAuth  = document.getElementById('closeAuth');
  const tabSignIn  = document.getElementById('tabSignIn');
  const tabSignUp  = document.getElementById('tabSignUp');
  const viewSignIn = document.getElementById('viewSignIn');
  const viewSignUp = document.getElementById('viewSignUp');

  const si_email    = document.getElementById('si_email');
  const si_password = document.getElementById('si_password');
  const doSignInBtn = document.getElementById('doSignIn');
  const doResetBtn  = document.getElementById('doReset');
  const signOutBtn  = document.getElementById('signOutBtn');
  const authMsg     = document.getElementById('authMsg');

  const su_first    = document.getElementById('su_first');
  const su_last     = document.getElementById('su_last');
  const su_email    = document.getElementById('su_email');
  const su_password = document.getElementById('su_password');
  const su_invite   = document.getElementById('su_invite');
  const doSignUpBtn = document.getElementById('doSignUp');
  const createMsg   = document.getElementById('createMsg');

  // ===== Board UI refs =====
  const hintEl     = document.getElementById('msgHint');
  const feedEl     = document.getElementById('messages');
  const newPostBtn = document.getElementById('newPostBtn');
  const notifyBtn  = document.getElementById('notifyBtn'); // may be null

  // New Post modal refs
  const postModal        = document.getElementById('postModal');
  const closePost        = document.getElementById('closePost');
  const postCancel       = document.getElementById('postCancel');
  const postSubmitOnly   = document.getElementById('postSubmitOnly');
  const postSubmitNotify = document.getElementById('postSubmitNotify');
  const postNameEl       = document.getElementById('postName');
  const postEmailEl      = document.getElementById('postEmail');
  const postWhenEl       = document.getElementById('postWhen');
  const postTextEl       = document.getElementById('postText');
  const postMsgEl        = document.getElementById('postMsg');

  // Helpers
  const say  = (t, err=false)=>{ authMsg.textContent=t||""; authMsg.style.color=err?'#ffb4b4':'#9fb1c3'; };
  const csay = (t, err=false)=>{ createMsg.textContent=t||""; createMsg.style.color=err?'#ffb4b4':'#9fb1c3'; };
  const psay = (t, err=false)=>{ postMsgEl.textContent=t||""; postMsgEl.style.color=err?'#ffb4b4':'#9fb1c3'; };
  const escapeHtml = (s)=> (s||"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;");
  function toLocalDatetimeValue(d=new Date()){
    const pad = (n)=> String(n).padStart(2,'0');
    return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
  }

  // ===== Auth modal open/close & tabs =====
  function openAuth(){
    authModal.classList.add('open');
    authModal.setAttribute('aria-hidden','false');
    say(""); csay("");
  }
  function closeAuthModal(){
    authModal.classList.remove('open');
    authModal.setAttribute('aria-hidden','true');
  }

  signinBtn?.addEventListener('click', openAuth);
  closeAuth?.addEventListener('click', closeAuthModal);
  authModal?.addEventListener('click', (e)=>{ if(e.target === authModal) closeAuthModal(); });

  function activate(view){
    [tabSignIn, tabSignUp].forEach(t=>t.classList.remove('active'));
    [viewSignIn, viewSignUp].forEach(v=>v.classList.remove('active'));
    if (view === 'in'){
      tabSignIn.classList.add('active');
      viewSignIn.classList.add('active');
    } else {
      tabSignUp.classList.add('active');
      viewSignUp.classList.add('active');
    }
  }
  tabSignIn.addEventListener('click', ()=>activate('in'));
  tabSignUp.addEventListener('click', ()=>activate('up'));

  // Allow opening via #signin
  if (location.hash === '#signin') openAuth();
  window.addEventListener('hashchange', ()=>{ if (location.hash === '#signin') openAuth(); });

  // ===== Role loader =====
  async function reloadRole(){
    isAdmin = false;
    if (!currentUser) return;
    // Fallback allow-list
    if (currentUser.email && BOARD_EMAILS.includes(currentUser.email)) {
      isAdmin = true;
      return;
    }
    try{
      const pref = doc(db, "profiles", currentUser.uid);
      const snap = await getDoc(pref);
      const role = snap.exists() ? (snap.data().role || "").toLowerCase() : "";
      if (role === "admin" || role === "superadmin") isAdmin = true;
    }catch(e){
      console.warn("Role lookup failed", e);
    }
  }

  // ===== Auth state handling (also controls who can post) =====
  onAuthChanged(async (user)=>{
    currentUser = user || null;
    const verified = !!user?.emailVerified;

    if (user){
      const shortEmail = user.email && user.email.length>25
        ? user.email.slice(0,25)+'â€¦'
        : (user.email || '');
      signinBtn.textContent = verified
        ? `Account â€“ ${shortEmail}`
        : `Unverified â€“ ${shortEmail}`;

      await reloadRole();

      // Only admins can post, even if verified
      if (isAdmin && verified){
        newPostBtn.style.display = "inline-block";
        hintEl.textContent = "Admins can post updates here. All members can read.";
      } else {
        newPostBtn.style.display = "none";
        hintEl.textContent = "Board notices and member updates appear here. Only admins can post.";
      }
    } else {
      signinBtn.textContent = "Sign In";
      newPostBtn.style.display = "none";
      hintEl.textContent = "Board notices and member updates appear here. Only admins can post.";
    }
  });

  /* ---------- Sign in / up / reset / out ---------- */
  doSignInBtn.addEventListener('click', async ()=>{
    const email = si_email.value.trim();
    const pass  = si_password.value;
    if (!email || !pass) return say("Enter email and password.", true);
    try{
      await signInEmailPassword(email, pass);
      say("Signed in.");
      closeAuthModal();
    }catch(err){ say(err.message || String(err), true); }
  });

  doSignUpBtn.addEventListener('click', async ()=>{
    const first = su_first.value.trim();
    const last  = su_last.value.trim();
    const email = su_email.value.trim();
    const pass  = su_password.value;
    const code  = su_invite.value.trim();
    if (!first || !last || !email || !pass || !code) return csay("All fields are required.", true);
    try{
      await signUpWithInvite({ email, password:pass, firstName:first, lastName:last, code });
      csay("Account created! Check your inbox to verify your email.");
      activate('in');
    }catch(err){ csay(err.message || String(err), true); }
  });

  doResetBtn.addEventListener('click', async ()=>{
    const email = si_email.value.trim();
    if (!email) return say("Enter your email first.", true);
    try{
      await resetPassword(email);
      say("Password reset email sent.");
    }catch(err){ say(err.message || String(err), true); }
  });

  signOutBtn.addEventListener('click', async ()=>{
    try{
      await signOut();
      say("Signed out.");
    }catch(err){ say(err.message || String(err), true); }
  });

  // Enter key behavior
  function handleEnter(e){
    if (e.key !== 'Enter') return;
    if (viewSignIn.classList.contains('active')) doSignInBtn.click();
    else doSignUpBtn.click();
  }
  [si_email, si_password, su_first, su_last, su_email, su_password, su_invite]
    .forEach(el => el.addEventListener('keydown', handleEnter));

  // ===== New Post modal open/close =====
  function openPost(){
    if (!currentUser){ openAuth(); return; }
    if (!isAdmin){
      alert("Only admins can post messages.");
      return;
    }
    if (!currentUser.emailVerified){
      alert("Verify your email first.");
      return;
    }
    postEmailEl.value = currentUser.email || "";
    postNameEl.value  = (currentUser.email || "").split("@")[0];
    postTextEl.value  = "";
    postWhenEl.value  = toLocalDatetimeValue(new Date());
    psay("");
    postModal.classList.add('open');
    postModal.setAttribute('aria-hidden','false');
    postNameEl.focus();
  }
  function closePostModal(){
    postModal.classList.remove('open');
    postModal.setAttribute('aria-hidden','true');
  }
  newPostBtn?.addEventListener('click', openPost);
  closePost?.addEventListener('click', closePostModal);
  postCancel?.addEventListener('click', closePostModal);
  postModal?.addEventListener('click', e => { if (e.target === postModal) closePostModal(); });

  // ===== Active emails (for notify) =====
  async function getActiveEmails(){
    if (isAdmin){
      try{
        const emails = [];
        const qProfiles = query(collection(db,"profiles"), where("active","==", true));
        const snap = await getDocs(qProfiles);
        snap.forEach(docu=>{
          const d = docu.data();
          const e = (d.email || "").trim();
          if (e) emails.push(e);
        });
        if (emails.length) return emails;
      }catch{/* ignore, fall back */}
    }
    return FALLBACK_EMAILS;
  }

  function openMailto(allBcc, subject, body){
    const mailto = `mailto:?bcc=${encodeURIComponent(allBcc.join(','))}&subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
    window.location.href = mailto;
  }

  // ===== Create post =====
  async function createPost(){
    if (!currentUser){ psay("Please sign in.", true); return null; }
    if (!isAdmin){ psay("Only admins can post new messages.", true); return null; }
    if (!currentUser.emailVerified){ psay("Verify your email first.", true); return null; }

    const displayName = (postNameEl.value || "").trim();
    const text        = (postTextEl.value || "").trim();
    if (!displayName){ psay("Display name is required.", true); return null; }
    if (!text)       { psay("Message cannot be empty.", true); return null; }

    let whenTs = Timestamp.fromDate(new Date());
    const raw = (postWhenEl.value || "").trim();
    if (raw){
      const dt = new Date(raw);
      if (!isNaN(dt.getTime())) whenTs = Timestamp.fromDate(dt);
    }

    const ref = await addDoc(collection(db,"board"), {
      text,
      authorEmail: currentUser.email || "",
      authorName: displayName,
      authorUid: currentUser.uid,
      createdAt: whenTs,
      updatedAt: serverTimestamp()
    });
    return { id: ref.id, text, displayName, when: whenTs.toDate() };
  }

  // ===== Submit handlers =====
  if (postSubmitOnly){
    postSubmitOnly.addEventListener('click', async ()=>{
      try{
        const created = await createPost();
        if (created){ closePostModal(); }
      }catch(err){ psay(err.message || String(err), true); }
    });
  }

  postSubmitNotify?.addEventListener('click', async ()=>{
    try{
      if (!isAdmin){ psay("Only admins can notify all members.", true); return; }
      const created = await createPost();
      if (!created) return;

      const all = await getActiveEmails();
      if (!all.length){
        closePostModal();
        alert("Post created, but no member emails found to notify.");
        return;
      }

      const whenStr = created.when.toLocaleString();
      const subject = "New Message on The Flying 64th Website";
      const body =
`From: ${created.displayName}
When: ${whenStr}

${created.text}

â€” This message was posted on the Member Message Board (The Flying 64th).`;

      openMailto(all, subject, body);
      closePostModal();
    }catch(err){ psay(err.message || String(err), true); }
  });

  notifyBtn && notifyBtn.addEventListener('click', ()=>{
    if (!currentUser){ openAuth(); return; }
    if (!currentUser.emailVerified){ alert("Verify your email first."); return; }
    if (!isAdmin){ alert("Only admins can notify all members."); return; }
    openPost();
  });

  // ===== Live feed (all members can read) =====
  const qBoard = query(collection(db,"board"), orderBy("createdAt","desc"));
  onSnapshot(qBoard, (snap)=>{
    const verified = !!currentUser?.emailVerified;
    feedEl.innerHTML = "";
    snap.forEach(d=>{
      const m = d.data();
      const ts = m.createdAt?.toDate ? m.createdAt.toDate() : null;
      const when = ts ? ts.toLocaleString() : "â€¦";
      const canDelete = verified && (isAdmin || currentUser?.uid === m.authorUid);

      const div = document.createElement("div");
      div.className = "msg";
      div.innerHTML = `
        <div class="msg-top">
          <div class="msg-meta">
            <strong>${escapeHtml(m.authorName || "Member")}</strong>
            <span> â€¢ ${when}</span>
            <div style="color:#9fb1c3;font-size:12px">${escapeHtml(m.authorEmail || "")}</div>
          </div>
          ${ canDelete ? `<button class="iconbtn" data-del="${d.id}">ðŸ—‘ Delete</button>` : "" }
        </div>
        <div style="margin-top:6px;">${escapeHtml(m.text || "")}</div>
      `;
      feedEl.appendChild(div);
    });

    // Wire delete buttons
    [...feedEl.querySelectorAll("[data-del]")].forEach(btn=>{
      btn.addEventListener("click", async ()=>{
        const id = btn.getAttribute("data-del");
        if (!id) return;
        if (!confirm("Delete this message?")) return;
        try{ await deleteDoc(doc(db,"board",id)); }catch(e){ alert(e.message || String(e)); }
      });
    });
  });
</script>
</body>
</html>
