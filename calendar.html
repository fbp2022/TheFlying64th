<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Calendar ‚Äì The Flying 64th</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0f1115; --ink:#e9eef7; --muted:#b9c2d0;
      --panel:#151924; --panel2:#0d1018;
      --accent:#4da3ff; --rule:rgba(255,255,255,.10); --border:rgba(255,255,255,.12);
      --radius:12px;
      /* aircraft colors */
      --c172:#2b6bb1;
      --c150:#2b7a55;
      --inst:#e2b93b;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;
      background:var(--bg); color:var(--ink);
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    }

    /* ===== NAV (matches site) ===== */
    .site-header{
      position:sticky; top:0; z-index:60;
      backdrop-filter:saturate(160%) blur(8px);
      background:rgba(11,17,23,.75);
      border-bottom:1px solid var(--rule);
    }
    .nav{
      max-width:1200px; margin:0 auto; padding:12px 18px;
      display:flex; align-items:center; justify-content:space-between; gap:12px;
    }
    .brand{
      display:flex; align-items:center; gap:10px; font-weight:800; letter-spacing:.2px;
      color:var(--ink); text-decoration:none; font-size:22px; white-space:nowrap;
    }
    .brand img{ height:34px; width:auto }
    header nav{
      display:flex; align-items:center; gap:18px; flex-wrap:nowrap;
    }
    header nav a{
      color:var(--muted); text-decoration:none; padding:8px 12px; border-radius:10px;
      transition:all .18s ease;
    }
    header nav a:hover{ color:var(--ink); background:rgba(255,255,255,.06) }
    header nav a.active{ color:#001a33; background:var(--accent); font-weight:700 }
    .btn, .sbtn{
      border:1px solid var(--border); background:#0c1020; color:#eaf2ff;
      padding:10px 12px; border-radius:10px; text-decoration:none; font-weight:600;
      display:inline-flex; align-items:center; gap:8px; cursor:pointer;
    }
    .btn.primary{ background:linear-gradient(180deg,#2b6bb1,#1c4370); border:1px solid #2b6bb1 }
    .sbtn:disabled{ background:var(--accent); color:#001a33; border-color:transparent; font-weight:800; cursor:default }

    /* ===== BANNER ===== */
    .banner{
      max-width:1200px; margin:12px auto 0; padding:0 18px;
    }
    .banner .inner{
      background:linear-gradient(180deg,var(--panel),var(--panel2));
      border:1px solid var(--border); border-radius:12px; padding:10px 14px;
      display:flex; align-items:center; gap:10px; color:#dbe8ff;
    }

    /* ===== CONTROLS ===== */
    .controls{
      max-width:1200px; margin:10px auto; padding:0 18px;
      display:flex; gap:10px; align-items:center; justify-content:space-between; flex-wrap:wrap;
    }
    .pills{ display:flex; gap:8px; flex-wrap:wrap }
    .pill{
      border:1px solid var(--border); color:#cfe1ff; background:#0b1320; padding:8px 10px; border-radius:999px;
      cursor:pointer; font-weight:700; font-size:13px;
    }
    .pill.active{ color:#001a33; background:var(--accent); border-color:transparent }
    .right{ display:flex; align-items:center; gap:8px }
    .range{ font-weight:800; color:#cfe1ff }

    /* ===== LAYOUT ===== */
    .wrap{ max-width:1200px; margin:0 auto 60px; padding:0 18px; }
    .panels{ display:grid; grid-template-columns:1fr; gap:16px }
    .notes{ display:grid; grid-template-columns:1fr 1fr; gap:16px }
    @media (max-width:900px){ .notes{ grid-template-columns:1fr } }

    .note-card{
      background:linear-gradient(180deg,var(--panel),var(--panel2));
      border:1px solid var(--border); border-radius:12px; padding:12px;
    }
    .note-card h3{ margin:0 0 6px }
    .note-meta{ color:var(--muted); font-size:12px; margin-bottom:8px }
    .note-card textarea{
      width:100%; min-height:72px; resize:vertical; padding:10px 12px; border-radius:10px;
      border:1px solid var(--border); background:#0b0f1a; color:var(--ink);
    }

    /* ===== CALENDAR VIEWS ===== */
    #calendar{ min-height:520px }

    /* Month grid */
    .month-shell{
      background:linear-gradient(180deg,var(--panel),var(--panel2));
      border:1px solid var(--border); border-radius:12px; overflow:hidden;
    }
    .month-head{
      display:grid; grid-template-columns:repeat(7,1fr);
      background:#0c0f18; border-bottom:1px solid var(--border);
      color:#cfe1ff; font-weight:700; padding:8px 0; text-align:center;
    }
    .month-grid{
      display:grid; grid-template-columns:repeat(7,1fr);
      grid-auto-rows:140px;
    }
    .cell{
      border-right:1px solid var(--border); border-bottom:1px solid var(--border); padding:6px; position:relative; overflow:auto;
    }
    .cell:nth-child(7n){ border-right:none }
    .daynum{ position:absolute; top:6px; right:8px; font-weight:800; color:#9fbaf2 }
    .today .daynum{ color:#001a33; background:var(--accent); padding:2px 7px; border-radius:999px }
    .dim{ opacity:.45 }

    .evt{
      font-size:12px; margin:6px 0 0; padding:6px 8px; border-radius:8px; border:1px solid transparent;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .evt.c172{ background:#0e1d31; border-color:var(--c172) }
    .evt.c150{ background:#0f261c; border-color:var(--c150) }
    .inst{ color:var(--inst); font-weight:800; margin-left:6px }

    /* Week / Day */
    .view-shell{
      margin-top:12px;
      background:linear-gradient(180deg,var(--panel),var(--panel2));
      border:1px solid var(--border); border-radius:12px; overflow:hidden;
    }
    .week-head, .day-head{
      display:flex; align-items:center; justify-content:space-between;
      padding:10px 12px; background:#0c0f18; border-bottom:1px solid var(--border);
      color:#cfe1ff; font-weight:700;
    }
    .week-grid{
      display:grid; grid-template-columns:repeat(7,1fr); gap:0; border-top:1px solid var(--border);
    }
    .week-col{ min-height:360px; border-right:1px solid var(--border); padding:10px; overflow:auto }
    .week-col:last-child{ border-right:none }
    .wk-label{ color:#cfe1ff; font-weight:700; margin-bottom:6px }
    .day-list{ padding:10px }
    .item{ font-size:13px; padding:6px 8px; border-radius:8px; margin:6px 0; border:1px solid transparent; }
    .item.c172{ background:#0e1d31; border-color:var(--c172) }
    .item.c150{ background:#0f261c; border-color:var(--c150) }
    .badge{ font-weight:800; margin-left:6px; opacity:.85 }

    /* ===== MODAL (scroll fix) ===== */
    .overlay{ position:fixed; inset:0; background:rgba(0,0,0,.5); display:none; place-items:center; z-index:80 }
    .overlay.open{ display:grid }
    .modal{
      width:min(900px,96vw);
      background:#0f1722; color:#e6edf3; border:1px solid #1f2a38; border-radius:14px;
      display:flex; flex-direction:column; max-height:92vh;
    }
    .modal-h{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      padding:12px 16px; border-bottom:1px solid #1f2a38; font-weight:800;
    }
    .modal-b{ padding:12px 16px; overflow:auto }
    .modal-f{ padding:12px 16px; border-top:1px solid #1f2a38; display:flex; gap:8px; justify-content:flex-end }
    .xbtn{ background:none; border:0; color:#9fb1c3; font-size:18px; cursor:pointer }

    .grid2{ display:grid; grid-template-columns:1fr 1fr; gap:12px }
    .grid3{ display:grid; grid-template-columns:1fr 1fr 1fr; gap:12px }
    .grid4{ display:grid; grid-template-columns:1fr 1fr 1fr 1fr; gap:12px }
    @media (max-width:900px){
      .grid2, .grid3, .grid4{ grid-template-columns:1fr }
    }
    label{ display:block; font-size:12px; color:#9fb1c3; margin:8px 0 4px }
    input, select, textarea{
      width:100%; padding:10px 12px; border-radius:10px; border:1px solid #1f2a38; background:#0b1117; color:#e6edf3
    }
    .row{ display:flex; align-items:center; gap:10px; flex-wrap:wrap }
    .switch{ display:inline-flex; align-items:center; gap:8px }

  </style>
</head>
<body>

  <!-- ===== NAV ===== -->
  <header class="site-header">
    <div class="nav">
      <a href="home.html" class="brand">
        <img src="images/flying64thlogo.png" alt="The Flying 64th Logo">
        <span>The Flying 64th</span>
      </a>
      <nav>
        <a id="signinBtn" class="btn">Sign In</a>
        <a href="home.html">Home</a>
        <a class="active" href="calendar.html">Calendar</a>
        <a href="becomeamember.html">Become a Member</a>
        <a href="photos.html">Photos</a>
        <a href="poh&manuals.html">POH &amp; Manuals</a>
      </nav>
    </div>
  </header>

  <!-- ===== PERSISTENT BANNER ===== -->
  <div class="banner" aria-live="polite">
    <div class="inner">
      <div style="font-size:20px">üõ†Ô∏è</div>
      <div>
        <strong>Reminder:</strong> Enter <strong>Tach</strong> &amp; <strong>Hobbs</strong> start/end after every flight.
        If the prior end is missing, you‚Äôll be prompted to resolve it before <strong>closing your flight</strong>.
      </div>
    </div>
  </div>

  <!-- ===== CONTROLS ===== -->
  <div class="controls">
    <div class="pills" role="tablist" aria-label="Aircraft filter">
      <button class="pill active" data-ac="ALL">All</button>
      <button class="pill" data-ac="N78710">N78710 ‚Äî C172</button>
      <button class="pill" data-ac="N10921">N10921 ‚Äî C150</button>
      <button id="newBooking" class="btn primary">+ New booking</button>
      <button class="btn" disabled>Export (coming soon)</button>
    </div>
    <div class="right">
      <button id="todayBtn" class="sbtn">Today</button>
      <button id="prevBtn" class="sbtn">‚Äπ</button>
      <div class="range" id="rangeTitle">‚Ä¶</div>
      <button id="nextBtn" class="sbtn">‚Ä∫</button>
      <div class="viewbtns">
        <button class="sbtn" data-view="month" disabled>Month</button>
        <button class="sbtn" data-view="week">Week</button>
        <button class="sbtn" data-view="day">Day</button>
      </div>
    </div>
  </div>

  <!-- ===== MAIN ===== -->
  <main class="wrap">
    <section class="panels">
      <!-- Aircraft notes -->
      <div class="notes" aria-label="Aircraft status notes">
        <article class="note-card" id="noteC172">
          <h3>N78710 ‚Äî Cessna 172</h3>
          <div class="note-meta">Last updated: <span data-stamp="N78710">‚Äî</span></div>
          <textarea id="txtN78710" placeholder="e.g., Oil change due at ____ ‚Ä¢ Don‚Äôt fly after tach ___"></textarea>
          <div class="row" style="margin-top:8px;">
            <button class="btn" id="saveN78710">Save note</button>
          </div>
        </article>
        <article class="note-card" id="noteC150">
          <h3>N10921 ‚Äî Cessna 150</h3>
          <div class="note-meta">Last updated: <span data-stamp="N10921">‚Äî</span></div>
          <textarea id="txtN10921" placeholder="e.g., Squawk, fuel cap issue, tire wear, etc."></textarea>
          <div class="row" style="margin-top:8px;">
            <button class="btn" id="saveN10921">Save note</button>
          </div>
        </article>
      </div>

      <!-- Calendar host -->
      <section id="calendar"></section>
    </section>
  </main>

  <!-- ===== BOOKING MODAL ===== -->
  <div id="modalHost" class="overlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="bkTitle">
      <div class="modal-h">
        <div id="bkTitle">Add title and time</div>
        <button id="closeModal" class="xbtn" aria-label="Close">‚úï</button>
      </div>

      <div class="modal-b">
        <div class="grid2">
          <div>
            <label>First name</label>
            <input id="firstName" placeholder="First name" required>
          </div>
          <div>
            <label>Last name</label>
            <input id="lastName" placeholder="Last name" required>
          </div>
        </div>

        <label style="margin-top:10px">Email (from sign-in)</label>
        <input id="emailFromLogin" readonly placeholder="Sign in to populate">

        <label style="margin-top:10px">Aircraft</label>
        <select id="aircraft">
          <option value="N78710">N78710 ‚Äî Cessna 172</option>
          <option value="N10921">N10921 ‚Äî Cessna 150</option>
        </select>

        <label style="margin-top:10px">Title</label>
        <input id="titleInput" placeholder="e.g., Training flight or $100 burger">

        <div class="grid3" style="margin-top:8px;">
          <div>
            <label>Start date</label>
            <input id="startDate" type="date">
          </div>
          <div>
            <label>End date</label>
            <input id="endDate" type="date">
          </div>
          <div class="switch" style="margin-top:30px;">
            <input id="allDay" type="checkbox">
            <label for="allDay" style="margin:0">All day</label>
          </div>
        </div>

        <div class="grid2" id="timeRow" style="margin-top:8px;">
          <div>
            <label>Start time</label>
            <input id="startTime" type="time" step="900">
          </div>
          <div>
            <label>End time</label>
            <input id="endTime" type="time" step="900">
          </div>
        </div>

        <div class="grid2" style="margin-top:8px;">
          <div class="switch">
            <input id="withInstructor" type="checkbox">
            <label for="withInstructor" style="margin:0">Book with instructor?</label>
          </div>
          <div>
            <label>Instructor</label>
            <select id="instructorSelect" disabled>
              <option value="">Choose flight instructor</option>
              <option value="BW">Brian Westfall (BW)</option>
              <option value="JC">Justin Cox (JC)</option>
              <option value="JM">Jeff Moersch (JM)</option>
            </select>
          </div>
        </div>

        <div class="grid4" style="margin-top:8px;">
          <div>
            <label>Tach start</label>
            <input id="tachStart" inputmode="decimal" placeholder="">
          </div>
          <div>
            <label>Tach end</label>
            <input id="tachEnd" inputmode="decimal" placeholder="">
          </div>
          <div>
            <label>Tach delta</label>
            <input id="tachDelta" inputmode="decimal" placeholder="" readonly>
          </div>
          <div></div>
        </div>

        <div class="grid4" style="margin-top:8px;">
          <div>
            <label>Hobbs start</label>
            <input id="hobbsStart" inputmode="decimal" placeholder="">
          </div>
          <div>
            <label>Hobbs end</label>
            <input id="hobbsEnd" inputmode="decimal" placeholder="">
          </div>
          <div>
            <label>Hobbs delta</label>
            <input id="hobbsDelta" inputmode="decimal" placeholder="" readonly>
          </div>
          <div></div>
        </div>

        <label style="margin-top:10px">Comments</label>
        <textarea id="comments" rows="4" placeholder="Anything the next pilot should know‚Ä¶"></textarea>
      </div>

      <div class="modal-f">
        <button class="btn" id="cancelBooking">Cancel</button>
        <button class="btn primary" id="saveBooking">Save</button>
      </div>
    </div>
  </div>

  <!-- ===== Firebase & Calendar Logic ===== -->
  <script type="module">
    /* ===== Firebase (Auth only for email/label) ===== */
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, sendPasswordResetEmail, sendEmailVerification, signOut } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAI5lb0nXxAiBQThX6Y4tEQuqQ1cY6bn74",
      authDomain: "flying64th-b7813.firebaseapp.com",
      projectId: "flying64th-b7813",
      storageBucket: "flying64th-b7813.firebasestorage.app",
      messagingSenderId: "244940935157",
      appId: "1:244940935157:web:58e7305541377ba743dabc"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);

    // Simple auth launcher: click "Sign In" opens minimal prompt (dev convenience)
    document.getElementById('signinBtn').addEventListener('click', async ()=>{
      if (auth.currentUser) { await signOut(auth); return; }
      const email = prompt("Email:");
      if(!email) return;
      const pass  = prompt("Password:");
      if(!pass) return;
      try{
        await signInWithEmailAndPassword(auth, email.trim(), pass);
      }catch(e){
        // allow create quick account for testing (no invites here)
        if(confirm("Account not found. Create it?")){
          const cred = await createUserWithEmailAndPassword(auth, email.trim(), pass);
          await sendEmailVerification(cred.user);
          alert("Account created. Check your email to verify.");
        }else{
          alert(e.message);
        }
      }
    });

    onAuthStateChanged(auth, (user)=>{
      document.getElementById('signinBtn').textContent = user ? `Account ‚Äì ${user.email}` : "Sign In";
      const emailField = document.getElementById('emailFromLogin');
      if (emailField) emailField.value = user?.email || "";
    });

    /* ===== Local storage helpers (temporary data layer) ===== */
    const LS_EVENTS = 'f64_events';
    const LS_NOTES  = 'f64_notes';
    const getEvents = ()=> { try{return JSON.parse(localStorage.getItem(LS_EVENTS)||'[]')}catch{return[]} };
    const setEvents = (arr)=> localStorage.setItem(LS_EVENTS, JSON.stringify(arr));
    const getNotes  = ()=> { try{return JSON.parse(localStorage.getItem(LS_NOTES)||'{}')}catch{return{}} };
    const setNotes  = (obj)=> localStorage.setItem(LS_NOTES, JSON.stringify(obj));

    /* ===== State ===== */
    let viewDate = new Date();              // day being viewed
    let currentView = 'month';              // month | week | day
    let aircraftFilter = 'ALL';             // ALL | N78710 | N10921

    /* ===== Controls wiring ===== */
    const rangeTitle = document.getElementById('rangeTitle');
    const calendarEl = document.getElementById('calendar');

    // Filter pills
    document.querySelectorAll('.pill').forEach(p=>{
      p.addEventListener('click', ()=>{
        document.querySelectorAll('.pill').forEach(x=>x.classList.remove('active'));
        p.classList.add('active');
        aircraftFilter = p.dataset.ac;
        render();
      });
    });

    // View buttons
    const viewBtns = document.querySelectorAll('[data-view]');
    function setView(v){
      currentView = v;
      viewBtns.forEach(b => b.disabled = (b.dataset.view === v));
      render();
    }
    viewBtns.forEach(b => b.addEventListener('click', ()=> setView(b.dataset.view)));

    // Nav
    document.getElementById('todayBtn').addEventListener('click', ()=>{
      const t = new Date();
      viewDate = new Date(t.getFullYear(), t.getMonth(), t.getDate());
      render();
    });
    document.getElementById('prevBtn').addEventListener('click', ()=>{
      if(currentView==='month'){ viewDate = new Date(viewDate.getFullYear(), viewDate.getMonth()-1, 1); }
      else if(currentView==='week'){ viewDate.setDate(viewDate.getDate()-7); }
      else { viewDate.setDate(viewDate.getDate()-1); }
      render();
    });
    document.getElementById('nextBtn').addEventListener('click', ()=>{
      if(currentView==='month'){ viewDate = new Date(viewDate.getFullYear(), viewDate.getMonth()+1, 1); }
      else if(currentView==='week'){ viewDate.setDate(viewDate.getDate()+7); }
      else { viewDate.setDate(viewDate.getDate()+1); }
      render();
    });

    /* ===== Rendering helpers ===== */
    const fmtMonthTitle = (d)=> d.toLocaleDateString(undefined,{month:'long', year:'numeric'});
    const isSameDay = (a,b)=> a.getFullYear()===b.getFullYear() && a.getMonth()===b.getMonth() && a.getDate()===b.getDate();
    const classForAc = (ac)=> ac==='N78710' ? 'c172' : 'c150';

    function inFilter(ev){
      return aircraftFilter==='ALL' || ev.aircraft===aircraftFilter;
    }

    /* ===== Month view ===== */
    function renderMonth(){
      calendarEl.innerHTML = '';
      rangeTitle.textContent = fmtMonthTitle(viewDate);

      const shell = document.createElement('div'); shell.className='month-shell';
      const head = document.createElement('div'); head.className='month-head';
      ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'].forEach(d=>{
        const s=document.createElement('div'); s.textContent=d; head.appendChild(s);
      });
      shell.appendChild(head);

      const grid = document.createElement('div'); grid.className='month-grid';

      const first = new Date(viewDate.getFullYear(), viewDate.getMonth(), 1);
      const start = new Date(first); start.setDate(first.getDate() - first.getDay());
      const today = new Date();

      const events = getEvents().filter(inFilter);

      for(let i=0;i<42;i++){
        const day = new Date(start); day.setDate(start.getDate()+i);
        const inMonth = day.getMonth()===viewDate.getMonth();

        const cell = document.createElement('div');
        cell.className = 'cell'+(inMonth?'':' dim')+(isSameDay(day,today)?' today':'');
        const dn = document.createElement('div'); dn.className='daynum'; dn.textContent=day.getDate(); cell.appendChild(dn);

        const todays = events.filter(ev=>{
          const s = new Date(ev.startISO);
          return s.getFullYear()===day.getFullYear() && s.getMonth()===day.getMonth() && s.getDate()===day.getDate();
        }).sort((a,b)=> new Date(a.startISO)-new Date(b.startISO));

        todays.forEach(ev=>{
          const e = document.createElement('div');
          e.className = 'evt '+classForAc(ev.aircraft);
          const s = new Date(ev.startISO).toLocaleTimeString([], {hour:'numeric', minute:'2-digit'});
          const eT = new Date(ev.endISO).toLocaleTimeString([], {hour:'numeric', minute:'2-digit'});
          e.innerHTML = `<strong>${s}‚Äì${eT}</strong> ${ev.title||''}
            <span class="inst">${ev.withInstructor?'‚Ä¢ Instructor':''}</span>`;
          cell.appendChild(e);
        });

        grid.appendChild(cell);
      }

      shell.appendChild(grid);
      calendarEl.appendChild(shell);
    }

    /* ===== Week view ===== */
    function titleForWeek(d){
      const s = new Date(d); s.setDate(s.getDate()-s.getDay());
      const e = new Date(s); e.setDate(s.getDate()+6);
      const fmt = (dt,opts)=> dt.toLocaleDateString(undefined,opts);
      return `${fmt(s,{month:'short',day:'numeric'})} ‚Äì ${fmt(e,{month:'short',day:'numeric',year:'numeric'})}`;
    }
    function renderWeek(){
      calendarEl.innerHTML = '';
      rangeTitle.textContent = titleForWeek(viewDate);

      const shell = document.createElement('div'); shell.className='view-shell';
      const head  = document.createElement('div'); head.className='week-head';
      head.textContent = 'Week';
      shell.appendChild(head);

      const grid = document.createElement('div'); grid.className='week-grid';
      const start = new Date(viewDate); start.setDate(start.getDate()-start.getDay());
      const events = getEvents().filter(inFilter);

      for(let i=0;i<7;i++){
        const day = new Date(start); day.setDate(start.getDate()+i);
        const col = document.createElement('div'); col.className='week-col';
        const lbl = document.createElement('div'); lbl.className='wk-label';
        lbl.textContent = day.toLocaleDateString(undefined,{weekday:'short', month:'short', day:'numeric'});
        col.appendChild(lbl);

        const todays = events.filter(ev=>{
          const s = new Date(ev.startISO);
          return s.getFullYear()===day.getFullYear() && s.getMonth()===day.getMonth() && s.getDate()===day.getDate();
        }).sort((a,b)=> new Date(a.startISO)-new Date(b.startISO));

        todays.forEach(ev=>{
          const item = document.createElement('div');
          item.className = `item ${classForAc(ev.aircraft)}`;
          const s = new Date(ev.startISO).toLocaleTimeString([], {hour:'numeric', minute:'2-digit'});
          const e = new Date(ev.endISO).toLocaleTimeString([], {hour:'numeric', minute:'2-digit'});
          item.innerHTML = `<strong>${s}‚Äì${e}</strong> ${ev.title||''}
            <span class="badge">${ev.aircraft}</span>
            ${ev.withInstructor?'<span class="badge">‚Ä¢ Instructor</span>':''}`;
          col.appendChild(item);
        });

        grid.appendChild(col);
      }

      shell.appendChild(grid);
      calendarEl.appendChild(shell);
    }

    /* ===== Day view ===== */
    const titleForDay = (d)=> d.toLocaleDateString(undefined,{weekday:'long',month:'long',day:'numeric',year:'numeric'});
    function renderDay(){
      calendarEl.innerHTML = '';
      rangeTitle.textContent = titleForDay(viewDate);

      const shell = document.createElement('div'); shell.className='view-shell';
      const head  = document.createElement('div'); head.className='day-head';
      head.textContent = 'Day';
      shell.appendChild(head);

      const list = document.createElement('div'); list.className='day-list';
      const events = getEvents().filter(inFilter).filter(ev=>{
        const s = new Date(ev.startISO);
        return isSameDay(s, viewDate);
      }).sort((a,b)=> new Date(a.startISO)-new Date(b.startISO));

      if(!events.length){
        const empty = document.createElement('div');
        empty.className='item'; empty.style.border='1px dashed var(--border)';
        empty.textContent='No bookings.';
        list.appendChild(empty);
      }else{
        events.forEach(ev=>{
          const item = document.createElement('div');
          item.className = `item ${classForAc(ev.aircraft)}`;
          const s = new Date(ev.startISO).toLocaleTimeString([], {hour:'numeric', minute:'2-digit'});
          const e = new Date(ev.endISO).toLocaleTimeString([], {hour:'numeric', minute:'2-digit'});
          item.innerHTML = `<strong>${s}‚Äì${e}</strong> ${ev.title||''}
            <span class="badge">${ev.aircraft}</span>
            ${ev.withInstructor?'<span class="badge">‚Ä¢ Instructor</span>':''}`;
          list.appendChild(item);
        });
      }

      shell.appendChild(list);
      calendarEl.appendChild(shell);
    }

    function render(){
      if(currentView==='month') renderMonth();
      else if(currentView==='week') renderWeek();
      else renderDay();
    }

    /* ===== Modal wiring ===== */
    const overlay = document.getElementById('modalHost');
    const openModal = ()=>{ overlay.classList.add('open'); overlay.setAttribute('aria-hidden','false'); };
    const closeModal = ()=>{ overlay.classList.remove('open'); overlay.setAttribute('aria-hidden','true'); };
    document.getElementById('newBooking').addEventListener('click', ()=>{
      if(!auth.currentUser){ alert("Please sign in to book."); return; }
      // seed defaults
      document.getElementById('firstName').value = '';
      document.getElementById('lastName').value  = '';
      document.getElementById('titleInput').value = '';
      document.getElementById('startDate').valueAsDate = new Date(viewDate);
      document.getElementById('endDate').valueAsDate   = new Date(viewDate);
      document.getElementById('startTime').value = '10:00';
      document.getElementById('endTime').value   = '11:00';
      document.getElementById('allDay').checked  = false;
      document.getElementById('withInstructor').checked = false;
      document.getElementById('instructorSelect').disabled = true;
      ['tachStart','tachEnd','tachDelta','hobbsStart','hobbsEnd','hobbsDelta','comments'].forEach(id=>document.getElementById(id).value='');
      openModal();
    });
    document.getElementById('closeModal').addEventListener('click', closeModal);
    document.getElementById('cancelBooking').addEventListener('click', closeModal);
    overlay.addEventListener('click', (e)=>{ if(e.target===overlay) closeModal(); });

    // All day toggle
    const allDayEl = document.getElementById('allDay');
    const timeRow  = document.getElementById('timeRow');
    allDayEl.addEventListener('change', ()=>{ timeRow.style.display = allDayEl.checked ? 'none':'grid'; });

    // Instructor toggle
    const withInst = document.getElementById('withInstructor');
    const instSel  = document.getElementById('instructorSelect');
    withInst.addEventListener('change', ()=> instSel.disabled = !withInst.checked);

    // Auto deltas
    function updateDeltas(){
      const tS=parseFloat(document.getElementById('tachStart').value||'');
      const tE=parseFloat(document.getElementById('tachEnd').value||'');
      const hS=parseFloat(document.getElementById('hobbsStart').value||'');
      const hE=parseFloat(document.getElementById('hobbsEnd').value||'');
      document.getElementById('tachDelta').value  = (!isNaN(tS)&&!isNaN(tE)&&tE>=tS)? (tE-tS).toFixed(1):'';
      document.getElementById('hobbsDelta').value = (!isNaN(hS)&&!isNaN(hE)&&hE>=hS)? (hE-hS).toFixed(1):'';
    }
    ['tachStart','tachEnd','hobbsStart','hobbsEnd'].forEach(id=>{
      document.getElementById(id).addEventListener('input', updateDeltas);
    });

    // Save booking
    document.getElementById('saveBooking').addEventListener('click', ()=>{
      const user = auth.currentUser;
      if(!user){ alert('Please sign in to book.'); return; }

      const fn=document.getElementById('firstName').value.trim();
      const ln=document.getElementById('lastName').value.trim();
      if(!fn || !ln){ alert('Please enter your first and last name.'); return; }

      const ac  = document.getElementById('aircraft').value;
      const stD = document.getElementById('startDate').value;
      const enD = document.getElementById('endDate').value;
      const stT = document.getElementById('startTime').value || '00:00';
      const enT = document.getElementById('endTime').value   || '23:59';
      const allDay = document.getElementById('allDay').checked;

      if(!stD || !enD){ alert('Select start and end dates.'); return; }

      const startISO = new Date(`${stD}T${allDay?'00:00':stT}`).toISOString();
      const endISO   = new Date(`${enD}T${allDay?'23:59':enT}`).toISOString();
      if(new Date(endISO) <= new Date(startISO)){ alert('End must be after start.'); return; }

      const entry = {
        id: crypto.randomUUID(),
        title: document.getElementById('titleInput').value.trim(),
        aircraft: ac,
        withInstructor: withInst.checked,
        instructorId: instSel.value || null,
        startISO, endISO,
        member_first: fn, member_last: ln, member_email: user.email||"",
        tachStart: document.getElementById('tachStart').value || null,
        tachEnd:   document.getElementById('tachEnd').value   || null,
        hobbsStart:document.getElementById('hobbsStart').value|| null,
        hobbsEnd:  document.getElementById('hobbsEnd').value  || null,
        comments:  document.getElementById('comments').value  || null
      };

      const all = getEvents(); all.push(entry); setEvents(all);
      closeModal();
      // jump to start day for clarity
      viewDate = new Date(entry.startISO);
      render();
    });

    /* ===== Notes persistence ===== */
    function loadNotesUI(){
      const notes = getNotes();
      const n172 = notes['N78710'] || { text:'', ts:0 };
      const n150 = notes['N10921'] || { text:'', ts:0 };
      document.getElementById('txtN78710').value = n172.text || '';
      document.getElementById('txtN10921').value = n150.text || '';
      const s172 = document.querySelector('[data-stamp="N78710"]');
      const s150 = document.querySelector('[data-stamp="N10921"]');
      s172.textContent = n172.ts ? new Date(n172.ts).toLocaleString() : '‚Äî';
      s150.textContent = n150.ts ? new Date(n150.ts).toLocaleString() : '‚Äî';
    }
    function saveNote(key, textareaId){
      if(!auth.currentUser){ alert('Sign in to save notes.'); return; }
      const notes = getNotes();
      notes[key] = { text: document.getElementById(textareaId).value, ts: Date.now(), email: auth.currentUser.email||'' };
      setNotes(notes);
      loadNotesUI();
    }
    document.getElementById('saveN78710').addEventListener('click', ()=> saveNote('N78710','txtN78710'));
    document.getElementById('saveN10921').addEventListener('click', ()=> saveNote('N10921','txtN10921'));

    /* ===== Initial load ===== */
    loadNotesUI();
    render();
  </script>
</body>
</html>
