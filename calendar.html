<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>The Flying 64th â€“ Calendar</title>
  <meta name="description" content="Member booking calendar for The Flying 64th Flying Club at Oliver Springs Airport (Braden Field)." />

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#0b1117;
      --ink:#e6edf3;
      --muted:#9fb1c3;
      --panel:#0f1722;
      --rule:#1f2a38;
      --accent:#58a6ff;
      --accent-soft:#374151;
      --card:#0f1722cc;
      --shadow:0 10px 30px rgba(0,0,0,.35);
      --radius:16px;

      --your:#22c55e;
      --other:#3b82f6;
      --maint:#ef4444;
    }

    *{box-sizing:border-box}
    html,body{margin:0;height:100%}
    body{
      font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;
      background:var(--bg);
      color:var(--ink);
      line-height:1.6;
    }

    /* ===== NAV (shared with home) ===== */
    .site-header{
      position:sticky;
      top:0;
      z-index:50;
      backdrop-filter:saturate(160%) blur(8px);
      background:rgba(11,17,23,.85);
      border-bottom:1px solid var(--rule);
    }
    .nav{
      max-width:1200px;
      margin:0 auto;
      padding:10px 18px;
      display:flex;
      align-items:center;
      gap:12px;
    }
    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      font-weight:800;
      letter-spacing:.2px;
      color:var(--ink);
      text-decoration:none;
      font-size:22px;
      white-space:nowrap;
    }
    .brand img{height:34px;width:auto}

    nav.links{
      display:flex;
      align-items:center;
      gap:18px;
      flex-wrap:nowrap;
      margin-left:auto;
    }
    nav.links a{
      color:var(--muted);
      text-decoration:none;
      padding:8px 12px;
      border-radius:10px;
      transition:all .18s ease;
      white-space:nowrap;
    }
    nav.links a:hover{
      color:var(--ink);
      background:rgba(255,255,255,.06);
    }
    nav.links a.active{
      color:#001a33;
      background:var(--accent);
      font-weight:700;
    }
    .btn{
      border:1px solid rgba(255,255,255,.16);
      background:#0c1020;
      color:#eaf2ff;
      padding:8px 12px;
      border-radius:10px;
      font-weight:600;
      cursor:pointer;
      text-decoration:none;
      white-space:nowrap;
    }
    .btn.primary{
      background:linear-gradient(180deg,#2b6bb1,#1c4370);
      border:1px solid #2b6bb1;
      color:#eaf2ff;
    }

    .hamburger{
      display:none;
      margin-left:auto;
      background:none;
      border:1px solid rgba(255,255,255,.16);
      color:var(--ink);
      padding:6px 10px;
      border-radius:10px;
      cursor:pointer;
      font-size:18px;
    }

    @media (max-width:900px){
      .nav{position:relative}
      nav.links{
        display:none;
        position:absolute;
        top:100%;
        left:10px;
        right:10px;
        margin-top:8px;
        flex-direction:column;
        gap:10px;
        padding:10px;
        background:#0f1722;
        border-radius:12px;
        border:1px solid var(--rule);
      }
      nav.links.open{display:flex;}
      nav.links a{width:100%;text-align:left;}
      .hamburger{display:inline-flex;}
    }

    /* ===== LAYOUT ===== */
    main{
      max-width:1200px;
      margin:18px auto 40px;
      padding:0 18px;
      display:grid;
      grid-template-columns:260px minmax(0,1fr);
      gap:18px;
    }
    @media (max-width:960px){
      main{
        grid-template-columns:1fr;
      }
    }

    .card{
      background:var(--card);
      border:1px solid var(--rule);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:16px 16px 14px;
    }
    .card h2{
      margin:0 0 8px;
      font-size:1.1rem;
    }
    .muted{color:var(--muted);font-size:.9rem;}

    /* Tach cards */
    .tach-card{
      margin-top:12px;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--rule);
      background:#050812;
      font-size:.9rem;
    }
    .tach-title{font-weight:600;margin-bottom:4px;}
    .tach-row{display:flex;justify-content:space-between;font-size:.85rem;}

    .legend{
      display:flex;
      gap:10px;
      margin-top:10px;
      font-size:.8rem;
      align-items:center;
      flex-wrap:wrap;
    }
    .legend span{
      display:inline-flex;
      align-items:center;
      gap:6px;
    }
    .dot{
      width:10px;
      height:10px;
      border-radius:999px;
      display:inline-block;
    }
    .dot.your{background:var(--your);}
    .dot.other{background:var(--other);}
    .dot.maint{background:var(--maint);}

    /* ===== FILTERS BAR ===== */
    .filters{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-bottom:12px;
      flex-wrap:wrap;
    }
    .filter-group{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
    }
    .pill{
      padding:5px 10px;
      border-radius:999px;
      border:1px solid var(--rule);
      background:#050812;
      color:var(--muted);
      font-size:.8rem;
      cursor:pointer;
    }
    .pill.active{
      border-color:var(--accent);
      color:var(--ink);
      background:#0b1120;
    }

    /* ===== CALENDAR (MONTH GRID) ===== */
    .cal-shell{
      background:var(--card);
      border-radius:var(--radius);
      border:1px solid var(--rule);
      box-shadow:var(--shadow);
      padding:14px 16px 18px;
    }
    .cal-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:10px;
      gap:12px;
      flex-wrap:wrap;
    }
    .cal-month{
      font-weight:700;
      font-size:1.05rem;
    }
    .cal-nav{
      display:flex;
      gap:6px;
      align-items:center;
    }
    .cal-nav button{
      border-radius:999px;
      border:1px solid var(--rule);
      background:#050812;
      color:var(--ink);
      padding:4px 8px;
      font-size:.8rem;
      cursor:pointer;
    }
    .cal-nav button.primary{
      background:var(--accent);
      border-color:transparent;
      color:#001a33;
      font-weight:600;
    }

    .weekday-row{
      display:grid;
      grid-template-columns:repeat(7,1fr);
      font-size:.8rem;
      color:var(--muted);
      padding:4px 2px 4px;
      border-bottom:1px solid var(--rule);
    }
    .weekday-row div{
      text-align:right;
      padding-right:6px;
    }

    .month-grid{
      display:grid;
      grid-template-columns:repeat(7,1fr);
      grid-auto-rows:120px;
      gap:0;
      font-size:.8rem;
    }
    @media (max-width:800px){
      .month-grid{grid-auto-rows:90px;}
    }
    @media (max-width:640px){
      .month-grid{grid-auto-rows:80px;}
    }

    .day-cell{
      border-right:1px solid var(--rule);
      border-bottom:1px solid var(--rule);
      padding:4px 4px 2px;
      position:relative;
      cursor:pointer;
      overflow:hidden;
    }
    .day-cell:nth-child(7n){
      border-right:none;
    }
    .day-num{
      text-align:right;
      font-size:.8rem;
      color:var(--muted);
      margin-bottom:2px;
    }
    .day-cell.other-month .day-num{
      opacity:.4;
    }
    .day-cell.today{
      box-shadow:0 0 0 1px var(--accent) inset;
    }

    .event-pill{
      font-size:.74rem;
      border-radius:999px;
      padding:2px 6px;
      margin-bottom:2px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      background:var(--other);
      color:#001021;
    }
    .event-your{
      background:var(--your);
      color:#001b0a;
    }
    .event-maint{
      background:var(--maint);
      color:#1f0202;
    }

    /* ===== MODAL ===== */
    .modal-backdrop{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.55);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:80;
    }
    .modal-backdrop.open{display:flex;}

    .modal{
      width:min(860px,96vw);
      max-height:92vh;
      background:#050812;
      border-radius:18px;
      border:1px solid var(--rule);
      box-shadow:0 24px 60px rgba(0,0,0,.7);
      display:flex;
      flex-direction:column;
    }
    .modal-header{
      padding:14px 18px 10px;
      border-bottom:1px solid var(--rule);
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:8px;
    }
    .modal-title{font-weight:700;font-size:1rem;}
    .modal-close{
      border:0;
      background:none;
      color:var(--muted);
      font-size:18px;
      cursor:pointer;
    }
    .modal-body{
      padding:14px 18px 16px;
      overflow-y:auto;
    }
    .modal-footer{
      padding:10px 18px 12px;
      border-top:1px solid var(--rule);
      display:flex;
      justify-content:flex-end;
      gap:8px;
      flex-wrap:wrap;
    }

    .form-grid{
      display:grid;
      grid-template-columns:repeat(2,minmax(0,1fr));
      gap:12px 14px;
    }
    @media (max-width:720px){
      .form-grid{grid-template-columns:1fr;}
    }
    .form-field{
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    .label{
      font-size:.78rem;
      color:var(--muted);
    }
    .input,
    .select{
      border-radius:10px;
      border:1px solid var(--rule);
      background:#020617;
      color:var(--ink);
      padding:8px 9px;
      font-size:.85rem;
      width:100%;
    }
    .input:focus,
    .select:focus{
      outline:none;
      border-color:var(--accent);
    }
    .row-inline{
      display:flex;
      gap:6px;
      align-items:center;
    }
    .icon-btn{
      border-radius:10px;
      border:1px solid var(--rule);
      background:#020617;
      color:var(--ink);
      padding:6px 8px;
      cursor:pointer;
      font-size:.8rem;
    }

    .time-chips{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      margin-top:4px;
    }
    .time-chip{
      border-radius:999px;
      border:1px solid var(--rule);
      padding:2px 6px;
      font-size:.72rem;
      cursor:pointer;
      background:#020617;
      color:var(--muted);
    }
    .time-chip:hover{
      border-color:var(--accent);
      color:var(--ink);
    }

    textarea.input{
      min-height:70px;
      resize:vertical;
    }

    .danger{
      background:#7f1d1d;
      border-color:#b91c1c;
      color:#fee2e2;
    }

    .hint-text{
      font-size:.78rem;
      color:var(--muted);
      margin-top:3px;
    }
  </style>
</head>
<body>

<header class="site-header">
  <div class="nav">
    <a class="brand" href="home.html">
      <img src="images/flying64thlogo.png" alt="The Flying 64th Logo" style="width:80px;height:auto;">
      <span>The Flying 64th</span>
    </a>

    <button class="hamburger" id="navToggle" aria-label="Toggle navigation">â˜°</button>

    <nav class="links" id="mainNav">
      <a href="home.html">Home</a>
      <a class="active" href="calendar.html">Calendar</a>
      <a href="becomeamember.html">Become a Member</a>
      <a href="photos.html">Photos</a>
      <a href="members.html">Members</a>
      <a href="poh&manuals.html">POH &amp; Manuals</a>
    </nav>
  </div>
</header>

<main>
  <!-- LEFT SIDEBAR -->
  <aside>
    <section class="card">
      <h2>Reminder</h2>
      <p class="muted">
        Enter <strong>Tach</strong> &amp; <strong>Hobbs</strong> start/end after every flight.
        If the prior end is missing, you'll be prompted to resolve it before closing your flight.
      </p>

      <div id="statusCards"></div>

      <div class="legend">
        <span><span class="dot your"></span>Your bookings</span>
        <span><span class="dot other"></span>Other members</span>
        <span><span class="dot maint"></span>Maintenance</span>
      </div>
    </section>
  </aside>

  <!-- MAIN CALENDAR AREA -->
  <section>
    <div class="card" style="margin-bottom:10px;">
      <div class="filters">
        <div class="filter-group">
          <button class="pill active" data-aircraft="all">All</button>
          <button class="pill" data-aircraft="N78710">N78710 â€” C172</button>
          <button class="pill" data-aircraft="N10921">N10921 â€” C150</button>
        </div>
        <div>
          <button id="newBookingBtn" class="btn primary">+ New booking</button>
        </div>
      </div>
    </div>

    <div class="cal-shell">
      <div class="cal-header">
        <div class="cal-month" id="monthLabel">Month YYYY</div>
        <div class="cal-nav">
          <button id="monthOnlyLabel" style="opacity:.75;font-size:.72rem;border-radius:6px;">
            Month view only for now
          </button>
          <button id="prevMonthBtn">&lt;</button>
          <button id="todayBtn" class="primary">Today</button>
          <button id="nextMonthBtn">&gt;</button>
        </div>
      </div>

      <div class="weekday-row">
        <div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div>
      </div>
      <div id="monthGrid" class="month-grid"></div>
    </div>
  </section>
</main>

<!-- BOOKING MODAL -->
<div id="bookingModalBackdrop" class="modal-backdrop" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true">
    <div class="modal-header">
      <div class="modal-title" id="bookingModalTitle">New booking</div>
      <button class="modal-close" id="bookingCloseBtn" aria-label="Close">âœ•</button>
    </div>
    <div class="modal-body">
      <div class="form-grid">
        <div class="form-field">
          <label class="label" for="aircraftSelect">Aircraft</label>
          <select id="aircraftSelect" class="select">
            <option value="N78710">N78710 â€” C172</option>
            <option value="N10921">N10921 â€” C150</option>
          </select>
        </div>

        <div class="form-field">
          <label class="label" for="titleSelect">Title / purpose</label>
          <select id="titleSelect" class="select">
            <option value="Training">Training</option>
            <option value="Rental">Rental</option>
            <option value="Checkride Prep">Checkride Prep</option>
            <option value="Checkride">Checkride</option>
            <option value="Maintenance">Maintenance</option>
          </select>
        </div>

        <div class="form-field">
          <label class="label">Start date</label>
          <div class="row-inline">
            <input id="startDateInput" type="date" class="input">
            <button type="button" class="icon-btn" id="startDateIcon">ðŸ“…</button>
          </div>
        </div>

        <div class="form-field">
          <label class="label">End date</label>
          <div class="row-inline">
            <input id="endDateInput" type="date" class="input">
            <button type="button" class="icon-btn" id="endDateIcon">ðŸ“…</button>
          </div>
        </div>

        <div class="form-field">
          <label class="label">Time window â€“ from</label>
          <div class="row-inline">
            <input id="startTimeInput" type="time" class="input">
            <button type="button" class="icon-btn" id="startTimeIcon">ðŸ•’</button>
          </div>
          <div class="hint-text">Leave blank for all-day booking.</div>
        </div>

        <div class="form-field">
          <label class="label">Time window â€“ to</label>
          <div class="row-inline">
            <input id="endTimeInput" type="time" class="input">
            <button type="button" class="icon-btn" id="endTimeIcon">ðŸ•’</button>
          </div>
          <div class="time-chips" id="quickTimesRow">
            <!-- quick chips injected by JS -->
          </div>
        </div>

        <div class="form-field">
          <label class="label">First name</label>
          <input id="firstNameInput" class="input" type="text" readonly>
        </div>

        <div class="form-field">
          <label class="label">Last name</label>
          <input id="lastNameInput" class="input" type="text" readonly>
        </div>

        <div class="form-field">
          <label class="label">Email (from your account)</label>
          <input id="emailInput" class="input" type="email" readonly>
        </div>

        <div class="form-field">
          <label class="label" for="instructorSelect">Instructor</label>
          <select id="instructorSelect" class="select">
            <option value="">N/A</option>
          </select>
          <div class="hint-text" id="instructorEmailDisplay"></div>
        </div>

        <div class="form-field">
          <label class="label">Tach start</label>
          <input id="tachStartInput" class="input" type="text" placeholder="">
        </div>

        <div class="form-field">
          <label class="label">Tach end</label>
          <input id="tachEndInput" class="input" type="text" placeholder="">
        </div>

        <div class="form-field">
          <label class="label">Hobbs start</label>
          <input id="hobbsStartInput" class="input" type="text" placeholder="">
        </div>

        <div class="form-field">
          <label class="label">Hobbs end</label>
          <input id="hobbsEndInput" class="input" type="text" placeholder="">
        </div>

        <div class="form-field" style="grid-column:1 / -1;">
          <label class="label">Comments</label>
          <textarea id="commentsInput" class="input" placeholder=""></textarea>
        </div>
      </div>
      <div class="hint-text" id="bookingError" style="color:#fecaca;margin-top:8px;"></div>
    </div>
    <div class="modal-footer">
      <button id="deleteBookingBtn" class="btn danger" style="display:none;">Delete booking</button>
      <div style="flex:1;"></div>
      <button id="cancelBookingBtn" class="btn">Cancel</button>
      <button id="saveBookingBtn" class="btn primary">Save</button>
    </div>
  </div>
</div>

<script type="module">
  /* ================= NAV HAMBURGER ================= */
  (function(){
    const navToggle = document.getElementById('navToggle');
    const mainNav  = document.getElementById('mainNav');
    navToggle?.addEventListener('click', ()=> mainNav.classList.toggle('open'));
    mainNav?.querySelectorAll('a').forEach(a=>{
      a.addEventListener('click', ()=> mainNav.classList.remove('open'));
    });
  })();

  /* ================= FIREBASE IMPORTS ================= */
  import {
    app,
    auth,
    db,
    onAuthChanged,
    getMyRole
  } from './auth.js';

  import {
    collection,
    query,
    where,
    orderBy,
    onSnapshot,
    getDocs,
    doc,
    getDoc,
    setDoc,
    updateDoc,
    deleteDoc,
    serverTimestamp
  } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";

  /* ================= GLOBAL STATE ================= */
  let currentUser = null;
  let currentRole = null; // {uid,email,firstName,lastName,isAdmin,...}
  let isAdmin = false;

  let viewYear, viewMonth; // JS month (0-11)
  let bookings = [];       // raw bookings from Firestore
  let aircraftFilter = "all";

  let instructors = [];    // {name,email}

  let selectedBookingId = null; // null = new booking

  /* ================= DOM REFS ================= */
  const statusCardsEl   = document.getElementById('statusCards');
  const monthLabelEl    = document.getElementById('monthLabel');
  const monthGridEl     = document.getElementById('monthGrid');

  const filterPills     = [...document.querySelectorAll('.pill[data-aircraft]')];
  const newBookingBtn   = document.getElementById('newBookingBtn');

  const prevMonthBtn    = document.getElementById('prevMonthBtn');
  const nextMonthBtn    = document.getElementById('nextMonthBtn');
  const todayBtn        = document.getElementById('todayBtn');

  // Modal
  const modalBackdrop   = document.getElementById('bookingModalBackdrop');
  const modalTitleEl    = document.getElementById('bookingModalTitle');
  const bookingCloseBtn = document.getElementById('bookingCloseBtn');
  const cancelBookingBtn= document.getElementById('cancelBookingBtn');
  const saveBookingBtn  = document.getElementById('saveBookingBtn');
  const deleteBookingBtn= document.getElementById('deleteBookingBtn');
  const bookingErrorEl  = document.getElementById('bookingError');

  // Form fields
  const aircraftSelect  = document.getElementById('aircraftSelect');
  const titleSelect     = document.getElementById('titleSelect');
  const startDateInput  = document.getElementById('startDateInput');
  const endDateInput    = document.getElementById('endDateInput');
  const startTimeInput  = document.getElementById('startTimeInput');
  const endTimeInput    = document.getElementById('endTimeInput');
  const startDateIcon   = document.getElementById('startDateIcon');
  const endDateIcon     = document.getElementById('endDateIcon');
  const startTimeIcon   = document.getElementById('startTimeIcon');
  const endTimeIcon     = document.getElementById('endTimeIcon');

  const firstNameInput  = document.getElementById('firstNameInput');
  const lastNameInput   = document.getElementById('lastNameInput');
  const emailInput      = document.getElementById('emailInput');

  const instructorSelect= document.getElementById('instructorSelect');
  const instructorEmailDisplay = document.getElementById('instructorEmailDisplay');

  const tachStartInput  = document.getElementById('tachStartInput');
  const tachEndInput    = document.getElementById('tachEndInput');
  const hobbsStartInput = document.getElementById('hobbsStartInput');
  const hobbsEndInput   = document.getElementById('hobbsEndInput');
  const commentsInput   = document.getElementById('commentsInput');

  const quickTimesRow   = document.getElementById('quickTimesRow');

  /* ================= UTILITIES ================= */
  const pad = (n)=> String(n).padStart(2,'0');
  const dateKey = (d)=> `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;

  function parseDateStr(str){
    if(!str) return null;
    const [y,m,d] = str.split('-').map(Number);
    if(!y || !m || !d) return null;
    return new Date(y,m-1,d);
  }

  function openModal(){
    modalBackdrop.classList.add('open');
    modalBackdrop.setAttribute('aria-hidden','false');
  }
  function closeModal(){
    modalBackdrop.classList.remove('open');
    modalBackdrop.setAttribute('aria-hidden','true');
    selectedBookingId = null;
    bookingErrorEl.textContent = "";
  }

  function setViewToToday(){
    const now = new Date();
    viewYear = now.getFullYear();
    viewMonth = now.getMonth();
    renderMonth();
  }

  function ensureEndAfterStart(){
    const s = parseDateStr(startDateInput.value);
    const e = parseDateStr(endDateInput.value);
    if(!s || !e) return;
    if(e < s){
      endDateInput.value = startDateInput.value;
    }
  }

  /* ================= QUICK TIME CHIPS ================= */
  (function initQuickTimes(){
    const times = ["08:00","09:00","10:00","11:00","12:00","13:00","14:00","15:00","16:00","17:00","18:00","19:00","20:00"];
    times.forEach(t=>{
      const chip = document.createElement('button');
      chip.type = "button";
      chip.className = "time-chip";
      chip.textContent = t;
      chip.addEventListener('click', ()=> { endTimeInput.value = t; });
      quickTimesRow.appendChild(chip);
    });
  })();

  /* ================= AIRCRAFT STATUS ================= */
  function subscribeAircraftStatus(){
    const qStatus = query(collection(db,"aircraftStatus"));
    onSnapshot(qStatus, (snap)=>{
      statusCardsEl.innerHTML = "";
      snap.forEach(docSnap=>{
        const d = docSnap.data();
        const div = document.createElement('div');
        div.className = "tach-card";
        div.innerHTML = `
          <div class="tach-title">${docSnap.id}</div>
          <div class="tach-row"><span>Tach:</span><span>${d.currentTach ?? 'â€”'}</span></div>
          <div class="tach-row"><span>Hobbs:</span><span>${d.currentHobbs ?? 'â€”'}</span></div>
          <div style="margin-top:4px;font-size:.75rem;color:var(--muted);">
            Last updated: ${d.updatedAt?.toDate ? d.updatedAt.toDate().toLocaleString() : 'â€”'}
          </div>
        `;
        statusCardsEl.appendChild(div);
      });
    });
  }

  /* ================= INSTRUCTORS ================= */
  async function loadInstructors(){
    instructors = [];
    try{
      const snap = await getDocs(collection(db,"instructors"));
      snap.forEach(docSnap=>{
        const data = docSnap.data() || {};
        Object.entries(data).forEach(([name,email])=>{
          if(!name || !email) return;
          instructors.push({name,email});
        });
      });
    }catch(e){
      console.warn("instructors error:", e);
    }
    // populate select
    instructorSelect.innerHTML = `<option value="">N/A</option>`;
    instructors.forEach(i=>{
      const opt = document.createElement('option');
      opt.value = i.email;
      opt.textContent = i.name;
      instructorSelect.appendChild(opt);
    });
  }

  instructorSelect.addEventListener('change', ()=>{
    const email = instructorSelect.value || "";
    const inst = instructors.find(i => i.email === email);
    instructorEmailDisplay.textContent = inst ? inst.email : "";
  });

  /* ================= BOOKINGS LOAD / RENDER ================= */
  function subscribeBookings(){
    const qBookings = query(collection(db,"bookings"), orderBy("startDate","asc"), orderBy("startTime","asc"));
    onSnapshot(qBookings, (snap)=>{
      bookings = [];
      snap.forEach(d=>{
        bookings.push({id:d.id, ...d.data()});
      });
      renderMonth();
    });
  }

  function renderMonth(){
    const monthName = new Date(viewYear,viewMonth,1).toLocaleString(undefined,{month:"long",year:"numeric"});
    monthLabelEl.textContent = monthName;

    // build grid dates: start Sunday before 1st
    const first = new Date(viewYear,viewMonth,1);
    const start = new Date(first);
    start.setDate(first.getDate() - first.getDay()); // Sunday
    const last = new Date(viewYear,viewMonth+1,0);
    const end = new Date(last);
    end.setDate(last.getDate() + (6-last.getDay())); // Saturday

    const days = [];
    for(let d = new Date(start); d <= end; d.setDate(d.getDate()+1)){
      days.push(new Date(d));
    }

    monthGridEl.innerHTML = "";
    const todayKey = dateKey(new Date());

    days.forEach(day=>{
      const cell = document.createElement('div');
      cell.className = "day-cell";
      const dk = dateKey(day);
      if(day.getMonth() !== viewMonth) cell.classList.add('other-month');
      if(dk === todayKey) cell.classList.add('today');
      cell.dataset.date = dk;
      cell.innerHTML = `<div class="day-num">${day.getDate()}</div>`;
      monthGridEl.appendChild(cell);
    });

    // add bookings as pills
    const cellsByDate = {};
    [...monthGridEl.children].forEach(c=>{
      cellsByDate[c.dataset.date] = c;
    });

    bookings.forEach(b=>{
      if(aircraftFilter !== "all" && b.aircraft !== aircraftFilter) return;

      const s = parseDateStr(b.startDate);
      const e = parseDateStr(b.endDate || b.startDate);
      if(!s || !e) return;

      const startTime = (b.startTime || "").slice(0,5);
      const endTime   = (b.endTime || "").slice(0,5);
      const labelTime = startTime && endTime ? `${startTime}-${endTime} ` : startTime ? `${startTime} ` : "";

      const ownerLabel = b.member_last ? `${b.member_first || ''} ${b.member_last || ''}`.trim() : (b.member_first || 'Member');
      const title = b.title || "Flight";

      const isYour = currentUser && b.uid === currentUser.uid;
      const isMaint = title === "Maintenance";

      // place pill on each day the booking covers
      let d = new Date(s);
      while(d <= e){
        const dk = dateKey(d);
        const cell = cellsByDate[dk];
        if(cell){
          const pill = document.createElement('div');
          pill.className = "event-pill";
          if(isYour) pill.classList.add('event-your');
          if(isMaint) pill.classList.add('event-maint');
          pill.textContent = `${labelTime}${title} (${ownerLabel || 'Member'})`;
          pill.dataset.bookingId = b.id;
          cell.appendChild(pill);
        }
        d.setDate(d.getDate()+1);
      }
    });

    // click handlers (day & events)
    [...monthGridEl.querySelectorAll('.day-cell')].forEach(cell=>{
      cell.addEventListener('click', (e)=>{
        // if event pill clicked, that handler will run; don't also open new
        if(e.target.closest('.event-pill')) return;
        const dStr = cell.dataset.date;
        openNewBookingForDate(dStr);
      });
    });

    [...monthGridEl.querySelectorAll('.event-pill')].forEach(pill=>{
      pill.addEventListener('click', (e)=>{
        e.stopPropagation();
        const id = pill.dataset.bookingId;
        const booking = bookings.find(b=>b.id === id);
        if(booking) openEditBooking(booking);
      });
    });
  }

  /* ================= OPEN MODAL: NEW / EDIT ================= */
  function fillMemberFields(){
    if(!currentRole) return;
    firstNameInput.value = currentRole.profile?.firstName || "";
    lastNameInput.value  = currentRole.profile?.lastName || "";
    emailInput.value     = currentRole.email || "";
  }

  function openNewBookingForDate(dateStr){
    if(!currentUser){
      alert("Sign in to create a booking.");
      return;
    }
    selectedBookingId = null;
    modalTitleEl.textContent = "New booking";
    deleteBookingBtn.style.display = "none";
    bookingErrorEl.textContent = "";

    fillMemberFields();

    const s = dateStr || dateKey(new Date());
    startDateInput.value = s;
    endDateInput.value   = s;
    startTimeInput.value = "";
    endTimeInput.value   = "";
    titleSelect.value    = "Training";
    aircraftSelect.value = aircraftFilter !== "all" ? aircraftFilter : "N78710";
    instructorSelect.value = "";
    instructorEmailDisplay.textContent = "";
    tachStartInput.value  = "";
    tachEndInput.value    = "";
    hobbsStartInput.value = "";
    hobbsEndInput.value   = "";
    commentsInput.value   = "";

    openModal();
  }

  function openEditBooking(b){
    selectedBookingId = b.id;
    modalTitleEl.textContent = "Edit booking";
    bookingErrorEl.textContent = "";

    aircraftSelect.value = b.aircraft || "N78710";
    titleSelect.value    = b.title || "Training";
    startDateInput.value = b.startDate || dateKey(new Date());
    endDateInput.value   = b.endDate || b.startDate || startDateInput.value;
    startTimeInput.value = b.startTime || "";
    endTimeInput.value   = b.endTime || "";

    firstNameInput.value = b.member_first || "";
    lastNameInput.value  = b.member_last || "";
    emailInput.value     = b.member_email || "";

    instructorSelect.value = b.instructorEmail || "";
    const inst = instructors.find(i => i.email === b.instructorEmail);
    instructorEmailDisplay.textContent = inst ? inst.email : "";

    tachStartInput.value  = b.tach_start  || "";
    tachEndInput.value    = b.tach_end    || "";
    hobbsStartInput.value = b.hobbs_start || "";
    hobbsEndInput.value   = b.hobbs_end   || "";
    commentsInput.value   = b.comments    || "";

    const canDelete = isAdmin || (currentUser && b.uid === currentUser.uid && b.title !== "Maintenance");
    deleteBookingBtn.style.display = canDelete ? "inline-flex" : "none";

    openModal();
  }

  /* ================= SAVE / DELETE ================= */
  function validateBooking(){
    bookingErrorEl.textContent = "";

    const sDate = startDateInput.value;
    const eDate = endDateInput.value || sDate;
    if(!sDate){
      bookingErrorEl.textContent = "Start date is required.";
      return null;
    }
    const sd = parseDateStr(sDate);
    const ed = parseDateStr(eDate);
    if(!sd || !ed){
      bookingErrorEl.textContent = "Invalid dates.";
      return null;
    }
    if(ed < sd){
      bookingErrorEl.textContent = "End date cannot be before start date.";
      return null;
    }

    const title = titleSelect.value || "Training";
    if(title === "Maintenance" && !isAdmin){
      bookingErrorEl.textContent = "Only admins can create Maintenance bookings.";
      return null;
    }

    const member_first = firstNameInput.value.trim();
    const member_last  = lastNameInput.value.trim();
    if(!member_first || !member_last){
      bookingErrorEl.textContent = "First and last name are required on your profile.";
      return null;
    }

    return {
      aircraft: aircraftSelect.value || "N78710",
      title,
      startDate: sDate,
      endDate: eDate,
      startTime: startTimeInput.value || "",
      endTime:   endTimeInput.value   || "",
      allDay: (!startTimeInput.value && !endTimeInput.value),
      member_first,
      member_last,
      member_email: emailInput.value || currentUser?.email || "",
      instructorName: (instructors.find(i => i.email === instructorSelect.value)?.name) || "",
      instructorEmail: instructorSelect.value || "",
      tach_start:  tachStartInput.value  || "",
      tach_end:    tachEndInput.value    || "",
      hobbs_start: hobbsStartInput.value || "",
      hobbs_end:   hobbsEndInput.value   || "",
      comments: commentsInput.value || ""
    };
  }

  async function saveBooking(){
    if(!currentUser){
      bookingErrorEl.textContent = "Sign in required.";
      return;
    }
    const data = validateBooking();
    if(!data) return;

    try{
      if(!selectedBookingId){
        const docRef = doc(collection(db,"bookings"));
        await setDoc(docRef, {
          ...data,
          uid: currentUser.uid,
          createdAt: serverTimestamp()
        });
      }else{
        const existing = bookings.find(b => b.id === selectedBookingId);
        const isMaint = existing && existing.title === "Maintenance";
        if(isMaint && !isAdmin){
          bookingErrorEl.textContent = "Only admins can update Maintenance bookings.";
          return;
        }
        if(!isAdmin && existing && existing.uid !== currentUser.uid){
          bookingErrorEl.textContent = "You can only edit your own bookings.";
          return;
        }
        await updateDoc(doc(db,"bookings",selectedBookingId), data);
      }
      closeModal();
    }catch(e){
      console.error(e);
      bookingErrorEl.textContent = e.message || "Failed to save booking.";
    }
  }

  async function deleteBooking(){
    if(!selectedBookingId) return;
    const b = bookings.find(b=>b.id === selectedBookingId);
    if(!b) return;
    const isMaint = b.title === "Maintenance";
    if(isMaint && !isAdmin){
      alert("Only admins can delete Maintenance bookings.");
      return;
    }
    if(!isAdmin && currentUser && b.uid !== currentUser.uid){
      alert("You can only delete your own bookings.");
      return;
    }
    if(!confirm("Delete this booking?")) return;
    try{
      await deleteDoc(doc(db,"bookings",selectedBookingId));
      closeModal();
    }catch(e){
      alert(e.message || "Failed to delete booking.");
    }
  }

  /* ================= EVENT WIRES ================= */
  newBookingBtn.addEventListener('click', ()=> openNewBookingForDate());

  prevMonthBtn.addEventListener('click', ()=>{
    viewMonth--;
    if(viewMonth < 0){viewMonth = 11; viewYear--;}
    renderMonth();
  });
  nextMonthBtn.addEventListener('click', ()=>{
    viewMonth++;
    if(viewMonth > 11){viewMonth = 0; viewYear++;}
    renderMonth();
  });
  todayBtn.addEventListener('click', ()=> setViewToToday());

  filterPills.forEach(pill=>{
    pill.addEventListener('click', ()=>{
      filterPills.forEach(p=>p.classList.remove('active'));
      pill.classList.add('active');
      aircraftFilter = pill.dataset.aircraft;
      renderMonth();
    });
  });

  bookingCloseBtn.addEventListener('click', closeModal);
  cancelBookingBtn.addEventListener('click', closeModal);
  saveBookingBtn.addEventListener('click', saveBooking);
  deleteBookingBtn.addEventListener('click', deleteBooking);

  startDateInput.addEventListener('change', ensureEndAfterStart);
  endDateInput.addEventListener('change', ensureEndAfterStart);

  startDateIcon.addEventListener('click', ()=> startDateInput.showPicker?.());
  endDateIcon.addEventListener('click',   ()=> endDateInput.showPicker?.());
  startTimeIcon.addEventListener('click', ()=> startTimeInput.showPicker?.());
  endTimeIcon.addEventListener('click',   ()=> endTimeInput.showPicker?.());

  /* ================= AUTH / ROLE ================= */
  onAuthChanged(async (user)=>{
    currentUser = user || null;
    if(!user){
      currentRole = null;
      isAdmin = false;
      return;
    }
    try{
      currentRole = await getMyRole();
      isAdmin = !!currentRole?.isAdmin;
    }catch(e){
      console.warn("getMyRole error", e);
      isAdmin = false;
    }
  });

  /* ================= INIT ================= */
  subscribeAircraftStatus();
  subscribeBookings();
  loadInstructors();
  setViewToToday();
</script>
</body>
</html>
