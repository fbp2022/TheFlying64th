<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>The Flying 64th â€“ Calendar</title>
  <meta name="description" content="Member booking calendar for The Flying 64th Flying Club at Oliver Springs Airport (Braden Field)." />

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#0b1117;
      --ink:#e6edf3;
      --muted:#9fb1c3;
      --panel:#0f1722;
      --rule:#1f2a38;
      --accent:#58a6ff;
      --accent-soft:#374151;
      --card:#0f1722cc;
      --shadow:0 10px 30px rgba(0,0,0,.35);
      --radius:16px;

      --your:#22c55e;
      --other:#3b82f6;
      --maint:#ef4444;
    }

    *{box-sizing:border-box}
    html,body{margin:0;height:100%}
    body{
      font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;
      background:var(--bg);
      color:var(--ink);
      line-height:1.6;
    }

    /* ===== NAV (shared with home) ===== */
    .site-header{
      position:sticky;
      top:0;
      z-index:50;
      backdrop-filter:saturate(160%) blur(8px);
      background:rgba(11,17,23,.85);
      border-bottom:1px solid var(--rule);
    }
    .nav{
      max-width:1200px;
      margin:0 auto;
      padding:10px 18px;
      display:flex;
      align-items:center;
      gap:12px;
    }
    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      font-weight:800;
      letter-spacing:.2px;
      color:var(--ink);
      text-decoration:none;
      font-size:22px;
      white-space:nowrap;
    }
    .brand img{height:34px;width:auto}

    nav.links{
      display:flex;
      align-items:center;
      gap:18px;
      flex-wrap:nowrap;
      margin-left:auto;
    }
    nav.links a{
      color:var(--muted);
      text-decoration:none;
      padding:8px 12px;
      border-radius:10px;
      transition:all .18s ease;
      white-space:nowrap;
    }
    nav.links a:hover{
      color:var(--ink);
      background:rgba(255,255,255,.06);
    }
    nav.links a.active{
      color:#001a33;
      background:var(--accent);
      font-weight:700;
    }
    .btn{
      border:1px solid rgba(255,255,255,.16);
      background:#0c1020;
      color:#eaf2ff;
      padding:8px 12px;
      border-radius:10px;
      font-weight:600;
      cursor:pointer;
      text-decoration:none;
      white-space:nowrap;
    }
    .btn.primary{
      background:linear-gradient(180deg,#2b6bb1,#1c4370);
      border:1px solid #2b6bb1;
      color:#eaf2ff;
    }

    .hamburger{
      display:none;
      margin-left:auto;
      background:none;
      border:1px solid rgba(255,255,255,.16);
      color:var(--ink);
      padding:6px 10px;
      border-radius:10px;
      cursor:pointer;
      font-size:18px;
    }

    @media (max-width:900px){
      .nav{position:relative}
      nav.links{
        display:none;
        position:absolute;
        top:100%;
        left:10px;
        right:10px;
        margin-top:8px;
        flex-direction:column;
        gap:10px;
        padding:10px;
        background:#0f1722;
        border-radius:12px;
        border:1px solid var(--rule);
      }
      nav.links.open{display:flex;}
      nav.links a{width:100%;text-align:left;}
      .hamburger{display:inline-flex;}
    }

    /* ===== LAYOUT ===== */
    main{
      max-width:1200px;
      margin:18px auto 40px;
      padding:0 18px;
      display:flex;
      flex-direction:column;
      gap:14px;
    }

    .card{
      background:var(--card);
      border:1px solid var(--rule);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:16px 16px 14px;
    }
    .card h2{
      margin:0 0 8px;
      font-size:1.1rem;
    }
    .muted{color:var(--muted);font-size:.9rem;}

    /* Tach cards */
    .tach-wrap{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      margin-top:10px;
    }
    .tach-card{
      flex:1 1 180px;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--rule);
      background:#050812;
      font-size:.9rem;
    }
    .tach-title{font-weight:600;margin-bottom:4px;}
    .tach-row{display:flex;justify-content:space-between;font-size:.85rem;}

    .legend{
      display:flex;
      gap:10px;
      margin-top:10px;
      font-size:.8rem;
      align-items:center;
      flex-wrap:wrap;
    }
    .legend span{
      display:inline-flex;
      align-items:center;
      gap:6px;
    }
    .dot{
      width:10px;
      height:10px;
      border-radius:999px;
      display:inline-block;
    }
    .dot.your{background:var(--your);}
    .dot.other{background:var(--other);}
    .dot.maint{background:var(--maint);}

    /* ===== FILTERS BAR ===== */
    .filters{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
    }
    .filter-group{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
    }
    .pill{
      padding:5px 10px;
      border-radius:999px;
      border:1px solid var(--rule);
      background:#050812;
      color:var(--muted);
      font-size:.8rem;
      cursor:pointer;
    }
    .pill.active{
      border-color:var(--accent);
      color:var(--ink);
      background:#0b1120;
    }

    /* ===== CALENDAR (MONTH GRID) ===== */
    .cal-shell{
      background:var(--card);
      border-radius:var(--radius);
      border:1px solid var(--rule);
      box-shadow:var(--shadow);
      padding:14px 16px 18px;
    }
    .cal-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:10px;
      gap:12px;
      flex-wrap:wrap;
    }
    .cal-month{
      font-weight:700;
      font-size:1.05rem;
    }
    .cal-nav{
      display:flex;
      gap:6px;
      align-items:center;
    }
    .cal-nav button{
      border-radius:999px;
      border:1px solid var(--rule);
      background:#050812;
      color:var(--ink);
      padding:4px 8px;
      font-size:.8rem;
      cursor:pointer;
    }
    .cal-nav button.primary{
      background:var(--accent);
      border-color:transparent;
      color:#001a33;
      font-weight:600;
    }

    .weekday-row{
      display:grid;
      grid-template-columns:repeat(7,1fr);
      font-size:.8rem;
      color:var(--muted);
      padding:4px 2px 4px;
      border-bottom:1px solid var(--rule);
    }
    .weekday-row div{
      text-align:right;
      padding-right:6px;
    }

    .month-grid{
      display:grid;
      grid-template-columns:repeat(7,1fr);
      grid-auto-rows:120px;
      gap:0;
      font-size:.8rem;
    }
    @media (max-width:800px){
      .month-grid{grid-auto-rows:90px;}
    }
    @media (max-width:640px){
      .month-grid{grid-auto-rows:80px;}
    }

    .day-cell{
      border-right:1px solid var(--rule);
      border-bottom:1px solid var(--rule);
      padding:4px 4px 2px;
      position:relative;
      cursor:pointer;
      overflow:hidden;
    }
    .day-cell:nth-child(7n){
      border-right:none;
    }
    .day-num{
      text-align:right;
      font-size:.8rem;
      color:var(--muted);
      margin-bottom:2px;
    }
    .day-cell.other-month .day-num{
      opacity:.4;
    }
    .day-cell.today{
      box-shadow:0 0 0 1px var(--accent) inset;
    }

    .event-pill{
      font-size:.74rem;
      border-radius:999px;
      padding:2px 6px;
      margin-bottom:2px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      background:var(--other);
      color:#001021;
    }
    .event-your{
      background:var(--your);
      color:#001b0a;
    }
    .event-maint{
      background:var(--maint);
      color:#1f0202;
    }

    /* ===== MODAL ===== */
    .modal-backdrop{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.55);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:80;
    }
    .modal-backdrop.open{display:flex;}

    .modal{
      width:min(860px,96vw);
      max-height:92vh;
      background:#050812;
      border-radius:18px;
      border:1px solid var(--rule);
      box-shadow:0 24px 60px rgba(0,0,0,.7);
      display:flex;
      flex-direction:column;
    }
    .modal-header{
      padding:14px 18px 10px;
      border-bottom:1px solid var(--rule);
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:8px;
    }
    .modal-title{font-weight:700;font-size:1rem;}
    .modal-close{
      border:0;
      background:none;
      color:var(--muted);
      font-size:18px;
      cursor:pointer;
    }
    .modal-body{
      padding:14px 18px 16px;
      overflow-y:auto;
    }
    .modal-footer{
      padding:10px 18px 12px;
      border-top:1px solid var(--rule);
      display:flex;
      justify-content:flex-end;
      gap:8px;
      flex-wrap:wrap;
    }

    .form-grid{
      display:grid;
      grid-template-columns:repeat(2,minmax(0,1fr));
      gap:12px 14px;
    }
    @media (max-width:720px){
      .form-grid{grid-template-columns:1fr;}
    }
    .form-field{
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    .label{
      font-size:.78rem;
      color:var(--muted);
    }
    .input,
    .select{
      border-radius:10px;
      border:1px solid var(--rule);
      background:#020617;
      color:var(--ink);
      padding:8px 9px;
      font-size:.85rem;
      width:100%;
    }
    .input:focus,
    .select:focus{
      outline:none;
      border-color:var(--accent);
    }
    .row-inline{
      display:flex;
      gap:6px;
      align-items:center;
    }
    .icon-btn{
      border-radius:10px;
      border:1px solid var(--rule);
      background:#020617;
      color:var(--ink);
      padding:6px 8px;
      cursor:pointer;
      font-size:.8rem;
    }

    .time-chips{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      margin-top:4px;
    }
    .time-chip{
      border-radius:999px;
      border:1px solid var(--rule);
      padding:2px 6px;
      font-size:.72rem;
      cursor:pointer;
      background:#020617;
      color:var(--muted);
    }
    .time-chip:hover{
      border-color:var(--accent);
      color:var(--ink);
    }

    textarea.input{
      min-height:70px;
      resize:vertical;
    }

    .danger{
      background:#7f1d1d;
      border-color:#b91c1c;
      color:#fee2e2;
    }

    .hint-text{
      font-size:.78rem;
      color:var(--muted);
      margin-top:3px;
    }
  </style>
</head>
<body>

<header class="site-header">
  <div class="nav">
    <a class="brand" href="home.html">
      <img src="images/flying64thlogo.png" alt="The Flying 64th Logo" style="width:80px;height:auto;">
      <span>The Flying 64th</span>
    </a>

    <button class="hamburger" id="navToggle" aria-label="Toggle navigation">â˜°</button>

    <nav class="links" id="mainNav">
      <a href="home.html">Home</a>
      <a class="active" href="calendar.html">Calendar</a>
      <a href="becomeamember.html">Become a Member</a>
      <a href="photos.html">Photos</a>
      <a href="members.html">Members</a>
      <a href="poh&manuals.html">POH &amp; Manuals</a>
    </nav>
  </div>
</header>

<main>
  <!-- TOP REMINDER BAR -->
  <section class="card">
    <h2>Reminder</h2>
    <p class="muted">
      Enter <strong>Tach</strong> start &amp; end after every flight.
      If the prior end is missing, you'll be prompted to resolve it before closing your flight.
    </p>

    <div id="statusCards" class="tach-wrap">
      <!-- aircraftStatus cards injected here -->
    </div>

    <div class="legend">
      <span><span class="dot your"></span>Your bookings</span>
      <span><span class="dot other"></span>Other members</span>
      <span><span class="dot maint"></span>Maintenance</span>
    </div>
  </section>

  <!-- FILTERS + NEW BOOKING -->
  <section class="card">
    <div class="filters">
      <div class="filter-group">
        <button class="pill active" data-aircraft="all">All</button>
        <button class="pill" data-aircraft="N78710">N78710 â€” C172</button>
        <button class="pill" data-aircraft="N10921">N10921 â€” C150</button>
      </div>
      <div>
        <button id="newBookingBtn" class="btn primary">+ New booking</button>
      </div>
    </div>
  </section>

  <!-- CALENDAR -->
  <section class="cal-shell">
    <div class="cal-header">
      <div class="cal-month" id="monthLabel">Month YYYY</div>
      <div class="cal-nav">
        <button id="monthOnlyLabel" style="opacity:.75;font-size:.72rem;border-radius:6px;">
          Month view only for now
        </button>
        <button id="prevMonthBtn">&lt;</button>
        <button id="todayBtn" class="primary">Today</button>
        <button id="nextMonthBtn">&gt;</button>
      </div>
    </div>

    <div class="weekday-row">
      <div>Sun</div><div>Mon</div><div>Tue</div>
      <div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div>
    </div>
    <div id="monthGrid" class="month-grid"></div>
  </section>
</main>

<!-- BOOKING MODAL -->
<div id="bookingModalBackdrop" class="modal-backdrop" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true">
    <div class="modal-header">
      <div class="modal-title" id="bookingModalTitle">New booking</div>
      <button class="modal-close" id="bookingCloseBtn" aria-label="Close">âœ•</button>
    </div>
    <div class="modal-body">
      <div class="form-grid">
        <div class="form-field">
          <label class="label" for="aircraftSelect">Aircraft</label>
          <select id="aircraftSelect" class="select">
            <option value="N78710">N78710 â€” C172</option>
            <option value="N10921">N10921 â€” C150</option>
          </select>
        </div>

        <div class="form-field">
          <label class="label" for="titleSelect">Title / purpose</label>
          <select id="titleSelect" class="select">
            <option value="Training">Training</option>
            <option value="Rental">Rental</option>
            <option value="Checkride Prep">Checkride Prep</option>
            <option value="Checkride">Checkride</option>
            <option value="Maintenance">Maintenance</option>
          </select>
        </div>

        <div class="form-field">
          <label class="label">Start date</label>
          <div class="row-inline">
            <input id="startDateInput" type="date" class="input">
            <button type="button" class="icon-btn" id="startDateIcon">ðŸ“…</button>
          </div>
        </div>

        <div class="form-field">
          <label class="label">End date</label>
          <div class="row-inline">
            <input id="endDateInput" type="date" class="input">
            <button type="button" class="icon-btn" id="endDateIcon">ðŸ“…</button>
          </div>
        </div>

        <div class="form-field">
          <label class="label">Time window â€“ from</label>
          <div class="row-inline">
            <input id="startTimeInput" type="time" class="input">
            <button type="button" class="icon-btn" id="startTimeIcon">ðŸ•’</button>
          </div>
          <div class="hint-text">Leave blank for all-day booking.</div>
        </div>

        <div class="form-field">
          <label class="label">Time window â€“ to</label>
          <div class="row-inline">
            <input id="endTimeInput" type="time" class="input">
            <button type="button" class="icon-btn" id="endTimeIcon">ðŸ•’</button>
          </div>
          <div class="time-chips" id="quickTimesRow"></div>
        </div>

        <div class="form-field">
          <label class="label">First name</label>
          <input id="firstNameInput" class="input" type="text" readonly>
        </div>

        <div class="form-field">
          <label class="label">Last name</label>
          <input id="lastNameInput" class="input" type="text" readonly>
        </div>

        <div class="form-field">
          <label class="label">Email (from your account)</label>
          <input id="emailInput" class="input" type="email" readonly>
        </div>

        <div class="form-field">
          <label class="label" for="instructorSelect">Instructor</label>
          <select id="instructorSelect" class="select">
            <option value="">N/A</option>
          </select>
          <div class="hint-text" id="instructorEmailDisplay"></div>
        </div>

        <div class="form-field">
          <label class="label">Tach start</label>
          <input id="tachStartInput" class="input" type="text">
        </div>

        <div class="form-field">
          <label class="label">Tach end</label>
          <input id="tachEndInput" class="input" type="text">
        </div>

        <div class="form-field" style="grid-column:1 / -1;">
          <label class="label">Comments</label>
          <textarea id="commentsInput" class="input"></textarea>
        </div>
      </div>
      <div class="hint-text" id="bookingError" style="color:#fecaca;margin-top:8px;"></div>
    </div>
    <div class="modal-footer">
      <button id="deleteBookingBtn" class="btn danger" style="display:none;">Delete booking</button>
      <div style="flex:1;"></div>
      <button id="cancelBookingBtn" class="btn">Cancel</button>
      <button id="saveBookingBtn" class="btn primary">Save</button>
    </div>
  </div>
</div>

<script type="module">
  /* ========== NAV HAMBURGER ========== */
  (function(){
    const navToggle = document.getElementById('navToggle');
    const mainNav  = document.getElementById('mainNav');
    navToggle?.addEventListener('click', ()=> mainNav.classList.toggle('open'));
    mainNav?.querySelectorAll('a').forEach(a=>{
      a.addEventListener('click', ()=> mainNav.classList.remove('open'));
    });
  })();

  /* ========== FIREBASE IMPORTS ========== */
  import {
    app,
    auth,
    db,
    onAuthChanged,
    getMyRole
  } from './auth.js';

  import {
    collection,
    query,
    onSnapshot,
    getDocs,
    doc,
    getDoc,
    setDoc,
    updateDoc,
    deleteDoc,
    serverTimestamp
  } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";

  /* ========== GLOBAL STATE ========== */
  let currentUser = null;
  let currentRole = null;
  let isAdmin = false;

  let viewYear, viewMonth;
  let bookings = [];
  let aircraftFilter = "all";
  let instructors = [];
  let selectedBookingId = null;

  /* DOM refs */
  const statusCardsEl   = document.getElementById('statusCards');
  const monthLabelEl    = document.getElementById('monthLabel');
  const monthGridEl     = document.getElementById('monthGrid');
  const filterPills     = [...document.querySelectorAll('.pill[data-aircraft]')];
  const newBookingBtn   = document.getElementById('newBookingBtn');
  const prevMonthBtn    = document.getElementById('prevMonthBtn');
  const nextMonthBtn    = document.getElementById('nextMonthBtn');
  const todayBtn        = document.getElementById('todayBtn');

  const modalBackdrop   = document.getElementById('bookingModalBackdrop');
  const modalTitleEl    = document.getElementById('bookingModalTitle');
  const bookingCloseBtn = document.getElementById('bookingCloseBtn');
  const cancelBookingBtn= document.getElementById('cancelBookingBtn');
  const saveBookingBtn  = document.getElementById('saveBookingBtn');
  const deleteBookingBtn= document.getElementById('deleteBookingBtn');
  const bookingErrorEl  = document.getElementById('bookingError');

  const aircraftSelect  = document.getElementById('aircraftSelect');
  const titleSelect     = document.getElementById('titleSelect');
  const startDateInput  = document.getElementById('startDateInput');
  const endDateInput    = document.getElementById('endDateInput');
  const startTimeInput  = document.getElementById('startTimeInput');
  const endTimeInput    = document.getElementById('endTimeInput');
  const startDateIcon   = document.getElementById('startDateIcon');
  const endDateIcon     = document.getElementById('endDateIcon');
  const startTimeIcon   = document.getElementById('startTimeIcon');
  const endTimeIcon     = document.getElementById('endTimeIcon');

  const firstNameInput  = document.getElementById('firstNameInput');
  const lastNameInput   = document.getElementById('lastNameInput');
  const emailInput      = document.getElementById('emailInput');

  const instructorSelect= document.getElementById('instructorSelect');
  const instructorEmailDisplay = document.getElementById('instructorEmailDisplay');

  const tachStartInput  = document.getElementById('tachStartInput');
  const tachEndInput    = document.getElementById('tachEndInput');
  const commentsInput   = document.getElementById('commentsInput');

  const quickTimesRow   = document.getElementById('quickTimesRow');

  /* ========== UTILITIES ========== */
  const pad = (n)=> String(n).padStart(2,'0');
  const dateKey = (d)=> `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;

  function parseDateStr(str){
    if(!str) return null;
    const [y,m,d] = str.split('-').map(Number);
    if(!y || !m || !d) return null;
    return new Date(y,m-1,d);
  }

  function isSameDay(a,b){
    return a.getFullYear() === b.getFullYear() &&
           a.getMonth() === b.getMonth() &&
           a.getDate() === b.getDate();
  }

  function openModal(){
    modalBackdrop.classList.add('open');
    modalBackdrop.setAttribute('aria-hidden','false');
  }
  function closeModal(){
    modalBackdrop.classList.remove('open');
    modalBackdrop.setAttribute('aria-hidden','true');
    selectedBookingId = null;
    bookingErrorEl.textContent = "";
  }

  function setViewToToday(){
    const now = new Date();
    viewYear = now.getFullYear();
    viewMonth = now.getMonth();
    renderMonth();
  }

  function ensureEndAfterStart(){
    const s = parseDateStr(startDateInput.value);
    const e = parseDateStr(endDateInput.value);
    if(!s || !e) return;
    if(e < s){
      endDateInput.value = startDateInput.value;
    }
  }

  /* ========== QUICK TIME CHIPS ========== */
  (function initQuickTimes(){
    const times = ["08:00","09:00","10:00","11:00","12:00","13:00","14:00","15:00","16:00","17:00","18:00","19:00","20:00"];
    times.forEach(t=>{
      const chip = document.createElement('button');
      chip.type = "button";
      chip.className = "time-chip";
      chip.textContent = t;
      chip.addEventListener('click', ()=> { endTimeInput.value = t; });
      quickTimesRow.appendChild(chip);
    });
  })();

  /* ========== AIRCRAFT STATUS ========== */
  function subscribeAircraftStatus(){
    const qStatus = query(collection(db,"aircraftStatus"));
    onSnapshot(qStatus, (snap)=>{
      statusCardsEl.innerHTML = "";
      snap.forEach(docSnap=>{
        const d = docSnap.data();
        const div = document.createElement('div');
        div.className = "tach-card";
        div.innerHTML = `
          <div class="tach-title">${docSnap.id}</div>
          <div class="tach-row"><span>Tach:</span><span>${d.currentTach ?? 'â€”'}</span></div>
          <div style="margin-top:4px;font-size:.75rem;color:var(--muted);">
            Last updated: ${d.updatedAt?.toDate ? d.updatedAt.toDate().toLocaleString() : 'â€”'}
          </div>
        `;
        statusCardsEl.appendChild(div);
      });
    });
  }

  /* ========== INSTRUCTORS ========== */
  async function loadInstructors(){
    instructors = [];
    try{
      const snap = await getDocs(collection(db,"instructors"));
      snap.forEach(docSnap=>{
        const data = docSnap.data() || {};
        Object.entries(data).forEach(([name,email])=>{
          if(!name || !email) return;
          instructors.push({name,email});
        });
      });
    }catch(e){
      console.warn("instructors error:", e);
    }
    instructorSelect.innerHTML = `<option value="">N/A</option>`;
    instructors.forEach(i=>{
      const opt = document.createElement('option');
      opt.value = i.email;
      opt.textContent = i.name;
      instructorSelect.appendChild(opt);
    });
  }

  instructorSelect.addEventListener('change', ()=>{
    const email = instructorSelect.value || "";
    const inst = instructors.find(i => i.email === email);
    instructorEmailDisplay.textContent = inst ? inst.email : "";
  });

  /* ========== BOOKINGS LOAD / RENDER ========== */

  function bookingMatchesDateAndFilter(booking, dayDate){
    if(aircraftFilter !== "all" && booking.aircraft !== aircraftFilter) return false;

    const s = parseDateStr(booking.startDate);
    const e = parseDateStr(booking.endDate || booking.startDate);
    if(!s || !e) return false;

    const dayKey = dateKey(dayDate);
    const startKey = dateKey(s);
    const endKey = dateKey(e);

    return dayKey >= startKey && dayKey <= endKey;
  }

  function renderMonth(){
    if(viewYear == null || viewMonth == null) return;

    const monthName = new Date(viewYear, viewMonth, 1).toLocaleString(undefined, {
      month:"long",
      year:"numeric"
    });
    monthLabelEl.textContent = monthName;

    monthGridEl.innerHTML = "";

    const firstOfMonth = new Date(viewYear, viewMonth, 1);
    const startWeekday = firstOfMonth.getDay(); // 0=Sun

    // Start from the Sunday of the first week that contains day 1
    const startDate = new Date(viewYear, viewMonth, 1 - startWeekday);

    const today = new Date();
    for(let i = 0; i < 42; i++){
      const d = new Date(startDate);
      d.setDate(startDate.getDate() + i);

      const cell = document.createElement('div');
      cell.className = "day-cell";

      if(d.getMonth() !== viewMonth){
        cell.classList.add('other-month');
      }
      if(isSameDay(d, today)){
        cell.classList.add('today');
      }

      const dayNum = document.createElement('div');
      dayNum.className = "day-num";
      dayNum.textContent = d.getDate();
      cell.appendChild(dayNum);

      const dayBookings = bookings.filter(b => bookingMatchesDateAndFilter(b, d));

      dayBookings.forEach(b=>{
        const pill = document.createElement('div');
        pill.className = "event-pill";

        if(b.title === "Maintenance"){
          pill.classList.add('event-maint');
        }else if(currentUser && b.uid === currentUser.uid){
          pill.classList.add('event-your');
        }

        const who = b.firstName || (b.email || "").split("@")[0] || "Member";
        const labelAircraft = b.aircraft || "";
        const labelTitle = b.title || "";
        pill.textContent = `${labelAircraft} â€“ ${labelTitle} (${who})`;

        pill.addEventListener('click',(e)=>{
          e.stopPropagation();
          openEditBooking(b);
        });

        cell.appendChild(pill);
      });

      cell.dataset.date = dateKey(d);
      cell.addEventListener('click', ()=>{
        openNewBookingFromDay(d);
      });

      monthGridEl.appendChild(cell);
    }
  }

  function subscribeBookings(){
    const qBookings = query(collection(db,"bookings"));
    onSnapshot(qBookings,(snap)=>{
      bookings = [];
      snap.forEach(docSnap=>{
        bookings.push({
          id: docSnap.id,
          ...docSnap.data()
        });
      });
      renderMonth(); // ensure calendar updates whenever bookings change
    });
  }

  function openNewBookingFromDay(dateObj){
    clearBookingForm();
    selectedBookingId = null;
    modalTitleEl.textContent = "New booking";

    const dStr = dateKey(dateObj);
    startDateInput.value = dStr;
    endDateInput.value = dStr;

    // Pre-fill aircraft if a filter is applied
    if(aircraftFilter !== "all"){
      aircraftSelect.value = aircraftFilter;
    }else{
      aircraftSelect.value = "N78710";
    }

    deleteBookingBtn.style.display = "none";
    bookingErrorEl.textContent = "";
    saveBookingBtn.disabled = false;
    openModal();
  }

  function clearBookingForm(){
    aircraftSelect.value = "N78710";
    titleSelect.value = "Training";

    const todayStr = dateKey(new Date());
    startDateInput.value = todayStr;
    endDateInput.value = todayStr;

    startTimeInput.value = "";
    endTimeInput.value = "";

    tachStartInput.value = "";
    tachEndInput.value = "";
    commentsInput.value = "";

    instructorSelect.value = "";
    instructorEmailDisplay.textContent = "";
    bookingErrorEl.textContent = "";
  }

  function openEditBooking(booking){
    clearBookingForm();
    selectedBookingId = booking.id;
    modalTitleEl.textContent = "Edit booking";

    aircraftSelect.value = booking.aircraft || "N78710";
    titleSelect.value = booking.title || "Training";

    startDateInput.value = booking.startDate || "";
    endDateInput.value = booking.endDate || booking.startDate || "";

    startTimeInput.value = booking.startTime || "";
    endTimeInput.value   = booking.endTime || "";

    firstNameInput.value = booking.firstName || firstNameInput.value;
    lastNameInput.value  = booking.lastName || lastNameInput.value;
    emailInput.value     = booking.email || emailInput.value;

    instructorSelect.value = booking.instructorEmail || "";
    const inst = instructors.find(i => i.email === booking.instructorEmail);
    instructorEmailDisplay.textContent = inst ? inst.email : "";

    tachStartInput.value  = booking.tachStart || "";
    tachEndInput.value    = booking.tachEnd || "";
    commentsInput.value   = booking.comments || "";

    const canDelete = currentUser && (isAdmin || booking.uid === currentUser.uid);
    deleteBookingBtn.style.display = canDelete ? "inline-flex" : "none";

    bookingErrorEl.textContent = "";
    saveBookingBtn.disabled = false;
    openModal();
  }

  /* ========== SAVE / DELETE HANDLERS ========== */

  function collectBookingForm(){
    const aircraft = aircraftSelect.value || "N78710";
    const title = titleSelect.value || "Training";

    const startDate = startDateInput.value;
    let endDate = endDateInput.value || startDate;

    if(!startDate){
      throw new Error("Start date is required.");
    }

    const s = parseDateStr(startDate);
    const e = parseDateStr(endDate);
    if(!s || !e){
      throw new Error("Invalid start or end date.");
    }
    if(e < s){
      endDate = startDate;
    }

    const startTime = startTimeInput.value || "";
    const endTime = endTimeInput.value || "";

    if(startTime && endTime && endDate === startDate && endTime < startTime){
      throw new Error("End time cannot be earlier than start time.");
    }

    const tachStart = tachStartInput.value.trim();
    const tachEnd   = tachEndInput.value.trim();

    if((tachStart && !tachEnd) || (!tachStart && tachEnd)){
      throw new Error("Please enter both Tach start and Tach end or leave both blank.");
    }

    const instructorEmail = instructorSelect.value || "";

    return {
      aircraft,
      title,
      startDate,
      endDate,
      startTime,
      endTime,
      firstName: firstNameInput.value || "",
      lastName: lastNameInput.value || "",
      email: emailInput.value || (currentUser ? currentUser.email : ""),
      uid: currentUser ? currentUser.uid : null,
      instructorEmail,
      tachStart: tachStart || null,
      tachEnd: tachEnd || null,
      comments: commentsInput.value || ""
    };
  }

  async function handleSaveBooking(){
    if(!currentUser){
      bookingErrorEl.textContent = "You must be signed in to create or edit a booking.";
      return;
    }

    try{
      bookingErrorEl.textContent = "";
      saveBookingBtn.disabled = true;

      const data = collectBookingForm();

      if(selectedBookingId){
        const ref = doc(db,"bookings",selectedBookingId);
        await updateDoc(ref,{
          ...data,
          updatedAt: serverTimestamp()
        });
      }else{
        const ref = doc(collection(db,"bookings"));
        await setDoc(ref,{
          ...data,
          createdAt: serverTimestamp(),
          updatedAt: serverTimestamp()
        });
      }

      closeModal();
    }catch(err){
      console.error("Booking save error:", err);
      bookingErrorEl.textContent = err?.message || "Failed to save booking. Please try again.";
      saveBookingBtn.disabled = false;
    }
  }

  async function handleDeleteBooking(){
    if(!selectedBookingId) return;
    if(!currentUser){
      bookingErrorEl.textContent = "You must be signed in to delete a booking.";
      return;
    }

    const confirmDelete = window.confirm("Delete this booking? This cannot be undone.");
    if(!confirmDelete) return;

    try{
      bookingErrorEl.textContent = "";
      deleteBookingBtn.disabled = true;
      const ref = doc(db,"bookings",selectedBookingId);
      await deleteDoc(ref);
      closeModal();
    }catch(err){
      console.error("Delete booking error:", err);
      bookingErrorEl.textContent = err?.message || "Failed to delete booking. Check your permissions.";
      deleteBookingBtn.disabled = false;
    }
  }

  /* ========== AUTH INIT + PAGE BOOTSTRAP ========== */

  async function loadProfileNames(user){
    try{
      const profileRef = doc(db,"profiles",user.uid);
      const profileSnap = await getDoc(profileRef);
      if(profileSnap.exists()){
        const p = profileSnap.data() || {};
        if(p.firstName) firstNameInput.value = p.firstName;
        if(p.lastName)  lastNameInput.value  = p.lastName;
        if(p.email)     emailInput.value     = p.email;
        return;
      }
    }catch(e){
      console.warn("profile load error:", e);
    }

    const dn = user.displayName || "";
    if(dn){
      const [fn, ...rest] = dn.split(" ");
      firstNameInput.value = fn || "";
      lastNameInput.value  = rest.join(" ") || "";
    }
    emailInput.value = user.email || "";
  }

  onAuthChanged(async (user)=>{
    if(!user){
      window.location.href = "signin.html";
      return;
    }

    currentUser = user;
    await loadProfileNames(user);

    try{
      currentRole = await getMyRole(user.uid);
      isAdmin = currentRole === "owner" || currentRole === "admin";
    }catch(e){
      console.warn("role load error:", e);
    }

    subscribeAircraftStatus();
    loadInstructors();
    subscribeBookings();
    setViewToToday();
  });

  /* ========== EVENT WIRING ========== */

  // Month nav
  prevMonthBtn.addEventListener('click', ()=>{
    if(viewMonth == null) return;
    viewMonth--;
    if(viewMonth < 0){
      viewMonth = 11;
      viewYear--;
    }
    renderMonth();
  });

  nextMonthBtn.addEventListener('click', ()=>{
    if(viewMonth == null) return;
    viewMonth++;
    if(viewMonth > 11){
      viewMonth = 0;
      viewYear++;
    }
    renderMonth();
  });

  todayBtn.addEventListener('click', ()=>{
    setViewToToday();
  });

  // Filters
  filterPills.forEach(pill=>{
    pill.addEventListener('click', ()=>{
      filterPills.forEach(p => p.classList.remove('active'));
      pill.classList.add('active');
      aircraftFilter = pill.dataset.aircraft || "all";
      renderMonth();
    });
  });

  // New booking
  newBookingBtn.addEventListener('click', ()=>{
    const baseDate = new Date();
    openNewBookingFromDay(baseDate);
  });

  // Date / time icon helpers
  startDateIcon.addEventListener('click', ()=> startDateInput.focus());
  endDateIcon.addEventListener('click', ()=> endDateInput.focus());
  startTimeIcon.addEventListener('click', ()=> startTimeInput.focus());
  endTimeIcon.addEventListener('click', ()=> endTimeInput.focus());

  startDateInput.addEventListener('change', ensureEndAfterStart);
  endDateInput.addEventListener('change', ensureEndAfterStart);

  // Modal buttons
  bookingCloseBtn.addEventListener('click', closeModal);
  cancelBookingBtn.addEventListener('click', closeModal);
  saveBookingBtn.addEventListener('click', handleSaveBooking);
  deleteBookingBtn.addEventListener('click', handleDeleteBooking);

  modalBackdrop.addEventListener('click', (e)=>{
    if(e.target === modalBackdrop){
      closeModal();
    }
  });
</script>
</body>
</html>
