<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>The Flying 64th â€“ Calendar</title>
  <meta name="description" content="Member booking calendar for The Flying 64th Flying Club at Oliver Springs Airport (Braden Field)." />

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#0b1117;
      --ink:#e6edf3;
      --muted:#9fb1c3;
      --panel:#0f1722;
      --rule:#1f2a38;
      --accent:#58a6ff;
      --accent-soft:#374151;
      --card:#0f1722cc;
      --shadow:0 10px 30px rgba(0,0,0,.35);
      --radius:16px;

      --your:#22c55e;
      --other:#3b82f6;
      --maint:#ef4444;
      --board:#a855f7;
    }

    *{box-sizing:border-box}
    html,body{margin:0;height:100%}
    body{
      font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;
      background:var(--bg);
      color:var(--ink);
      line-height:1.6;
    }

    /* ===== NAV ===== */
    .site-header{
      position:sticky;
      top:0;
      z-index:50;
      backdrop-filter:saturate(160%) blur(8px);
      background:rgba(11,17,23,.85);
      border-bottom:1px solid var(--rule);
    }
    .nav{
      max-width:1200px;
      margin:0 auto;
      padding:10px 18px;
      display:flex;
      align-items:center;
      gap:12px;
    }
    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      font-weight:800;
      letter-spacing:.2px;
      color:var(--ink);
      text-decoration:none;
      font-size:22px;
      white-space:nowrap;
    }
    .brand img{height:34px;width:auto}

    nav.links{
      display:flex;
      align-items:center;
      gap:18px;
      flex-wrap:nowrap;
      margin-left:auto;
    }
    nav.links a{
      color:var(--muted);
      text-decoration:none;
      padding:8px 12px;
      border-radius:10px;
      transition:all .18s ease;
      white-space:nowrap;
    }
    nav.links a:hover{
      color:var(--ink);
      background:rgba(255,255,255,.06);
    }
    nav.links a.active{
      color:#001a33;
      background:var(--accent);
      font-weight:700;
    }

    .btn{
      border:1px solid rgba(255,255,255,.16);
      background:#0c1020;
      color:#eaf2ff;
      padding:8px 12px;
      border-radius:10px;
      font-weight:600;
      cursor:pointer;
      text-decoration:none;
      white-space:nowrap;
    }
    .btn.primary{
      background:linear-gradient(180deg,#2b6bb1,#1c4370);
      border:1px solid #2b6bb1;
      color:#eaf2ff;
    }

    .hamburger{
      display:none;
      margin-left:auto;
      background:none;
      border:1px solid rgba(255,255,255,.16);
      color:var(--ink);
      padding:6px 10px;
      border-radius:10px;
      cursor:pointer;
      font-size:18px;
    }

    @media (max-width:900px){
      .nav{position:relative}
      nav.links{
        display:none;
        position:absolute;
        top:100%;
        left:10px;
        right:10px;
        margin-top:8px;
        flex-direction:column;
        gap:10px;
        padding:10px;
        background:#0f1722;
        border-radius:12px;
        border:1px solid var(--rule);
      }
      nav.links.open{display:flex;}
      nav.links a{width:100%;text-align:left;}
      #signinBtn{width:100%;text-align:center;}
      .hamburger{display:inline-flex;}
    }

    /* ===== LAYOUT ===== */
    main{
      max-width:1200px;
      margin:18px auto 40px;
      padding:0 18px;
      display:flex;
      flex-direction:column;
      gap:14px;
    }

    .card{
      background:var(--card);
      border:1px solid var(--rule);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:16px 16px 14px;
    }
    .card h2{
      margin:0 0 8px;
      font-size:1.1rem;
    }
    .muted{color:var(--muted);font-size:.9rem;}

    /* Tach cards */
    .tach-wrap{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      margin-top:10px;
    }
    .tach-card{
      flex:1 1 180px;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--rule);
      background:#050812;
      font-size:.9rem;
    }
    .tach-title{font-weight:600;margin-bottom:4px;}
    .tach-row{display:flex;justify-content:space-between;font-size:.85rem;}

    .legend{
      display:flex;
      gap:10px;
      margin-top:10px;
      font-size:.8rem;
      align-items:center;
      flex-wrap:wrap;
    }
    .legend span{
      display:inline-flex;
      align-items:center;
      gap:6px;
    }
    .dot{
      width:10px;
      height:10px;
      border-radius:999px;
      display:inline-block;
    }
    .dot.your{background:var(--your);}
    .dot.other{background:var(--other);}
    .dot.maint{background:var(--maint);}
    .dot.board{background:var(--board);}

    /* ===== FILTERS BAR ===== */
    .filters{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
    }
    .filter-group{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
    }
    .pill{
      padding:5px 10px;
      border-radius:999px;
      border:1px solid var(--rule);
      background:#050812;
      color:var(--muted);
      font-size:.8rem;
      cursor:pointer;
    }
    .pill.active{
      border-color:var(--accent);
      color:var(--ink);
      background:#0b1120;
    }

    /* ===== CALENDAR ===== */
    .cal-shell{
      background:var(--card);
      border-radius:var(--radius);
      border:1px solid var(--rule);
      box-shadow:var(--shadow);
      padding:14px 16px 18px;
    }
    .cal-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:10px;
      gap:12px;
      flex-wrap:wrap;
    }
    .cal-left{
      display:flex;
      flex-wrap:wrap;
      align-items:center;
      gap:8px;
    }
    .cal-month{
      font-weight:700;
      font-size:1.05rem;
    }
    .cal-views{
      display:flex;
      gap:4px;
      flex-wrap:wrap;
    }
    .view-pill{
      border-radius:999px;
      border:1px solid var(--rule);
      background:#050812;
      color:var(--muted);
      font-size:.72rem;
      padding:3px 8px;
      cursor:pointer;
    }
    .view-pill.active{
      border-color:var(--accent);
      color:var(--ink);
      background:#0b1120;
    }

    .cal-nav{
      display:flex;
      gap:6px;
      align-items:center;
      flex-wrap:wrap;
    }
    .cal-nav button{
      border-radius:999px;
      border:1px solid var(--rule);
      background:#050812;
      color:var(--ink);
      padding:4px 8px;
      font-size:.8rem;
      cursor:pointer;
    }
    .cal-nav button.primary{
      background:var(--accent);
      border-color:transparent;
      color:#001a33;
      font-weight:600;
    }

    .weekday-row{
      display:grid;
      grid-template-columns:repeat(7,1fr);
      font-size:.8rem;
      color:var(--muted);
      padding:4px 2px 4px;
      border-bottom:1px solid var(--rule);
    }
    .weekday-row div{
      text-align:right;
      padding-right:6px;
    }

    .month-grid{
      display:grid;
      grid-template-columns:repeat(7,1fr);
      grid-auto-rows:120px;
      gap:0;
      font-size:.8rem;
    }
    @media (max-width:800px){
      .month-grid{grid-auto-rows:90px;}
    }
    @media (max-width:640px){
      .month-grid{grid-auto-rows:80px;}
    }

    .day-cell{
      border-right:1px solid var(--rule);
      border-bottom:1px solid var(--rule);
      padding:4px 4px 2px;
      position:relative;
      cursor:pointer;
      overflow:hidden;
    }
    .day-cell:nth-child(7n){
      border-right:none;
    }
    .day-num{
      text-align:right;
      font-size:.8rem;
      color:var(--muted);
      margin-bottom:2px;
    }
    .day-cell.other-month .day-num{
      opacity:.4;
    }
    .day-cell.today{
      box-shadow:0 0 0 1px var(--accent) inset;
    }

    .event-pill{
      font-size:.74rem;
      border-radius:999px;
      padding:2px 6px;
      margin-bottom:2px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      background:var(--other);
      color:#001021;
    }
    .event-your{
      background:var(--your);
      color:#001b0a;
    }
    .event-maint{
      background:var(--maint);
      color:#1f0202;
    }
    .event-board{
      background:var(--board);
      color:#1f0a2b;
    }

    /* ===== BOOKING MODAL ===== */
    .modal-backdrop{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.55);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:80;
    }
    .modal-backdrop.open{display:flex;}

    .modal{
      width:min(860px,96vw);
      max-height:92vh;
      background:#050812;
      border-radius:18px;
      border:1px solid var(--rule);
      box-shadow:0 24px 60px rgba(0,0,0,.7);
      display:flex;
      flex-direction:column;
    }
    .modal-header{
      padding:14px 18px 10px;
      border-bottom:1px solid var(--rule);
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:8px;
    }
    .modal-title{font-weight:700;font-size:1rem;}
    .modal-close{
      border:0;
      background:none;
      color:var(--muted);
      font-size:18px;
      cursor:pointer;
    }
    .modal-body{
      padding:14px 18px 16px;
      overflow-y:auto;
    }
    .modal-footer{
      padding:10px 18px 12px;
      border-top:1px solid var(--rule);
      display:flex;
      justify-content:flex-end;
      gap:8px;
      flex-wrap:wrap;
    }

    .form-grid{
      display:grid;
      grid-template-columns:repeat(2,minmax(0,1fr));
      gap:12px 14px;
    }
    @media (max-width:720px){
      .form-grid{grid-template-columns:1fr;}
    }
    .form-field{
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    .label{
      font-size:.78rem;
      color:var(--muted);
    }
    .input,
    .select{
      border-radius:10px;
      border:1px solid var(--rule);
      background:#020617;
      color:var(--ink);
      padding:8px 9px;
      font-size:.85rem;
      width:100%;
    }
    .input:focus,
    .select:focus{
      outline:none;
      border-color:var(--accent);
    }
    .row-inline{
      display:flex;
      gap:6px;
      align-items:center;
    }
    .icon-btn{
      border-radius:10px;
      border:1px solid var(--rule);
      background:#020617;
      color:var(--ink);
      padding:6px 8px;
      cursor:pointer;
      font-size:.8rem;
    }

    .time-chips{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      margin-top:4px;
    }
    .time-chip{
      border-radius:999px;
      border:1px solid var(--rule);
      padding:2px 6px;
      font-size:.72rem;
      cursor:pointer;
      background:#020617;
      color:#9fb1c3;
    }
    .time-chip:hover{
      border-color:var(--accent);
      color:var(--ink);
    }

    textarea.input{
      min-height:70px;
      resize:vertical;
    }

    .danger{
      background:#7f1d1d;
      border-color:#b91c1c;
      color:#fee2e2;
    }

    .hint-text{
      font-size:.78rem;
      color:var(--muted);
      margin-top:3px;
    }

    /* ===== AUTH MODAL (same style as home) ===== */
    .auth-modal{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.5);
      display:none;
      place-items:center;
      z-index:1000;
    }
    .auth-modal.open{display:grid;}

    .auth-card{
      width:min(460px,92vw);
      background:#0f1722;
      color:#e6edf3;
      border:1px solid #1f2a38;
      border-radius:14px;
      padding:18px 18px 12px;
      position:relative;
    }
    .auth-title{
      margin:0 0 10px 0;
      font-size:20px;
      font-weight:800;
    }
    .auth-x{
      position:absolute;
      right:14px;
      top:12px;
      border:0;
      background:transparent;
      color:#9fb1c3;
      font-size:18px;
      cursor:pointer;
    }
    .auth-label{
      display:block;
      margin-top:10px;
      margin-bottom:4px;
      color:#9fb1c3;
      font-size:13px;
    }
    .auth-input{
      width:100%;
      padding:10px 12px;
      border-radius:10px;
      border:1px solid #1f2a38;
      background:#0b1117;
      color:#e6edf3;
    }
    .auth-row{
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      margin-top:12px;
    }
    .auth-btn{
      flex:1;
      padding:10px 12px;
      border-radius:10px;
      border:1px solid #1f2a38;
      background:#141b26;
      color:#e6edf3;
      cursor:pointer;
    }
    .auth-btn.primary{
      background:#58a6ff;
      color:#001a33;
      border-color:transparent;
      font-weight:700;
    }
    .auth-link{
      background:none;
      border:0;
      color:#9fb1c3;
      cursor:pointer;
    }
    .auth-msg{
      min-height:18px;
      color:#9fb1c3;
      margin:8px 0 4px;
    }

    .tabs{
      display:flex;
      gap:8px;
      margin-bottom:8px;
    }
    .tab{
      flex:1;
      padding:8px 10px;
      border:1px solid #1f2a38;
      border-radius:10px;
      background:#141b26;
      color:#e6edf3;
      cursor:pointer;
      font-size:14px;
    }
    .tab.active{
      background:#58a6ff;
      color:#001a33;
      font-weight:700;
      border-color:transparent;
    }
    .view{display:none;}
    .view.active{display:block;}
  </style>
</head>
<body>

<header class="site-header">
  <div class="nav">
    <a class="brand" href="home.html">
      <img src="images/flying64thlogo.png" alt="The Flying 64th Logo" style="width:80px;height:auto;">
      <span>The Flying 64th</span>
    </a>

    <button class="hamburger" id="navToggle" aria-label="Toggle navigation">â˜°</button>

    <nav class="links" id="mainNav">
      <a id="signinBtn" class="btn">Sign In</a>
      <a href="home.html">Home</a>
      <a class="active" href="calendar.html">Calendar</a>
      <a href="becomeamember.html">Become a Member</a>
      <a href="photos.html">Photos</a>
      <a href="members.html">Members</a>
      <a href="poh&manuals.html">POH &amp; Manuals</a>
    </nav>
  </div>
</header>

<main>
  <!-- TOP REMINDER BAR -->
  <section class="card">
    <h2>Reminder</h2>
    <p class="muted">
      Enter <strong>Tach</strong> start &amp; end after every flight.
      If the prior end is missing, you'll be prompted to resolve it before closing your flight.
    </p>

    <div id="statusCards" class="tach-wrap">
      <!-- aircraftStatus cards injected here -->
    </div>

    <div class="legend">
      <span><span class="dot your"></span>Your bookings</span>
      <span><span class="dot other"></span>Other members</span>
      <span><span class="dot maint"></span>Maintenance</span>
      <span><span class="dot board"></span>Board meeting</span>
    </div>
  </section>

  <!-- FILTERS + NEW BOOKING -->
  <section class="card">
    <div class="filters">
      <div class="filter-group">
        <button class="pill active" data-aircraft="all">All</button>
        <button class="pill" data-aircraft="N78710">N78710 â€” C172</button>
        <button class="pill" data-aircraft="N10921">N10921 â€” C150</button>
      </div>
      <div>
        <button id="newBookingBtn" class="btn primary">+ New booking</button>
      </div>
    </div>
  </section>

  <!-- CALENDAR -->
  <section class="cal-shell">
    <div class="cal-header">
      <div class="cal-left">
        <div class="cal-month" id="monthLabel">Month YYYY</div>
        <div class="cal-views">
          <button id="viewMonthBtn" class="view-pill active">Month</button>
          <button id="viewWeekBtn" class="view-pill">Week</button>
          <button id="viewDayBtn" class="view-pill">Day</button>
        </div>
      </div>
      <div class="cal-nav">
        <button id="exportMonthBtn" class="btn" style="font-size:.75rem;padding:4px 8px;">Export</button>
        <button id="prevPeriodBtn">&lt;</button>
        <button id="todayBtn" class="primary">Today</button>
        <button id="nextPeriodBtn">&gt;</button>
      </div>
    </div>

    <div class="weekday-row">
      <div>Sun</div><div>Mon</div><div>Tue</div>
      <div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div>
    </div>
    <div id="monthGrid" class="month-grid"></div>
  </section>
</main>

<!-- BOOKING MODAL -->
<div id="bookingModalBackdrop" class="modal-backdrop" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true">
    <div class="modal-header">
      <div class="modal-title" id="bookingModalTitle">New booking</div>
      <button class="modal-close" id="bookingCloseBtn" aria-label="Close">âœ•</button>
    </div>
    <div class="modal-body">
      <div class="form-grid">
        <div class="form-field">
          <label class="label" for="aircraftSelect">Aircraft</label>
          <select id="aircraftSelect" class="select">
            <option value="N78710">N78710 â€” C172</option>
            <option value="N10921">N10921 â€” C150</option>
          </select>
        </div>

        <div class="form-field">
          <label class="label" for="titleSelect">Title / purpose</label>
          <select id="titleSelect" class="select">
            <option value="Training">Training</option>
            <option value="Rental">Rental</option>
            <option value="Checkride Prep">Checkride Prep</option>
            <option value="Checkride">Checkride</option>
            <option value="Maintenance">Maintenance</option>
          </select>
        </div>

        <div class="form-field">
          <label class="label">Start date</label>
          <div class="row-inline">
            <input id="startDateInput" type="date" class="input">
            <button type="button" class="icon-btn" id="startDateIcon">ðŸ“…</button>
          </div>
        </div>

        <div class="form-field">
          <label class="label">End date</label>
          <div class="row-inline">
            <input id="endDateInput" type="date" class="input">
            <button type="button" class="icon-btn" id="endDateIcon">ðŸ“…</button>
          </div>
        </div>

        <div class="form-field">
          <label class="label">Time window â€“ from</label>
          <div class="row-inline">
            <input id="startTimeInput" type="time" class="input">
            <button type="button" class="icon-btn" id="startTimeIcon">ðŸ•’</button>
          </div>
          <div class="hint-text">Leave blank for all-day booking.</div>
        </div>

        <div class="form-field">
          <label class="label">Time window â€“ to</label>
          <div class="row-inline">
            <input id="endTimeInput" type="time" class="input">
            <button type="button" class="icon-btn" id="endTimeIcon">ðŸ•’</button>
          </div>
          <div class="time-chips" id="quickTimesRow"></div>
        </div>

        <div class="form-field">
          <label class="label">First name</label>
          <input id="firstNameInput" class="input" type="text" readonly>
        </div>

        <div class="form-field">
          <label class="label">Last name</label>
          <input id="lastNameInput" class="input" type="text" readonly>
        </div>

        <div class="form-field">
          <label class="label">Email (from your account)</label>
          <input id="emailInput" class="input" type="email" readonly>
        </div>

        <div class="form-field">
          <label class="label" for="instructorSelect">Instructor</label>
          <select id="instructorSelect" class="select">
            <option value="">N/A</option>
          </select>
          <div class="hint-text" id="instructorEmailDisplay"></div>
        </div>

        <div class="form-field">
          <label class="label">Tach start</label>
          <input id="tachStartInput" class="input" type="text">
        </div>

        <div class="form-field">
          <label class="label">Tach end</label>
          <input id="tachEndInput" class="input" type="text">
        </div>

        <div class="form-field" style="grid-column:1 / -1;">
          <label class="label">Comments</label>
          <textarea id="commentsInput" class="input"></textarea>
        </div>
      </div>
      <div class="hint-text" id="bookingError" style="color:#fecaca;margin-top:8px;"></div>
    </div>
    <div class="modal-footer">
      <button id="deleteBookingBtn" class="btn danger" style="display:none;">Delete booking</button>
      <div style="flex:1;"></div>
      <button id="cancelBookingBtn" class="btn">Cancel</button>
      <button id="saveBookingBtn" class="btn primary">Save</button>
    </div>
  </div>
</div>

<!-- AUTH MODAL (same UX as home.html, but wired into auth.js helpers) -->
<div id="authModal" class="auth-modal" aria-hidden="true">
  <div class="auth-card" role="dialog" aria-modal="true" aria-labelledby="authTitle">
    <button id="closeAuth" class="auth-x" aria-label="Close">âœ•</button>

    <div class="tabs">
      <button id="tabSignIn" class="tab active">Sign In</button>
      <button id="tabSignUp" class="tab">Create Account</button>
    </div>

    <!-- Sign In view -->
    <section id="viewSignIn" class="view active" aria-labelledby="authTitle">
      <h3 id="authTitle" class="auth-title">Member Sign In</h3>

      <label class="auth-label" for="si_email">Email</label>
      <input id="si_email" class="auth-input" type="email" placeholder="you@example.com" autocomplete="email">

      <label class="auth-label" for="si_password">Password</label>
      <input id="si_password" class="auth-input" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" autocomplete="current-password">

      <div class="auth-row">
        <button id="doSignIn" class="auth-btn primary">Sign In</button>
      </div>

      <div class="auth-row">
        <button id="doReset" class="auth-link" type="button">Forgot password?</button>
        <button id="signOutBtn" class="auth-link" type="button">Sign out</button>
      </div>

      <p id="authMsg" class="auth-msg"></p>
    </section>

    <!-- Create Account view -->
    <section id="viewSignUp" class="view" aria-labelledby="createTitle">
      <h3 id="createTitle" class="auth-title">Create a New Account</h3>

      <label class="auth-label" for="su_first">First Name</label>
      <input id="su_first" class="auth-input" type="text" placeholder="Your first name" required>

      <label class="auth-label" for="su_last">Last Name</label>
      <input id="su_last" class="auth-input" type="text" placeholder="Your last name" required>

      <label class="auth-label" for="su_email">Email</label>
      <input id="su_email" class="auth-input" type="email" placeholder="you@example.com" autocomplete="email" required>

      <label class="auth-label" for="su_password">Password</label>
      <input id="su_password" class="auth-input" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" autocomplete="new-password" required>

      <label class="auth-label" for="su_invite">Invite Code (new accounts)</label>
      <input id="su_invite" class="auth-input" type="text" placeholder="Board Admin Will Provide Invite Code" required>

      <div class="auth-row">
        <button id="doSignUp" class="auth-btn primary">Create Account</button>
      </div>

      <p id="createMsg" class="auth-msg"></p>
    </section>
  </div>
</div>

<script>
  // Nav highlight + hamburger (reuse home.html behavior)
  (function(){
    const mainNav = document.getElementById('mainNav');
    const current = location.pathname.split('/').pop().toLowerCase();
    document.querySelectorAll('#mainNav a[href]').forEach(a=>{
      let href = (a.getAttribute('href')||'').split('?')[0].toLowerCase();
      href = href.replace(/&amp;/g,'&');
      if(href && href === current) a.classList.add('active');
    });

    const navToggle = document.getElementById('navToggle');
    navToggle?.addEventListener('click', ()=>{
      mainNav.classList.toggle('open');
    });
    mainNav?.querySelectorAll('a').forEach(link=>{
      link.addEventListener('click', ()=> mainNav.classList.remove('open'));
    });
  })();
</script>

<script type="module">
  /* ========== IMPORTS ========== */
  import {
    auth,
    db,
    onAuthChanged,
    getMyRole,
    signInEmailPassword,
    signUpWithInvite,
    resetPassword,
    signOut
  } from './auth.js';

  import {
    collection,
    query,
    onSnapshot,
    getDocs,
    doc,
    getDoc,
    setDoc,
    addDoc,
    updateDoc,
    deleteDoc,
    serverTimestamp
  } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";

  /* ========== GLOBAL STATE ========== */
  let currentUser = null;
  let currentRole = null; // { uid, email, isAdmin, profile, ... }
  let isAdmin = false;

  let viewMode = 'month'; // 'month' | 'week' | 'day'
  let focusDate = new Date();

  let bookings = [];
  let aircraftFilter = "all";
  let instructors = [];
  let selectedBookingId = null;

  let unsubStatus = null;
  let unsubBookings = null;

  let aircraftStatusMap = {};

  /* DOM refs */
  const statusCardsEl   = document.getElementById('statusCards');
  const monthLabelEl    = document.getElementById('monthLabel');
  const monthGridEl     = document.getElementById('monthGrid');

  const filterPills     = [...document.querySelectorAll('.pill[data-aircraft]')];
  const newBookingBtn   = document.getElementById('newBookingBtn');

  const viewMonthBtn    = document.getElementById('viewMonthBtn');
  const viewWeekBtn     = document.getElementById('viewWeekBtn');
  const viewDayBtn      = document.getElementById('viewDayBtn');
  const prevPeriodBtn   = document.getElementById('prevPeriodBtn');
  const nextPeriodBtn   = document.getElementById('nextPeriodBtn');
  const todayBtn        = document.getElementById('todayBtn');
  const exportMonthBtn  = document.getElementById('exportMonthBtn');

  const modalBackdrop   = document.getElementById('bookingModalBackdrop');
  const modalTitleEl    = document.getElementById('bookingModalTitle');
  const bookingCloseBtn = document.getElementById('bookingCloseBtn');
  const cancelBookingBtn= document.getElementById('cancelBookingBtn');
  const saveBookingBtn  = document.getElementById('saveBookingBtn');
  const deleteBookingBtn= document.getElementById('deleteBookingBtn');
  const bookingErrorEl  = document.getElementById('bookingError');

  const aircraftSelect  = document.getElementById('aircraftSelect');
  const titleSelect     = document.getElementById('titleSelect');
  const startDateInput  = document.getElementById('startDateInput');
  const endDateInput    = document.getElementById('endDateInput');
  const startTimeInput  = document.getElementById('startTimeInput');
  const endTimeInput    = document.getElementById('endTimeInput');
  const startDateIcon   = document.getElementById('startDateIcon');
  const endDateIcon     = document.getElementById('endDateIcon');
  const startTimeIcon   = document.getElementById('startTimeIcon');
  const endTimeIcon     = document.getElementById('endTimeIcon');

  const firstNameInput  = document.getElementById('firstNameInput');
  const lastNameInput   = document.getElementById('lastNameInput');
  const emailInput      = document.getElementById('emailInput');

  const instructorSelect= document.getElementById('instructorSelect');
  const instructorEmailDisplay = document.getElementById('instructorEmailDisplay');

  const tachStartInput  = document.getElementById('tachStartInput');
  const tachEndInput    = document.getElementById('tachEndInput');
  const commentsInput   = document.getElementById('commentsInput');

  const quickTimesRow   = document.getElementById('quickTimesRow');

  /* AUTH MODAL DOM */
  const signinBtn    = document.getElementById('signinBtn');
  const authModal    = document.getElementById('authModal');
  const closeAuthBtn = document.getElementById('closeAuth');
  const tabSignIn    = document.getElementById('tabSignIn');
  const tabSignUp    = document.getElementById('tabSignUp');
  const viewSignIn   = document.getElementById('viewSignIn');
  const viewSignUp   = document.getElementById('viewSignUp');
  const si_email     = document.getElementById('si_email');
  const si_password  = document.getElementById('si_password');
  const doSignIn     = document.getElementById('doSignIn');
  const doReset      = document.getElementById('doReset');
  const signOutBtn   = document.getElementById('signOutBtn');
  const authMsg      = document.getElementById('authMsg');

  const su_first     = document.getElementById('su_first');
  const su_last      = document.getElementById('su_last');
  const su_email     = document.getElementById('su_email');
  const su_password  = document.getElementById('su_password');
  const su_invite    = document.getElementById('su_invite');
  const doSignUp     = document.getElementById('doSignUp');
  const createMsg    = document.getElementById('createMsg');

  /* ========== UTILITIES ========== */
  const pad = (n)=> String(n).padStart(2,'0');
  const dateKey = (d)=> `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;

  function parseDateStr(str){
    if(!str) return null;
    const [y,m,d] = str.split('-').map(Number);
    if(!y || !m || !d) return null;
    return new Date(y,m-1,d);
  }

  function openModal(){
    modalBackdrop.classList.add('open');
    modalBackdrop.setAttribute('aria-hidden','false');
  }
  function closeModal(){
    modalBackdrop.classList.remove('open');
    modalBackdrop.setAttribute('aria-hidden','true');
    selectedBookingId = null;
    bookingErrorEl.textContent = "";
  }

  function setFocusToToday(){
    focusDate = new Date();
    renderCalendar();
  }

  function ensureEndAfterStart(){
    const s = parseDateStr(startDateInput.value);
    const e = parseDateStr(endDateInput.value);
    if(!s || !e) return;
    if(e < s){
      endDateInput.value = startDateInput.value;
    }
  }

  function escapeHtml(s){
    return String(s ?? "")
      .replace(/&/g,"&amp;")
      .replace(/</g,"&lt;")
      .replace(/>/g,"&gt;")
      .replace(/"/g,"&quot;")
      .replace(/'/g,"&#039;");
  }

  function startOfWeek(d){
    const res = new Date(d.getFullYear(), d.getMonth(), d.getDate());
    const day = res.getDay();
    res.setDate(res.getDate() - day);
    return res;
  }

  // ---- time helpers for overlap detection ----
  function timeToMinutes(t){
    if(!t) return null;
    const parts = t.split(':');
    if(parts.length !== 2) return null;
    const h = Number(parts[0]);
    const m = Number(parts[1]);
    if(Number.isNaN(h) || Number.isNaN(m)) return null;
    return h*60 + m;
  }

  function timesOverlap(aStart, aEnd, bStart, bEnd){
    const aS = timeToMinutes(aStart);
    const aE = timeToMinutes(aEnd);
    const bS = timeToMinutes(bStart);
    const bE = timeToMinutes(bEnd);

    const aAllDay = aS === null && aE === null;
    const bAllDay = bS === null && bE === null;

    if(aAllDay || bAllDay) return true;

    const aStartMin = aS ?? 0;
    const aEndMin   = aE ?? (24*60);
    const bStartMin = bS ?? 0;
    const bEndMin   = bE ?? (24*60);

    return aStartMin < bEndMin && bStartMin < aEndMin;
  }

  /* ========== QUICK TIME CHIPS ========== */
  (function initQuickTimes(){
    const times = ["08:00","09:00","10:00","11:00","12:00","13:00","14:00","15:00","16:00","17:00","18:00","19:00","20:00"];
    times.forEach(t=>{
      const chip = document.createElement('button');
      chip.type = "button";
      chip.className = "time-chip";
      chip.textContent = t;
      chip.addEventListener('click', ()=> { endTimeInput.value = t; });
      quickTimesRow.appendChild(chip);
    });
  })();

  /* ========== AUTH MODAL LOGIC (same UX as home) ========== */
  const say  = (t, isErr=false)=>{ authMsg.textContent = t; authMsg.style.color  = isErr ? '#ffb4b4' : '#9fb1c3'; };
  const csay = (t, isErr=false)=>{ createMsg.textContent = t; createMsg.style.color = isErr ? '#ffb4b4' : '#9fb1c3'; };

  function openAuth(){
    authModal.classList.add('open');
    authModal.setAttribute('aria-hidden','false');
    say(""); csay("");
  }
  function closeAuthModal(){
    authModal.classList.remove('open');
    authModal.setAttribute('aria-hidden','true');
  }

  signinBtn?.addEventListener('click', openAuth);
  closeAuthBtn?.addEventListener('click', closeAuthModal);
  authModal?.addEventListener('click', e => { if(e.target === authModal) closeAuthModal(); });

  function setAuthView(kind){
    [tabSignIn, tabSignUp].forEach(t=>t.classList.remove('active'));
    [viewSignIn, viewSignUp].forEach(v=>v.classList.remove('active'));
    if (kind === 'in'){
      tabSignIn.classList.add('active');
      viewSignIn.classList.add('active');
    } else {
      tabSignUp.classList.add('active');
      viewSignUp.classList.add('active');
    }
  }
  tabSignIn.addEventListener('click', ()=>setAuthView('in'));
  tabSignUp.addEventListener('click', ()=>setAuthView('up'));

  // Sign in
  doSignIn.addEventListener('click', async ()=>{
    const email = si_email.value.trim();
    const pass  = si_password.value;
    if (!email || !pass) return say("Enter email and password.", true);
    try{
      await signInEmailPassword(email, pass);
      say("Signed in.");
      closeAuthModal();
    }catch(err){ say(err.message, true); }
  });

  // Sign up (uses auth.js invite logic)
  doSignUp.addEventListener('click', async ()=>{
    const email = su_email.value.trim();
    const pass  = su_password.value;
    const code  = su_invite.value.trim();
    const first = su_first.value.trim();
    const last  = su_last.value.trim();

    if (!email || !pass || !code || !first || !last){
      return csay("First and last name, email, password, and invite code are required.", true);
    }

    try{
      await signUpWithInvite({ email, password: pass, firstName: first, lastName: last, code });
      csay("Account created! Check your email to verify.");
      setAuthView('in');
    }catch(err){ csay(err.message, true); }
  });

  // Reset password
  doReset.addEventListener('click', async ()=>{
    const email = si_email.value.trim();
    if (!email) return say("Enter your email first.", true);
    try{
      await resetPassword(email);
      say("Password reset email sent.");
    }catch(err){ say(err.message, true); }
  });

  // Sign out
  signOutBtn.addEventListener('click', async ()=>{
    await signOut();
    say("Signed out.");
  });

  // Enter key for auth fields
  function handleEnter(e){
    if(e.key !== 'Enter') return;
    if (viewSignIn.classList.contains('active')) doSignIn.click();
    else doSignUp.click();
  }
  [si_email, si_password, su_first, su_last, su_email, su_password, su_invite]
    .forEach(el => el.addEventListener('keydown', handleEnter));

  /* ========== AIRCRAFT STATUS ========== */
  function subscribeAircraftStatus(){
    const qStatus = query(collection(db,"aircraftStatus"));
    return onSnapshot(qStatus, (snap)=>{
      statusCardsEl.innerHTML = "";
      aircraftStatusMap = {};

      snap.forEach(docSnap=>{
        const d = docSnap.data() || {};
        const currentTachNum = (typeof d.currentTach === "number")
          ? d.currentTach
          : (d.currentTach ? Number(d.currentTach) : null);

        aircraftStatusMap[docSnap.id] = { currentTach: currentTachNum };

        const div = document.createElement('div');
        div.className = "tach-card";
        div.innerHTML = `
          <div class="tach-title">${escapeHtml(docSnap.id)}</div>
          <div class="tach-row"><span>Tach:</span><span>${currentTachNum ?? 'â€”'}</span></div>
          <div style="margin-top:4px;font-size:.75rem;color:var(--muted);">
            Last updated: ${d.updatedAt?.toDate ? d.updatedAt.toDate().toLocaleString() : 'â€”'}
          </div>
        `;
        statusCardsEl.appendChild(div);
      });

      const boardDiv = document.createElement('div');
      boardDiv.className = "tach-card";
      boardDiv.innerHTML = `
        <div class="tach-title">Board Meeting</div>
        <div class="tach-row"><span>When:</span><span>1st Thursday of every month</span></div>
        <div style="margin-top:4px;font-size:.75rem;color:var(--muted);">
          Appears on the calendar as a purple event.
        </div>
      `;
      statusCardsEl.appendChild(boardDiv);
    });
  }

  /* ========== INSTRUCTORS + EMAIL HELPERS ========== */
  async function loadInstructors(){
    instructors = [];
    try{
      const snap = await getDocs(collection(db,"instructors"));
      snap.forEach(docSnap=>{
        const data = docSnap.data() || {};
        Object.entries(data).forEach(([name,email])=>{
          if(!name || !email) return;
          instructors.push({name,email});
        });
      });
    }catch(e){
      console.warn("instructors error:", e);
    }
    instructorSelect.innerHTML = `<option value="">N/A</option>`;
    instructors.forEach(i=>{
      const opt = document.createElement('option');
      opt.value = i.email;
      opt.textContent = i.name;
      instructorSelect.appendChild(opt);
    });
  }

  function collectReservationDetails(){
    const first = firstNameInput.value || (currentRole?.profile?.firstName || "");
    const last  = lastNameInput.value || (currentRole?.profile?.lastName || "");
    const memberEmail = emailInput.value || (currentRole?.email || "");

    const aircraft = aircraftSelect.value || "";
    const title    = titleSelect.value || "";
    const sDate    = startDateInput.value || "";
    const eDate    = endDateInput.value || "";
    const sTime    = startTimeInput.value || "";
    const eTime    = endTimeInput.value || "";
    const comments = commentsInput.value || "";

    const dateRange = sDate && eDate && sDate !== eDate
      ? `${sDate} to ${eDate}`
      : (sDate || eDate || "");

    const timeRange = (sTime || eTime)
      ? `${sTime || 'N/A'} â€“ ${eTime || 'N/A'}`
      : "All-day / flexible";

    return {
      first,
      last,
      memberEmail,
      aircraft,
      title,
      dateRange,
      sDate,
      eDate,
      sTime,
      eTime,
      timeRange,
      comments
    };
  }

  function buildInstructorEmailBody(inst, { cancelled = false } = {}, detailsOverride = null){
    const details = detailsOverride || collectReservationDetails();
    const {
      first,
      last,
      memberEmail,
      aircraft,
      title,
      dateRange,
      timeRange,
      comments
    } = details;

    if (cancelled){
      return `Hi ${inst.name || 'Instructor'},

This is ${first} ${last} (${memberEmail}).

I need to cancel the following reservation:

Aircraft: ${aircraft || 'N/A'}
Type: ${title || 'N/A'}
Date(s): ${dateRange || 'N/A'}
Time window: ${timeRange || 'N/A'}

Additional notes:
${comments || '(none)'}

Thank you,
${first} ${last}`;
    }

    return `Hi ${inst.name || 'Instructor'},

This is ${first} ${last} (${memberEmail}).

I'd like to schedule a ${title || 'flight'} in ${aircraft || 'aircraft'}.

Requested date(s):
  ${dateRange || 'N/A'}

Requested time window:
  ${timeRange || 'N/A'}

Additional notes:
${comments || '(none)'}

Please let me know if this works or what other times are available.

Thank you,
${first} ${last}`;
  }

  function launchInstructorEmail(cancelled = false, booking = null){
    if (booking){
      const instructorEmail = booking.instructorEmail || "";
      if (!instructorEmail) return;

      const inst = instructors.find(i => i.email === instructorEmail) || {
        name: 'Instructor',
        email: instructorEmail
      };

      const sDate = booking.startDate || "";
      const eDate = booking.endDate || booking.startDate || "";
      const dateRange = sDate && eDate && sDate !== eDate
        ? `${sDate} to ${eDate}`
        : (sDate || eDate || "");

      const sTime = booking.startTime || "";
      const eTime = booking.endTime || "";
      const timeRange = (sTime || eTime)
        ? `${sTime || 'N/A'} â€“ ${eTime || 'N/A'}`
        : "All-day / flexible";

      const details = {
        first: booking.firstName || "",
        last: booking.lastName || "",
        memberEmail: booking.email || "",
        aircraft: booking.aircraft || "",
        title: booking.title || "",
        dateRange,
        timeRange,
        comments: booking.comments || ""
      };

      const subject = (cancelled
        ? `Cancelled Reservation â€“ ${details.aircraft || ''} ${sDate || ''}`
        : `Flight Reservation Request â€“ ${details.aircraft || ''} ${sDate || ''}`
      ).trim();

      const body = buildInstructorEmailBody(inst, { cancelled }, details);
      const mailto = `mailto:${encodeURIComponent(inst.email)}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
      window.location.href = mailto;
      return;
    }

    const email = instructorSelect.value || "";
    if (!email) return;

    const inst = instructors.find(i => i.email === email) || { name: 'Instructor', email };
    const details = collectReservationDetails();
    const subject = (cancelled
      ? `Cancelled Reservation â€“ ${details.aircraft || ''} ${details.sDate || ''}`
      : `Flight Reservation Request â€“ ${details.aircraft || ''} ${details.sDate || ''}`
    ).trim();

    const body = buildInstructorEmailBody(inst, { cancelled }, details);
    const mailto = `mailto:${encodeURIComponent(inst.email)}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
    window.location.href = mailto;
  }

  instructorSelect.addEventListener('change', ()=>{
    const email = instructorSelect.value || "";
    const inst = instructors.find(i => i.email === email);
    instructorEmailDisplay.textContent = inst ? inst.email : "";
  });

  /* ========== BOOKINGS LOAD / RENDER ========== */
  function subscribeBookings(){
    const qBookings = query(collection(db,"bookings"));
    return onSnapshot(qBookings, (snap)=>{
      bookings = [];
      snap.forEach(d=>{
        const data = d.data() || {};
        bookings.push({
          id: d.id,
          ...data
        });
      });
      renderCalendar();
    }, (err)=>{
      console.warn("bookings snapshot error:", err);
    });
  }

  function visibleBookingsForDate(d){
    const key = dateKey(d);

    return bookings.filter(b => {
      if (aircraftFilter !== 'all' && b.aircraft && b.aircraft !== aircraftFilter) {
        return false;
      }

      let s = b.startDate ?? b.date ?? b.startTimestamp ?? b.start;
      let e = b.endDate   ?? b.endTimestamp ?? b.end ?? s;

      if (!s && !e) return false;

      const toKey = (val) => {
        if (!val) return null;

        if (typeof val === "string" && /^\d{4}-\d{2}-\d{2}$/.test(val)) {
          return val;
        }

        if (val && typeof val.toDate === "function") {
          return dateKey(val.toDate());
        }

        if (val instanceof Date) {
          return dateKey(val);
        }

        return null;
      };

      const sKey = toKey(s);
      const eKey = toKey(e) ?? sKey;

      if (!sKey) return false;

      return key >= sKey && key <= (eKey || sKey);
    });
  }

  function boardMeetingsForDate(d){
    const isThursday = d.getDay() === 4;
    const isFirstWeek = d.getDate() <= 7;
    if (!isThursday || !isFirstWeek) return [];

    return [{
      id: `board-${dateKey(d)}`,
      title: "Board Meeting",
      startDate: dateKey(d),
      endDate: dateKey(d),
      startTime: "",
      endTime: "",
      firstName: "",
      lastName: "",
      isBoardMeeting: true
    }];
  }

  function renderCalendar(){
    if(!monthGridEl) return;

    const year  = focusDate.getFullYear();
    const month = focusDate.getMonth();

    const monthNames = ["January","February","March","April","May","June",
                        "July","August","September","October","November","December"];

    if(viewMode === 'month'){
      monthLabelEl.textContent = `${monthNames[month]} ${year}`;
    } else if(viewMode === 'week'){
      const start = startOfWeek(focusDate);
      const end   = new Date(start);
      end.setDate(end.getDate() + 6);
      monthLabelEl.textContent = `Week of ${monthNames[start.getMonth()]} ${start.getDate()}, ${start.getFullYear()}`;
    } else {
      monthLabelEl.textContent = `Day â€“ ${monthNames[month]} ${focusDate.getDate()}, ${year}`;
    }

    monthGridEl.innerHTML = "";

    const todayKey = dateKey(new Date());

    function makeBookingPill(b){
      const pill = document.createElement('div');
      pill.className = "event-pill";

      if (b.isBoardMeeting){
        pill.classList.add('event-board');
      } else if(b.title === "Maintenance"){
        pill.classList.add('event-maint');
      } else if(b.uid === currentRole?.uid){
        pill.classList.add('event-your');
      } else {
        pill.classList.add('event-other');
      }

      const who = `${b.firstName || ''} ${(b.lastName || '')}`.trim() || (b.isBoardMeeting ? "" : "Member");
      const title = b.title || "Booking";
      const times = (b.startTime || b.endTime)
        ? ` (${b.startTime || '??'}â€“${b.endTime || '??'})`
        : "";

      pill.textContent = b.isBoardMeeting
        ? `${title}${times}`
        : `${title} â€“ ${who}${times}`;

      if (!b.isBoardMeeting){
        pill.addEventListener('click', (evt)=>{
          evt.stopPropagation();
          if (!currentUser){
            openAuth();
            return;
          }
          openBookingForEdit(b);
        });
      }

      return pill;
    }

    if(viewMode === 'month'){
      const firstOfMonth = new Date(year, month, 1);
      const start = startOfWeek(firstOfMonth);
      const temp = new Date(start);

      for(let i=0;i<42;i++){
        const thisDate = new Date(temp);
        const cell = document.createElement('div');
        cell.className = "day-cell";

        const cellKey = dateKey(thisDate);
        if(thisDate.getMonth() !== month) cell.classList.add('other-month');
        if(cellKey === todayKey) cell.classList.add('today');

        const num = document.createElement('div');
        num.className = 'day-num';
        num.textContent = thisDate.getDate();
        cell.appendChild(num);

        const dayBookings = [
          ...visibleBookingsForDate(thisDate),
          ...boardMeetingsForDate(thisDate)
        ];

        dayBookings.forEach(b=>{
          const pill = makeBookingPill(b);
          cell.appendChild(pill);
        });

        cell.addEventListener('click', ()=>{
          if(!currentUser){
            openAuth();
            return;
          }
          openBookingForDate(thisDate);
        });

        monthGridEl.appendChild(cell);
        temp.setDate(temp.getDate() + 1);
      }
    } else if(viewMode === 'week'){
      const start = startOfWeek(focusDate);
      const temp = new Date(start);
      for(let i=0;i<7;i++){
        const thisDate = new Date(temp);
        const cell = document.createElement('div');
        cell.className = "day-cell";

        const cellKey = dateKey(thisDate);
        if(cellKey === todayKey) cell.classList.add('today');

        const num = document.createElement('div');
        num.className = 'day-num';
        num.textContent = `${thisDate.getMonth()+1}/${thisDate.getDate()}`;
        cell.appendChild(num);

        const dayBookings = [
          ...visibleBookingsForDate(thisDate),
          ...boardMeetingsForDate(thisDate)
        ];

        dayBookings.forEach(b=>{
          const pill = makeBookingPill(b);
          cell.appendChild(pill);
        });

        cell.addEventListener('click', ()=>{
          if(!currentUser){
            openAuth();
            return;
          }
          openBookingForDate(thisDate);
        });

        monthGridEl.appendChild(cell);
        temp.setDate(temp.getDate() + 1);
      }
    } else {
      const cell = document.createElement('div');
      cell.className = "day-cell";
      cell.style.gridColumn = "1 / -1";

      const cellKey = dateKey(focusDate);
      if(cellKey === todayKey) cell.classList.add('today');

      const num = document.createElement('div');
      num.className = 'day-num';
      num.textContent = `${focusDate.getMonth()+1}/${focusDate.getDate()}`;
      cell.appendChild(num);

      const dayBookings = [
        ...visibleBookingsForDate(focusDate),
        ...boardMeetingsForDate(focusDate)
      ];

      dayBookings.forEach(b=>{
        const pill = makeBookingPill(b);
        cell.appendChild(pill);
      });

      cell.addEventListener('click', ()=>{
        if(!currentUser){
          openAuth();
          return;
        }
        openBookingForDate(focusDate);
      });

      monthGridEl.appendChild(cell);
    }
  }

  /* ========== BOOKING MODAL: OPEN / SAVE / DELETE ========== */

  function openBookingForDate(d){
    selectedBookingId = null;
    bookingErrorEl.textContent = "";
    modalTitleEl.textContent = "New booking";

    firstNameInput.value = currentRole?.profile?.firstName || "";
    lastNameInput.value  = currentRole?.profile?.lastName  || "";
    emailInput.value     = currentRole?.email || "";

    aircraftSelect.value   = aircraftSelect.value || "N78710";
    titleSelect.value      = titleSelect.value || "Training";
    startDateInput.value   = dateKey(d);
    endDateInput.value     = dateKey(d);
    startTimeInput.value   = "";
    endTimeInput.value     = "";
    tachStartInput.value   = "";
    tachEndInput.value     = "";
    commentsInput.value    = "";
    instructorSelect.value = "";
    instructorEmailDisplay.textContent = "";

    deleteBookingBtn.style.display = "none";

    openModal();
  }

  function openBookingForEdit(b){
    selectedBookingId = b.id;
    bookingErrorEl.textContent = "";
    modalTitleEl.textContent = "Edit booking";

    aircraftSelect.value = b.aircraft || "N78710";
    titleSelect.value    = b.title || "Training";
    startDateInput.value = b.startDate || "";
    endDateInput.value   = b.endDate || b.startDate || "";
    startTimeInput.value = b.startTime || "";
    endTimeInput.value   = b.endTime || "";
    tachStartInput.value = b.tachStart || "";
    tachEndInput.value   = b.tachEnd || "";
    commentsInput.value  = b.comments || "";

    firstNameInput.value = b.firstName || currentRole?.profile?.firstName || "";
    lastNameInput.value  = b.lastName  || currentRole?.profile?.lastName  || "";
    emailInput.value     = b.email     || currentRole?.email              || "";

    if (b.instructorEmail){
      const inst = instructors.find(i => i.email === b.instructorEmail);
      instructorSelect.value = b.instructorEmail;
      instructorEmailDisplay.textContent = inst ? inst.email : b.instructorEmail;
    } else {
      instructorSelect.value = "";
      instructorEmailDisplay.textContent = "";
    }

    const isOwner = b.uid && currentRole && b.uid === currentRole.uid;
    const isMaint = b.title === "Maintenance";

    if (currentRole?.isAdmin || (isOwner && !isMaint)){
      deleteBookingBtn.style.display = "inline-block";
    } else {
      deleteBookingBtn.style.display = "none";
    }

    openModal();
  }

  function makeDateTime(dateStr, timeStr, isEnd){
    if (!dateStr) return null;
    let t = timeStr;
    if (!t || !t.trim()){
      t = isEnd ? "23:59" : "00:00";
    }
    return new Date(`${dateStr}T${t}`);
  }

  function intervalsOverlap(aStart, aEnd, bStart, bEnd){
    if (!aStart || !aEnd || !bStart || !bEnd) return false;
    return aStart < bEnd && aEnd > bStart;
  }

  function findOverlapBooking({ aircraft, sDate, eDate, sTime, eTime, ignoreId }){
    const startDT = makeDateTime(sDate, sTime, false);
    const endDT   = makeDateTime(eDate || sDate, eTime, true);

    if (!startDT || !endDT) return null;

    for (const b of bookings){
      if (b.aircraft !== aircraft) continue;
      if (ignoreId && b.id === ignoreId) continue;

      const bStartDT = makeDateTime(b.startDate || b.date, b.startTime, false);
      const bEndDT   = makeDateTime(b.endDate || b.startDate || b.date, b.endTime, true);
      if (!bStartDT || !bEndDT) continue;

      if (intervalsOverlap(startDT, endDT, bStartDT, bEndDT)){
        return b;
      }
    }
    return null;
  }

  async function saveBooking(){
    if (!currentRole || !currentRole.uid){
      bookingErrorEl.textContent = "Please sign in first.";
      return;
    }

    const aircraft = aircraftSelect.value;
    const title    = titleSelect.value;
    const sDate    = startDateInput.value;
    const eDate    = endDateInput.value || sDate;
    const sTime    = startTimeInput.value;
    const eTime    = endTimeInput.value;
    const tachS    = tachStartInput.value.trim();
    const tachE    = tachEndInput.value.trim();
    const comments = commentsInput.value || "";

    if (!aircraft || !sDate){
      bookingErrorEl.textContent = "Aircraft and start date are required.";
      return;
    }

    const sd = parseDateStr(sDate);
    const ed = parseDateStr(eDate);
    if (sd && ed && ed < sd){
      bookingErrorEl.textContent = "End date cannot be before start date.";
      return;
    }

    let tachSNum = null;
    let tachENum = null;

    if (tachS){
      tachSNum = parseFloat(tachS);
      if (Number.isNaN(tachSNum)){
        bookingErrorEl.textContent = "Tach start must be a number.";
        return;
      }
    }

    if (tachE){
      tachENum = parseFloat(tachE);
      if (Number.isNaN(tachENum)){
        bookingErrorEl.textContent = "Tach end must be a number.";
        return;
      }
    }

    if (tachSNum !== null && tachENum !== null && tachENum < tachSNum){
      bookingErrorEl.textContent = "Tach end cannot be less than tach start.";
      return;
    }

    if (title === "Maintenance" && !currentRole.isAdmin){
      bookingErrorEl.textContent = "Only admins can create Maintenance bookings.";
      return;
    }

    const conflict = findOverlapBooking({
      aircraft,
      sDate,
      eDate,
      sTime,
      eTime,
      ignoreId: selectedBookingId || null
    });

    if (conflict){
      const who = `${conflict.firstName || ""} ${conflict.lastName || ""}`.trim() || "another member";
      const conflictDates = conflict.startDate === conflict.endDate || !conflict.endDate
        ? conflict.startDate
        : `${conflict.startDate} to ${conflict.endDate}`;
      const conflictTimes = (conflict.startTime || conflict.endTime)
        ? ` (${conflict.startTime || "??"}â€“${conflict.endTime || "??"})`
        : "";
      bookingErrorEl.textContent =
        `This aircraft is already booked by ${who} on ${conflictDates}${conflictTimes}.`;
      return;
    }

    const first = currentRole.profile?.firstName || "";
    const last  = currentRole.profile?.lastName  || "";
    const email = currentRole.email || "";

    const base = {
      aircraft,
      title,
      startDate: sDate,
      endDate:   eDate,
      startTime: sTime || "",
      endTime:   eTime || "",
      firstName: first,
      lastName:  last,
      email,
      instructorEmail: instructorSelect.value || "",
      tachStart: tachS || "",
      tachEnd:   tachE || "",
      comments,
      uid: currentRole.uid,
      updatedAt: serverTimestamp()
    };

    try {
      if (selectedBookingId){
        const ref = doc(db, "bookings", selectedBookingId);
        await updateDoc(ref, base);
      } else {
        const ref = await addDoc(collection(db, "bookings"), {
          ...base,
          createdAt: serverTimestamp()
        });
        selectedBookingId = ref.id;
      }

      if (tachENum !== null){
        try{
          await updateDoc(doc(db, "aircraftStatus", aircraft), {
            currentTach: tachENum,
            updatedAt: serverTimestamp()
          });
        } catch (e){
          console.warn("Failed to update aircraftStatus tach:", e);
        }
      }

      if (instructorSelect.value){
        launchInstructorEmail(false);
      }

      closeModal();
    } catch (e){
      console.error(e);
      bookingErrorEl.textContent = e.message || "Save failed.";
    }
  }

  async function deleteBooking(){
    if (!selectedBookingId) return;
    if (!confirm("Delete this booking?")) return;

    const hasInstructor = !!(instructorSelect.value && instructorSelect.value.trim());

    if (hasInstructor){
      launchInstructorEmail(true);
    }

    try {
      await deleteDoc(doc(db, "bookings", selectedBookingId));
      closeModal();
    } catch (e){
      alert(e.message);
    }
  }

  /* ========== EXPORT (CURRENT MONTH) ========== */
  function exportCurrentMonth(){
    const y = focusDate.getFullYear();
    const m = focusDate.getMonth();
    const start = new Date(y, m, 1);
    const end   = new Date(y, m + 1, 0);
    const startStr = dateKey(start);
    const endStr   = dateKey(end);

    const rows = bookings.filter(b => {
      const s = b.startDate || "";
      if (!s) return false;
      return s >= startStr && s <= endStr;
    });

    if (!rows.length){
      alert("No bookings for this month.");
      return;
    }

    const header = [
      "Aircraft","Title","StartDate","EndDate","StartTime","EndTime",
      "FirstName","LastName","Email","InstructorEmail",
      "TachStart","TachEnd","Comments"
    ];

    const lines = [header.join(",")];
    rows.forEach(b => {
      const vals = [
        b.aircraft || "",
        b.title || "",
        b.startDate || "",
        b.endDate || "",
        b.startTime || "",
        b.endTime || "",
        b.firstName || "",
        b.lastName || "",
        b.email || "",
        b.instructorEmail || "",
        b.tachStart || "",
        b.tachEnd || "",
        (b.comments || "").replace(/\r?\n/g, " ")
      ];
      const escaped = vals.map(v => `"${String(v).replace(/"/g, '""')}"`);
      lines.push(escaped.join(","));
    });

    const csv = lines.join("\r\n");
    const blob = new Blob([csv], { type: "text/csv" });
    const url  = URL.createObjectURL(blob);
    const a = document.createElement('a');
    const mm = String(m + 1).padStart(2, "0");
    a.href = url;
    a.download = `flying64th-bookings-${y}-${mm}.csv`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }

  /* ========== EVENTS & AUTH STATE ========== */
  filterPills.forEach(p => {
    p.addEventListener('click', () => {
      filterPills.forEach(x => x.classList.remove('active'));
      p.classList.add('active');
      aircraftFilter = p.getAttribute('data-aircraft') || 'all';
      renderCalendar();
    });
  });

  function setViewMode(mode){
    viewMode = mode;
    [viewMonthBtn, viewWeekBtn, viewDayBtn].forEach(btn => btn.classList.remove('active'));
    if (mode === 'month') viewMonthBtn.classList.add('active');
    if (mode === 'week')  viewWeekBtn.classList.add('active');
    if (mode === 'day')   viewDayBtn.classList.add('active');
    renderCalendar();
  }
  viewMonthBtn.addEventListener('click', () => setViewMode('month'));
  viewWeekBtn.addEventListener('click', () => setViewMode('week'));
  viewDayBtn.addEventListener('click', () => setViewMode('day'));

  prevPeriodBtn.addEventListener('click', () => {
    if (viewMode === 'month'){
      focusDate = new Date(focusDate.getFullYear(), focusDate.getMonth() - 1, 1);
    } else if (viewMode === 'week'){
      focusDate = new Date(focusDate.getFullYear(), focusDate.getMonth(), focusDate.getDate() - 7);
    } else {
      focusDate = new Date(focusDate.getFullYear(), focusDate.getMonth(), focusDate.getDate() - 1);
    }
    renderCalendar();
  });
  nextPeriodBtn.addEventListener('click', () => {
    if (viewMode === 'month'){
      focusDate = new Date(focusDate.getFullYear(), focusDate.getMonth() + 1, 1);
    } else if (viewMode === 'week'){
      focusDate = new Date(focusDate.getFullYear(), focusDate.getMonth(), focusDate.getDate() + 7);
    } else {
      focusDate = new Date(focusDate.getFullYear(), focusDate.getMonth(), focusDate.getDate() + 1);
    }
    renderCalendar();
  });
  todayBtn.addEventListener('click', setFocusToToday);

  exportMonthBtn.addEventListener('click', exportCurrentMonth);

  bookingCloseBtn.addEventListener('click', closeModal);
  cancelBookingBtn.addEventListener('click', closeModal);
  saveBookingBtn.addEventListener('click', saveBooking);
  deleteBookingBtn.addEventListener('click', deleteBooking);

  startDateInput.addEventListener('change', ensureEndAfterStart);
  endDateInput.addEventListener('change', ensureEndAfterStart);
  startDateIcon.addEventListener('click', () => startDateInput.showPicker?.());
  endDateIcon.addEventListener('click', () => endDateInput.showPicker?.());
  startTimeIcon.addEventListener('click', () => startTimeInput.showPicker?.());
  endTimeIcon.addEventListener('click', () => endTimeInput.showPicker?.());

  newBookingBtn.addEventListener('click', () => {
    if (!currentUser){
      openAuth();
      return;
    }
    openBookingForDate(focusDate);
  });

  onAuthChanged(async (user) => {
    currentUser = user || null;
    if (!user){
      signinBtn.textContent = "Sign In";
      currentRole = null;
      isAdmin = false;
      bookings = [];
      statusCardsEl.innerHTML = "";
      if (unsubStatus){   unsubStatus();   unsubStatus = null; }
      if (unsubBookings){ unsubBookings(); unsubBookings = null; }
      renderCalendar();
      return;
    }

    try {
      currentRole = await getMyRole();
      isAdmin = !!currentRole.isAdmin;
      const email = currentRole.email || user.email || "";
      const shortEmail = email.length > 25 ? email.slice(0, 25) + "â€¦" : email;
      signinBtn.textContent = shortEmail ? `Account â€“ ${shortEmail}` : "Account";

      firstNameInput.value = currentRole.profile?.firstName || "";
      lastNameInput.value  = currentRole.profile?.lastName  || "";
      emailInput.value     = currentRole.email || "";

      const maintOpt = [...titleSelect.options].find(o => o.value === "Maintenance");
      if (maintOpt){
        if (!currentRole.isAdmin){
          maintOpt.disabled = true;
        } else {
          maintOpt.disabled = false;
        }
      }

      if (!unsubStatus)   unsubStatus   = subscribeAircraftStatus();
      if (!unsubBookings) unsubBookings = subscribeBookings();

      if (!instructors.length) loadInstructors();

    } catch (e){
      console.warn("getMyRole error:", e);
    }
  });

  renderCalendar();
</script>
</body>
</html>
