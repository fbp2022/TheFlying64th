<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Calendar â€“ The Flying 64th</title>

<style>
  :root{
    --bg:#0f1115; --ink:#e9eef7; --muted:#b9c2d0;
    --panel:#151924; --panel2:#0d1018;
    --accent:#4da3ff; --rule:rgba(255,255,255,.10); --border:rgba(255,255,255,.12);
    --radius:14px;
    --c172:#69b7ff;      /* N78710 */
    --c150:#9dd17d;      /* N10921 */
    --c172-inst:#2a76c5; /* with instructor inner ring */
    --c150-inst:#4a8f42;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;
    background:var(--bg); color:var(--ink);
    -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
  }

  /* ===== NAV ===== */
  .site-header{
    position:sticky; top:0; z-index:50;
    backdrop-filter:saturate(160%) blur(8px);
    background:rgba(11,17,23,.75);
    border-bottom:1px solid var(--rule);
  }
  .nav{
    max-width:min(1600px,96vw); margin:0 auto; padding:12px 18px;
    display:flex; align-items:center; justify-content:space-between; gap:12px;
  }
  .brand{
    display:flex; align-items:center; gap:10px; font-weight:800; letter-spacing:.2px;
    color:var(--ink); text-decoration:none; font-size:22px; white-space:nowrap;
  }
  .brand img{ height:34px; width:auto }
  header nav{ display:flex; align-items:center; gap:18px; flex-wrap:nowrap; }
  header nav a{
    color:var(--muted); text-decoration:none; padding:8px 12px; border-radius:10px;
    transition:all .18s ease;
  }
  header nav a:hover{ color:var(--ink); background:rgba(255,255,255,.06) }
  header nav a.active{ color:#001a33; background:var(--accent); font-weight:700 }
  #signinBtn{border:1px solid var(--border); padding:8px 12px; border-radius:10px; cursor:pointer}
  #signinBtn:hover{background:rgba(255,255,255,.06)}

  /* ===== Persistent Tach/Hobbs Banner ===== */
  .banner{
    max-width:min(1600px,96vw); margin:12px auto 8px; padding:10px 12px;
    border:1px solid var(--border); border-radius:12px;
    background:linear-gradient(180deg,var(--panel),var(--panel2));
    display:flex; align-items:center; gap:10px;
  }
  .banner b{color:#d9e7ff}

  /* ===== Top controls ===== */
  .controls{
    max-width:min(1600px,96vw); margin:0 auto; display:flex; align-items:center; gap:10px; flex-wrap:wrap;
  }
  .pill{
    border:1px solid var(--border); background:#0c1020; color:#eaf2ff;
    padding:8px 12px; border-radius:999px; text-decoration:none; cursor:pointer;
  }
  .pill.active{ background:var(--accent); color:#001a33; font-weight:700; }
  .btn{ border:1px solid var(--border); background:#0c1020; color:#eaf2ff;
        padding:10px 14px; border-radius:10px; text-decoration:none; cursor:pointer; }
  .btn.primary{ background:linear-gradient(180deg,#2b6bb1,#1c4370); border:1px solid #2b6bb1 }

  .controls .right{ margin-left:auto; display:flex; gap:8px; align-items:center }

  /* ===== Notes cards for each aircraft ===== */
  .notes-wrap{
    max-width:min(1600px,96vw); margin:10px auto; display:grid; grid-template-columns:1fr 1fr; gap:12px;
  }
  .note-card{
    background:linear-gradient(180deg,var(--panel),var(--panel2));
    border:1px solid var(--border); border-radius:12px; padding:12px;
  }
  .note-card h3{margin:0 0 8px}
  .note-card small{color:var(--muted)}
  .note-card textarea{width:100%; min-height:56px; resize:vertical; border-radius:10px; border:1px solid var(--border); background:#0b0f1a; color:#e9eef7; padding:8px;}
  .note-card .save{ margin-top:8px; }

  /* ===== Calendar ===== */
  .calendar-wrap{
    max-width:min(1600px,96vw); margin:12px auto 40px;
    background:linear-gradient(180deg,var(--panel),var(--panel2));
    border:1px solid var(--border); border-radius:12px; padding:16px;
  }
  .cal-head{ display:flex; align-items:center; gap:8px; margin-bottom:8px; flex-wrap:wrap; }
  .cal-title{ font-weight:800; letter-spacing:.2px; color:#cfe1ff; margin-left:auto; margin-right:auto; }
  .grid-month{
    display:grid; grid-template-columns:repeat(7,1fr); gap:8px;
  }
  .cell{
    min-height:120px; border:1px dashed var(--border); border-radius:10px; padding:6px; position:relative;
    background:rgba(255,255,255,.02);
  }
  .cell .d{ position:absolute; right:8px; top:6px; color:#8da0b8; font-size:12px }
  .event{
    margin-top:22px; border-radius:8px; padding:6px 8px; font-size:13px;
    border:2px solid transparent; cursor:pointer;
  }
  .event.mine{ outline:2px solid #fff4; }
  .event.inst::after{ content:"â€¢"; margin-left:6px; font-weight:900; }
  .event.c172{ background:rgba(105,183,255,.18); border-color:rgba(105,183,255,.45); }
  .event.c150{ background:rgba(157,209,125,.18); border-color:rgba(157,209,125,.45); }
  .event.c172.inst{ box-shadow: inset 0 0 0 2px var(--c172-inst); }
  .event.c150.inst{ box-shadow: inset 0 0 0 2px var(--c150-inst); }

  /* ===== Modal (create/edit, details) ===== */
  .modal{ position:fixed; inset:0; background:rgba(0,0,0,.55); display:none; place-items:center; z-index:1000; }
  .modal.open{ display:grid }
  .modal-card{
    width:min(1180px,98vw); /* wider horizontally per request */
    max-height:92vh;        /* scroll if zoomed */
    overflow:auto;
    background:#0f1722; color:#e6edf3; border:1px solid #1f2a38; border-radius:14px; padding:16px; position:relative;
  }
  .modal-title{ font-size:18px; font-weight:800; margin:0 0 10px }
  .modal-x{ position:absolute; right:12px; top:10px; border:0; background:transparent; color:#9fb1c3; font-size:18px; cursor:pointer }
  .row{ display:grid; grid-template-columns:1fr 1fr; gap:12px; }
  @media (max-width:780px){ .row{ grid-template-columns:1fr } }
  .label{ font-size:12px; color:#9fb1c3; margin-bottom:4px }
  .in, select, textarea{
    width:100%; padding:10px 12px; border-radius:10px;
    border:1px solid #1f2a38; background:#0b1117; color:#e6edf3;
  }
  .switch{ display:flex; align-items:center; gap:10px; }
  .foot{ display:flex; gap:8px; justify-content:flex-end; margin-top:12px }
  .warn{ color:#ffb86b; font-size:12px; margin-top:6px }
  .err{ color:#ff9b9b; font-size:12px; margin-top:6px }

  .chip{display:inline-block; padding:4px 8px; border-radius:999px; background:#19324a; color:#b5d5ff; font-size:12px; margin-bottom:6px}
</style>
</head>
<body>

<!-- ===== NAV ===== -->
<header class="site-header">
  <div class="nav">
    <a href="home.html" class="brand">
      <img src="images/flying64thlogo.png" alt="The Flying 64th Logo">
      <span>The Flying 64th</span>
    </a>
    <nav>
      <a id="signinBtn">Account â€“ <span id="userEmail">guest</span></a>
      <a href="home.html">Home</a>
      <a class="active" href="calendar.html">Calendar</a>
      <a href="becomeamember.html">Become a Member</a>
      <a href="photos.html">Photos</a>
      <a href="poh&manuals.html">POH &amp; Manuals</a>
     </nav>
  </div>
</header>

<!-- ===== Tach/Hobbs persistent banner ===== -->
<div class="banner">
  <span>ðŸ””</span>
  <span>Reminder: Enter <b>Tach</b> &amp; <b>Hobbs</b> start/end after every flight. If the prior end is missing, youâ€™ll be prompted to resolve it before <b>closing your flight</b>.</span>
</div>

<!-- ===== Top controls ===== -->
<div class="controls">
  <div>
    <button class="pill active" data-filter="all">All</button>
    <button class="pill" data-filter="N78710">N78710 â€” C172</button>
    <button class="pill" data-filter="N10921">N10921 â€” C150</button>
  </div>
  <div class="right">
    <button id="todayBtn" class="btn">Today</button>
    <button id="prevBtn" class="btn">â€¹</button>
    <div id="viewTitle" style="padding:8px 6px; min-width:180px; text-align:center; color:#cfe1ff; font-weight:700;"></div>
    <button id="nextBtn" class="btn">â€º</button>
    <button id="monthBtn" class="pill active" data-view="month">Month</button>
    <button id="weekBtn" class="pill" data-view="week">Week</button>
    <button id="dayBtn" class="pill" data-view="day">Day</button>
    <button id="newBooking" class="btn primary">+ New booking</button>
  </div>
</div>

<!-- ===== Notes ===== -->
<div class="notes-wrap">
  <div class="note-card">
    <h3>N78710 â€” Cessna 172</h3>
    <textarea id="noteN78710" placeholder="e.g., Oil change due atâ€¦"></textarea>
    <div style="display:flex; gap:10px; align-items:center;">
      <button class="btn save" data-aircraft="N78710">Save note</button>
      <small id="noteTimeN78710" class="muted">Last updated: â€”</small>
    </div>
  </div>
  <div class="note-card">
    <h3>N10921 â€” Cessna 150</h3>
    <textarea id="noteN10921" placeholder="e.g., Do not fly afterâ€¦"></textarea>
    <div style="display:flex; gap:10px; align-items:center;">
      <button class="btn save" data-aircraft="N10921">Save note</button>
      <small id="noteTimeN10921" class="muted">Last updated: â€”</small>
    </div>
  </div>
</div>

<!-- ===== Calendar ===== -->
<section class="calendar-wrap">
  <div class="cal-head">
    <div id="legend">
      <span class="chip" style="background:rgba(105,183,255,.15);color:#bfe2ff;border:1px solid rgba(105,183,255,.35)">N78710</span>
      <span class="chip" style="background:rgba(157,209,125,.15);color:#d8f5c8;border:1px solid rgba(157,209,125,.35)">N10921</span>
      <span class="chip">â€¢ = with instructor</span>
    </div>
    <div class="cal-title" id="rangeTitle"></div>
  </div>

  <div id="monthGrid" class="grid-month" aria-label="calendar grid"></div>
</section>

<!-- ===== CREATE/EDIT MODAL ===== -->
<div id="modal" class="modal" aria-hidden="true">
  <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <button class="modal-x" id="xModal" aria-label="Close">âœ•</button>
    <h3 id="modalTitle" class="modal-title">Add title and time</h3>

    <div class="row">
      <div>
        <div class="label">First name</div>
        <input id="firstName" class="in" placeholder="First" />
      </div>
      <div>
        <div class="label">Last name</div>
        <input id="lastName" class="in" placeholder="Last" />
      </div>
    </div>

    <div class="row">
      <div>
        <div class="label">Email (from sign-in)</div>
        <input id="emailIn" class="in" readonly />
      </div>
      <div>
        <div class="label">Aircraft</div>
        <select id="aircraftSel" class="in">
          <option value="N78710">N78710 â€” Cessna 172</option>
          <option value="N10921">N10921 â€” Cessna 150</option>
        </select>
      </div>
    </div>

    <div class="row">
      <div>
        <div class="label">Title</div>
        <input id="titleIn" class="in" placeholder="e.g., Training flight or $100 burger" />
      </div>
      <div class="switch">
        <input id="allDay" type="checkbox" />
        <label for="allDay">All day <span class="muted" style="margin-left:8px;">Times disabled when allâ€‘day is on.</span></label>
      </div>
    </div>

    <div class="row">
      <div>
        <div class="label">Start</div>
        <input id="startDate" class="in" type="date">
        <input id="startTime" class="in" type="time" step="900" style="margin-top:6px;">
      </div>
      <div>
        <div class="label">End</div>
        <input id="endDate" class="in" type="date">
        <input id="endTime" class="in" type="time" step="900" style="margin-top:6px;">
      </div>
    </div>

    <div class="row">
      <div class="switch">
        <input id="withInstructor" type="checkbox" />
        <label for="withInstructor">Book with instructor?</label>
      </div>
      <div>
        <div class="label">Instructor</div>
        <select id="instrSel" class="in" disabled>
          <option value="">Choose flight instructor</option>
          <option>Brian Westfall (BW)</option>
          <option>Justin Cox (JC)</option>
          <option>Jeff Moersch (JM)</option>
        </select>
      </div>
    </div>

    <div class="row">
      <div>
        <div class="label">Tach start</div>
        <input id="tachStart" class="in" inputmode="decimal" placeholder="e.g., 456.5">
      </div>
      <div>
        <div class="label">Tach end</div>
        <input id="tachEnd" class="in" inputmode="decimal" placeholder="e.g., 457.1">
      </div>
    </div>

    <div class="row">
      <div>
        <div class="label">Hobbs start</div>
        <input id="hobbsStart" class="in" inputmode="decimal" placeholder="e.g., 654.2">
      </div>
      <div>
        <div class="label">Hobbs end</div>
        <input id="hobbsEnd" class="in" inputmode="decimal" placeholder="e.g., 655.0">
      </div>
    </div>

    <div id="mismatchWrap" class="warn" style="display:none;">
      Prior flight end doesn't match your starts. Check to overwrite previous end with your start values:
      <label class="switch"><input id="overwritePrev" type="checkbox" /> <span>Overwrite previous end values</span></label>
    </div>
    <div id="overlapErr" class="err" style="display:none;">This time overlaps an existing booking for the selected aircraft.</div>

    <div class="row">
      <div style="grid-column:1 / -1;">
        <div class="label">Comments</div>
        <textarea id="commentsIn" rows="4" placeholder="Notes for this bookingâ€¦"></textarea>
      </div>
    </div>

    <div class="foot">
      <button id="deleteBtn" class="btn" style="display:none;">Delete my booking</button>
      <button id="saveBtn" class="btn primary">Save</button>
    </div>
  </div>
</div>

<script>
/* ========= Simple in-page auth (placeholder) ========= */
const user = {
  email: localStorage.getItem('f64_email') || '',
  first: localStorage.getItem('f64_first') || '',
  last:  localStorage.getItem('f64_last')  || ''
};
function updateSigninUi(){
  document.getElementById('userEmail').textContent = user.email || 'guest';
}
document.getElementById('signinBtn').addEventListener('click', ()=>{
  const email = prompt('Enter email to â€œsign inâ€ (temporary, for demo):', user.email || '');
  if(email){
    const first = prompt('First name:', user.first || '' ) || '';
    const last  = prompt('Last name:',  user.last  || '' ) || '';
    user.email = email.trim();
    user.first = first.trim();
    user.last  = last.trim();
    localStorage.setItem('f64_email', user.email);
    localStorage.setItem('f64_first', user.first);
    localStorage.setItem('f64_last',  user.last);
    updateSigninUi();
  }
});
updateSigninUi();

/* ========= Data store (localStorage for now) ========= */
const LS_KEY = 'f64_bookings_v3';
let bookings = JSON.parse(localStorage.getItem(LS_KEY) || '[]'); // each: {id, userEmail, first,last, aircraft, title, start, end, instr, tachStart,tachEnd,hobbsStart,hobbsEnd, notes}
function saveBookings(){ localStorage.setItem(LS_KEY, JSON.stringify(bookings)); }

/* ========= Notes store ========= */
['N78710','N10921'].forEach(ac=>{
  const t = localStorage.getItem('note_'+ac) || '';
  const when = localStorage.getItem('note_'+ac+'_ts') || '';
  const ta = document.getElementById('note'+ac);
  const sm = document.getElementById('noteTime'+ac);
  ta.value = t;
  sm.textContent = when ? ('Last updated: '+ new Date(parseInt(when,10)).toLocaleString()) : 'Last updated: â€”';
});
document.querySelectorAll('.save').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    const ac = btn.dataset.aircraft;
    const ta = document.getElementById('note'+ac);
    localStorage.setItem('note_'+ac, ta.value);
    const ts = Date.now();
    localStorage.setItem('note_'+ac+'_ts', ts.toString());
    document.getElementById('noteTime'+ac).textContent = 'Last updated: '+ new Date(ts).toLocaleString();
  });
});

/* ========= Calendar state + rendering ========= */
const monthGrid = document.getElementById('monthGrid');
const titleEl   = document.getElementById('viewTitle');
const rangeTitle= document.getElementById('rangeTitle');

let current = new Date();
current.setHours(0,0,0,0);

function setToday(){ const d=new Date(); d.setHours(0,0,0,0); current = d; render(); }
document.getElementById('todayBtn').addEventListener('click', setToday);
document.getElementById('prevBtn').addEventListener('click', ()=>{ current.setMonth(current.getMonth()-1); render(); });
document.getElementById('nextBtn').addEventListener('click', ()=>{ current.setMonth(current.getMonth()+1); render(); });

document.querySelectorAll('[data-view]').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    document.querySelectorAll('[data-view]').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    // Month is implemented; Week/Day buttons are wired for future.
  });
});

let filter = 'all';
document.querySelectorAll('[data-filter]').forEach(p=>{
  p.addEventListener('click', ()=>{
    document.querySelectorAll('[data-filter]').forEach(x=>x.classList.remove('active'));
    p.classList.add('active');
    filter = p.dataset.filter;
    render();
  });
});

function monthRange(d){
  const year = d.getFullYear(), month=d.getMonth();
  const start = new Date(year, month, 1);
  const end   = new Date(year, month+1, 0);
  return {start,end};
}

function sameDay(a,b){ return a.getFullYear()==b.getFullYear() && a.getMonth()==b.getMonth() && a.getDate()==b.getDate(); }

function render(){
  const {start,end} = monthRange(current);
  titleEl.textContent = start.toLocaleString(undefined,{month:'long', year:'numeric'});
  rangeTitle.textContent = start.toLocaleString(undefined,{month:'long',year:'numeric'});
  monthGrid.innerHTML = '';

  // Create day cells for 6 weeks grid around month
  const firstWeekday = new Date(start); firstWeekday.setDate(1); const startWeekday = (firstWeekday.getDay()+6)%7; // Mon=0
  const gridStart = new Date(start); gridStart.setDate(1 - startWeekday);
  for(let i=0;i<42;i++){
    const day = new Date(gridStart); day.setDate(gridStart.getDate()+i);
    const cell = document.createElement('div');
    cell.className = 'cell';
    const d = document.createElement('div'); d.className='d'; d.textContent = day.getDate(); cell.appendChild(d);

    // Events in this day
    const todays = bookings.filter(b=>{
      if(filter!=='all' && b.aircraft!==filter) return false;
      const bs = new Date(b.start), be = new Date(b.end);
      return sameDay(bs,day) || (bs<day && be>day);
    }).sort((a,b)=> new Date(a.start)-new Date(b.start));

    todays.forEach(ev=>{
      const div=document.createElement('div');
      const mine = (user.email && ev.userEmail===user.email);
      const isC172 = ev.aircraft==='N78710';
      div.className='event '+(isC172?'c172':'c150')+(ev.instr?' inst':'')+(mine?' mine':'');
      const s=new Date(ev.start), e=new Date(ev.end);
      const hhmm = s.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}) + 'â€“' + e.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});
      div.textContent = (mine?'(Me) ':'') + (ev.title||'Booking') + ' â€¢ ' + hhmm;
      div.title = ev.aircraft + (ev.instr? ' â€¢ with instructor':'') + ' â€¢ ' + hhmm;
      div.addEventListener('click', ()=> openModal(ev.id)); // details / edit own
      cell.appendChild(div);
    });

    monthGrid.appendChild(cell);
  }
}
setToday();

/* ========= Modal logic ========= */
const modal = document.getElementById('modal');
const xModal= document.getElementById('xModal');
const saveBtn=document.getElementById('saveBtn');
const deleteBtn=document.getElementById('deleteBtn');
const withInstructor = document.getElementById('withInstructor');
const instrSel = document.getElementById('instrSel');
withInstructor.addEventListener('change', ()=>{ instrSel.disabled = !withInstructor.checked; if(!withInstructor.checked) instrSel.value=''; });

document.getElementById('newBooking').addEventListener('click', ()=> openModal());
xModal.addEventListener('click', closeModal);
modal.addEventListener('click', e=>{ if(e.target===modal) closeModal(); });

let editingId = null;

function openModal(id){
  document.getElementById('overlapErr').style.display='none';
  document.getElementById('mismatchWrap').style.display='none';
  document.getElementById('overwritePrev').checked=false;
  editingId = id || null;
  document.getElementById('emailIn').value = user.email || '';
  document.getElementById('firstName').value = user.first || '';
  document.getElementById('lastName').value  = user.last  || '';

  if(id){
    const b = bookings.find(x=>x.id===id);
    const isMine = !!user.email && b.userEmail===user.email;
    document.getElementById('modalTitle').textContent = isMine? 'Edit your booking' : 'Booking details';
    document.getElementById('firstName').value = b.first || '';
    document.getElementById('lastName').value  = b.last  || '';
    document.getElementById('aircraftSel').value=b.aircraft;
    document.getElementById('titleIn').value=b.title||'';
    document.getElementById('allDay').checked=false;
    const s=new Date(b.start), e=new Date(b.end);
    document.getElementById('startDate').value = s.toISOString().slice(0,10);
    document.getElementById('startTime').value = s.toTimeString().slice(0,5);
    document.getElementById('endDate').value   = e.toISOString().slice(0,10);
    document.getElementById('endTime').value   = e.toTimeString().slice(0,5);
    withInstructor.checked = !!b.instr; instrSel.disabled = !withInstructor.checked; instrSel.value = b.instr || '';
    document.getElementById('tachStart').value = b.tachStart??'';
    document.getElementById('tachEnd').value   = b.tachEnd??'';
    document.getElementById('hobbsStart').value= b.hobbsStart??'';
    document.getElementById('hobbsEnd').value  = b.hobbsEnd??'';
    document.getElementById('commentsIn').value= b.notes||'';

    // If not mine: make fields read-only
    const ro = !isMine;
    document.querySelectorAll('.in, select, textarea, #allDay, #withInstructor').forEach(el=>{
      if(el.id==='emailIn') { /* remains read-only */ return; }
      el.disabled = ro;
    });
    saveBtn.style.display = isMine ? 'inline-block' : 'none';
    deleteBtn.style.display = isMine ? 'inline-block' : 'none';
  }else{
    document.getElementById('modalTitle').textContent = 'Add title and time';
    ['titleIn','tachStart','tachEnd','hobbsStart','hobbsEnd','commentsIn'].forEach(id=>document.getElementById(id).value='');
    withInstructor.checked=false; instrSel.disabled=true; instrSel.value='';
    document.getElementById('aircraftSel').value='N78710';

    // default date/time to today 10:00â€“11:00
    const now = new Date(); now.setMinutes(0,0,0);
    const s = new Date(now); s.setHours(10);
    const e = new Date(now); e.setHours(11);
    document.getElementById('startDate').value = s.toISOString().slice(0,10);
    document.getElementById('startTime').value = s.toTimeString().slice(0,5);
    document.getElementById('endDate').value   = e.toISOString().slice(0,10);
    document.getElementById('endTime').value   = e.toTimeString().slice(0,5);

    document.querySelectorAll('.in, select, textarea').forEach(el=> el.disabled=false);
    saveBtn.style.display='inline-block'; deleteBtn.style.display='none';
  }
  modal.classList.add('open'); modal.setAttribute('aria-hidden','false');
}
function closeModal(){ modal.classList.remove('open'); modal.setAttribute('aria-hidden','true'); editingId=null; }

/* ========= Validation helpers ========= */
function parseDt(d,v){ return new Date(d.value + 'T' + (v.value||'00:00')); }
function numberOrNull(v){ const n=parseFloat(v); return isFinite(n)? n : null; }

function overlaps(aircraft, start, end, ignoreId=null){
  return bookings.some(b=> b.aircraft===aircraft && b.id!==ignoreId && !(end<=new Date(b.start) || start>=new Date(b.end)));
}

function getPreviousFlight(aircraft, start){
  const prev = bookings
    .filter(b=> b.aircraft===aircraft && new Date(b.end) <= start)
    .sort((a,b)=> new Date(b.end)-new Date(a.end))[0];
  return prev||null;
}

saveBtn.addEventListener('click', ()=>{
  const isNew = !editingId;
  const first = (document.getElementById('firstName').value||'').trim();
  const last  = (document.getElementById('lastName').value||'').trim();
  const email = user.email || '';
  if(!first || !last){ alert('First and last name are required.'); return; }
  if(!email){ alert('Sign in with an email first.'); return; }

  const ac = document.getElementById('aircraftSel').value;
  const title = document.getElementById('titleIn').value.trim();
  const s = parseDt(document.getElementById('startDate'), document.getElementById('startTime'));
  const e = parseDt(document.getElementById('endDate'),   document.getElementById('endTime'));
  if(!(s<e)){ alert('End must be after start.'); return; }

  // Overlap check
  const ov = overlaps(ac, s, e, editingId);
  document.getElementById('overlapErr').style.display = ov? 'block' : 'none';
  if(ov) return;

  const tS = numberOrNull(document.getElementById('tachStart').value);
  const tE = numberOrNull(document.getElementById('tachEnd').value);
  const hS = numberOrNull(document.getElementById('hobbsStart').value);
  const hE = numberOrNull(document.getElementById('hobbsEnd').value);

  const instr = document.getElementById('withInstructor').checked ? (document.getElementById('instrSel').value || '') : '';

  // Previous flight end mismatch logic
  const prev = getPreviousFlight(ac, s);
  let mismatch = false;
  if(prev){
    if(tS!=null && prev.tachEnd!=null && Math.abs(tS - prev.tachEnd) > 0.0001) mismatch = true;
    if(hS!=null && prev.hobbsEnd!=null && Math.abs(hS - prev.hobbsEnd) > 0.0001) mismatch = true;
  }
  document.getElementById('mismatchWrap').style.display = mismatch ? 'block' : 'none';

  const overwrite = document.getElementById('overwritePrev').checked;
  if(mismatch && !overwrite){
    // Ask user to confirm by checking the box
    return;
  }
  if(mismatch && overwrite && prev){
    // Update previous booking's end to match new starts
    if(tS!=null) prev.tachEnd = tS;
    if(hS!=null) prev.hobbsEnd = hS;
  }

  if(isNew){
    const id = 'b'+Math.random().toString(36).slice(2);
    bookings.push({
      id, userEmail: email, first, last,
      aircraft: ac, title, start:s.toISOString(), end:e.toISOString(),
      instr, tachStart:tS, tachEnd:tE, hobbsStart:hS, hobbsEnd:hE,
      notes: (document.getElementById('commentsIn').value||'').trim()
    });
  }else{
    const idx = bookings.findIndex(b=>b.id===editingId);
    if(idx>-1){
      const b = bookings[idx];
      if(b.userEmail !== email){ alert('You can only edit your own booking.'); return; }
      bookings[idx] = {
        ...b,
        first, last, aircraft: ac, title,
        start:s.toISOString(), end:e.toISOString(),
        instr, tachStart:tS, tachEnd:tE, hobbsStart:hS, hobbsEnd:hE,
        notes: (document.getElementById('commentsIn').value||'').trim()
      };
    }
  }
  saveBookings(); closeModal(); render();
});

deleteBtn.addEventListener('click', ()=>{
  if(!editingId) return;
  const idx = bookings.findIndex(b=>b.id===editingId);
  if(idx>-1){
    const b = bookings[idx];
    if(!user.email || user.email!==b.userEmail){ alert('You can only delete your own booking.'); return; }
    if(!confirm('Delete this booking?')) return;
    bookings.splice(idx,1);
    saveBookings(); closeModal(); render();
  }
});
</script>
</body>
</html>
