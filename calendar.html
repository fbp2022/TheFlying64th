<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Calendar â€“ The Flying 64th</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#0b1117; --ink:#e6edf3; --muted:#9fb1c3;
      --panel:#0f1722; --panel2:#0c141f; --rule:#1f2a38; --accent:#58a6ff;
      --radius:16px;
      --c172:#4da3ff;         /* N78710 (C172) */
      --c150:#ffd166;         /* N10921 (C150) â€” YELLOW */
      --instr:#b384ff;        /* with instructor overlay */
      --mine:#8bd26a;         /* my bookings â€” GREEN */
    }
    *{box-sizing:border-box}
    html,body{height:100%; margin:0}
    body{font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--ink)}

    /* ===== NAV (matches home.html look) ===== */
    .site-header{
      position:sticky; top:0; z-index:50;
      backdrop-filter:saturate(160%) blur(8px);
      background:rgba(11,17,23,.75);
      border-bottom:1px solid var(--rule);
    }
    .nav{
      max-width:1200px; margin:0 auto; padding:12px 18px;
      display:flex; align-items:center; justify-content:space-between; gap:12px;
    }
    .brand{
      display:flex; align-items:center; gap:10px; font-weight:800; letter-spacing:.2px;
      color:var(--ink); text-decoration:none; font-size:22px; white-space:nowrap;
    }
    .brand img{ height:34px; width:auto }
    header nav{ display:flex; align-items:center; gap:18px; flex-wrap:nowrap; }
    header nav a{
      color:var(--muted); text-decoration:none; padding:8px 12px; border-radius:10px; transition:all .18s ease;
    }
    header nav a:hover{ color:var(--ink); background:rgba(255,255,255,.06) }
    header nav a.active{ color:#001a33; background:var(--accent); font-weight:700 }

    /* ===== Banner ===== */
    .banner{
      max-width:1600px; width:96vw; margin:12px auto 0; padding:10px 14px;
      border:1px solid var(--rule); border-radius:14px;
      background:linear-gradient(180deg, var(--panel), var(--panel2));
      display:flex; gap:10px; align-items:center;
    }
    .banner b{color:#e9f1ff}

    /* ===== Calendar visuals ===== */
    .cal-head{ display:flex; justify-content:space-between; align-items:center; gap:10px; margin:10px auto 8px; max-width:1600px; width:96vw; }
    .calendar-wrap{ background:#0e1520; border:1px solid var(--rule); border-radius:12px; padding:10px; margin:0 auto 40px; max-width:1600px; width:96vw; }
    .cal-header{ display:grid; grid-template-columns:repeat(7,1fr); gap:6px; padding:0 6px; color:#9fb1c3; font-size:12px }
    .cal-row{ display:grid; grid-template-columns:repeat(7,1fr); gap:6px; padding:6px }
    .cell{ background:#0c141f; border:1px solid #142033; border-radius:10px; min-height:90px; padding:4px; position:relative; cursor:pointer }
    .cell .d{ position:absolute; top:6px; right:8px; color:#9fb1c3; font-size:12px }
    .cell:hover{ border-color:#2a4e86; box-shadow: inset 0 0 0 1px rgba(88,166,255,.25); }
    .today .d{ color:#fff; font-weight:800 }

    .evt{ margin-top:20px; border:1px solid #2a4e86; border-radius:8px; padding:6px 8px; font-size:12.5px; cursor:pointer;
          max-width:100%; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; background:#163055; }
    .evt.c172{ background:var(--c172); color:#001a33 }
    .evt.c150{ background:var(--c150); color:#3b2a00 }
    .evt.instr{ box-shadow:inset 0 0 0 2px var(--instr) }
    .evt.mine{ background:var(--mine); color:#0e2710; border-color:#5aa64c }
    .evt.maintenance{ background:#c03737; border-color:#e05a5a; color:#fff }

    /* Week/Day blocks */
    .slot{ position:absolute; left:0; right:0; min-height:28px; border-radius:8px; padding:6px 8px; font-size:12.5px; border:1px solid #2a4e86; cursor:pointer }
    .slot.c172{ background:var(--c172); color:#001a33 }
    .slot.c150{ background:var(--c150); color:#3b2a00 }
    .slot.instr{ box-shadow:inset 0 0 0 2px var(--instr) }
    .slot.mine{ background:var(--mine); color:#0e2710; border-color:#5aa64c }
    .slot.maintenance{ background:#c03737; border-color:#e05a5a; color:#fff }

    /* Controls */
    .btn{ border:1px solid var(--rule); background:#121b29; color:#e6edf3; padding:10px 14px; border-radius:10px; cursor:pointer; }
    .btn:hover{ border-color:#30507a; background:#142036; }
    .btn.primary{ background:var(--accent); color:#001a33; border-color:transparent; font-weight:700; }
    .btn.primary:hover{ filter:brightness(1.05); }
    .btn-sm{ border:1px solid var(--rule); background:#121b29; color:#e6edf3; padding:6px 10px; border-radius:8px; cursor:pointer; font-size:13px; }
    .chip{ display:inline-flex; align-items:center; gap:6px; background:#132031; border:1px solid #203148; color:#cfe1ff; padding:6px 10px; border-radius:100px; font-size:13px; cursor:pointer; }
    .chip.active{ background:#152238; color:#e6f0ff; font-weight:700 }

    /* ===== Modal (auth + booking) matches home.html) ===== */
    :root{ color-scheme:dark; }
    .modal{ position:fixed; inset:0; display:none; place-items:center; background:rgba(0,0,0,.5); backdrop-filter: blur(6px); z-index:2000; }
    .modal.open{ display:grid; animation: pop .18s ease-out; }
    @keyframes pop{ from{ transform:scale(.98); opacity:.6 } to{ transform:scale(1); opacity:1 } }
    .card{
      width:min(980px,96vw); max-height:90vh; overflow:auto;
      background:linear-gradient(180deg, var(--panel), var(--panel2));
      border:1px solid var(--rule);
      border-radius:14px; padding:18px;
      box-shadow:0 10px 30px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.03);
    }
    .label{ font-size:12px; color:var(--muted); margin:8px 0 6px }
    .input, select, textarea{
      width:100%; padding:10px 12px; border-radius:10px;
      background:#0b1117; color:var(--ink);
      border:1px solid #1f2a38; outline:none;
    }
    .input:focus, select:focus, textarea:focus{ border-color:#2a4e86; box-shadow:0 0 0 3px rgba(88,166,255,.18); }

    .pill{ display:inline-flex; align-items:center; gap:6px; background:#132031; border:1px solid #203148; color:#cfe1ff; padding:6px 10px; border-radius:999px; font-size:12px; }

    .warn{
      background:#1b1212; border:1px solid #5a2f2f; color:#ffc6c6;
      padding:10px 12px; border-radius:10px; font-size:13px;
    }

    /* Gate */
    .gate{ max-width:740px; margin:48px auto; padding:16px; background:linear-gradient(180deg, var(--panel), var(--panel2)); border:1px solid var(--rule); border-radius:14px; }
    .muted{ color:var(--muted) }
  </style>
</head>
<body>

  <!-- ===== NAV ===== -->
  <header class="site-header">
    <div class="nav">
      <a class="brand" href="home.html">
        <img src="images/flying64thlogo.png" alt="The Flying 64th Logo" style="width:80px;height:auto;">
        <span>The Flying 64th</span>
      </a>
      <nav>
        <a id="signinBtn" class="btn" style="margin-left:8px;">Sign In</a>
        <a href="home.html">Home</a>
        <a class="active" href="calendar.html">Calendar</a>
        <a href="becomeamember.html">Become a Member</a>
        <a href="photos.html">Photos</a>
        <a href="members.html">Members</a>
        <a href="poh&manuals.html">POH &amp; Manuals</a>
      </nav>
    </div>
  </header>

  <!-- ===== Gate (signed-in required) ===== -->
  <div id="gate" class="gate" role="region" aria-live="polite" style="display:none;">
    <h3 style="margin:0 0 6px 0;">Members Only</h3>
    <p class="muted" style="margin:0 0 10px 0;">
      Sign in to view and manage bookings.
    </p>
    <button class="btn primary" id="openGateSignin">Sign In</button>
  </div>

  <!-- ===== APP ===== -->
  <main id="app" style="display:none;">
    <div class="banner" role="note" aria-live="polite">
      <span>ðŸ””</span>
      <div><b>Reminder:</b> Enter <b>Tach</b> &amp; <b>Hobbs</b> start/end after every flight. If the prior end is missing, youâ€™ll be prompted to resolve it before <b>closing your flight</b>.</div>
    </div>

    <div class="cal-head">
      <div class="filters">
        <button id="fltAll" class="chip active">All</button>
        <button id="flt172" class="chip">N78710 â€” C172</button>
        <button id="flt150" class="chip">N10921 â€” C150</button>
      </div>
      <div class="tools">
        <button id="btnToday" class="btn-sm">Today</button>
        <button id="btnPrev" class="btn-sm">â€¹</button>
        <button id="btnNext" class="btn-sm">â€º</button>
        <button id="viewMonth" class="chip active">Month</button>
        <button id="viewWeek"  class="chip">Week</button>
        <button id="viewDay"   class="chip">Day</button>
        <button id="newBooking" class="btn primary">+ New booking</button>
      </div>
    </div>

    <section class="calendar-wrap">
      <div id="calendar" class="calendar"></div>
    </section>
  </main>

  <!-- ===== BOOKING MODAL ===== -->
  <div id="bookingModal" class="modal" aria-hidden="true">
    <div class="card" role="dialog" aria-modal="true" aria-labelledby="bkTitle">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">
        <h4 id="bkTitle" style="margin:0;">Add title and time</h4>
        <button id="bkClose" class="btn">âœ•</button>
      </div>

      <div id="ownBadge" class="pill" style="display:none;margin-bottom:8px;">Your booking</div>

      <div class="label">First name</div>
      <input id="firstName" class="input" placeholder="First name" autocomplete="given-name">

      <div class="label">Last name</div>
      <input id="lastName" class="input" placeholder="Last name" autocomplete="family-name">

      <div class="label">Email (from sign-in)</div>
      <input id="emailField" class="input" placeholder="you@example.com" readonly>

      <div class="label">Aircraft</div>
      <select id="aircraftSel" class="input">
        <option value="N78710">N78710 â€” Cessna 172</option>
        <option value="N10921">N10921 â€” Cessna 150</option>
      </select>

      <div class="label">Title</div>
      <input id="titleField" class="input" placeholder="e.g., Training flight or $100 burger">

      <div class="label">Start date/time</div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
        <input id="startDate" type="date" class="input">
        <input id="startTime" type="time" step="900" class="input">
      </div>

      <div class="label" style="margin-top:8px;">End date/time</div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
        <input id="endDate" type="date" class="input">
        <input id="endTime" type="time" step="900" class="input">
      </div>

      <div class="label" style="margin-top:8px;">Instructor</div>
      <select id="withInstr" class="input">
        <option value="none">None</option>
        <option value="Brian Westfall (BW)">Brian Westfall (BW)</option>
        <option value="Justin Cox (JC)">Justin Cox (JC)</option>
        <option value="Jeff Moersch (JM)">Jeff Moersch (JM)</option>
      </select>

      <div class="label" style="margin-top:8px;">Tach / Hobbs</div>
      <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:12px;">
        <input id="tachStart" class="input" inputmode="decimal" placeholder="Tach start">
        <input id="tachEnd"   class="input" inputmode="decimal" placeholder="Tach end">
        <input id="hobbsStart" class="input" inputmode="decimal" placeholder="Hobbs start">
        <input id="hobbsEnd"   class="input" inputmode="decimal" placeholder="Hobbs end">
      </div>

      <div id="mismatchWrap" class="warn" style="display:none;margin-top:10px;">
        Your Tach/Hobbs start donâ€™t match the previous flightâ€™s end. Check to overwrite the previous end values:
        <label style="margin-left:8px;display:inline-flex;gap:6px;align-items:center;">
          <input type="checkbox" id="overwritePrev"> Overwrite previous end with my starts
        </label>
      </div>

      <div class="label" style="margin-top:10px;">Comments</div>
      <textarea id="comments" class="input" rows="3"></textarea>

      <div style="display:flex;justify-content:flex-end;gap:10px;margin-top:12px;">
        <button id="delBtn" class="btn" style="display:none;">Delete</button>
        <button id="saveBtn" class="btn primary">Save</button>
      </div>
    </div>
  </div>

  <!-- ===== AUTH MODAL (identical flow to home.html) ===== -->
  <div id="authModal" class="modal" aria-hidden="true">
    <div class="card" role="dialog" aria-modal="true" aria-labelledby="authTitle">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">
        <h4 id="authTitle" style="margin:0;">Member Sign In</h4>
        <button id="closeAuth" class="btn">âœ•</button>
      </div>

      <!-- Sign-up fields (required for new accounts only) -->
      <label class="label" for="suFirst">First Name (sign up)</label>
      <input id="suFirst" class="input" type="text" placeholder="First name">

      <label class="label" for="suLast">Last Name (sign up)</label>
      <input id="suLast" class="input" type="text" placeholder="Last name">

      <label class="label" for="email">Email</label>
      <input id="email" class="input" type="email" placeholder="you@example.com" autocomplete="email">

      <label class="label" for="password">Password</label>
      <input id="password" class="input" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" autocomplete="current-password">

      <label class="label" for="invite">Invite Code (new accounts)</label>
      <input id="invite" class="input" type="text" placeholder="F64-CHRIS-2025-9QK7ATJ3">

      <div style="display:flex;justify-content:flex-end;gap:10px;margin-top:12px;">
        <button id="doReset" class="btn">Forgot password?</button>
        <button id="doSignUp" class="btn">Create Account</button>
        <button id="doSignIn" class="btn primary">Sign In</button>
      </div>

      <div id="authMsg" class="muted" style="min-height:18px;margin-top:6px;"></div>

      <div style="display:flex;justify-content:flex-end;margin-top:6px;">
        <button id="signOutBtn" class="btn">Sign out</button>
      </div>
    </div>
  </div>

  <script type="module">
    /* ===== Shared Firebase/App imports ===== */
    import { auth, db, onAuthChanged, requireActiveMember, signOut } from './auth.js';
    import {
      signInWithEmailAndPassword, createUserWithEmailAndPassword,
      sendPasswordResetEmail, sendEmailVerification
    } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";
    import {
      collection, doc, getDoc, getDocs, setDoc, addDoc, updateDoc, deleteDoc,
      query, where, orderBy, onSnapshot, serverTimestamp, Timestamp
    } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";

    /* ===== Force-refresh across tabs/pages ===== */
    window.addEventListener('storage', (e) => {
      if (e.key === 'f64_force_reload' && e.newValue) location.reload();
    });
    function broadcastRefresh(){ localStorage.setItem('f64_force_reload', String(Date.now())); }

    /* ===== Role helpers ===== */
    let currentUser = null;
    let role = "user";
    let isAdmin = false, isSuper = false, isOwner = false;

    async function loadRole(uid){
      role = "user"; isAdmin=false; isSuper=false; isOwner=false;
      if(!uid) return;
      const snap = await getDoc(doc(db,"profiles",uid));
      if(snap.exists()){
        role = (snap.data().role||"user").toLowerCase();
        isAdmin = role==="admin" || role==="superadmin" || role==="owner";
        isSuper = role==="superadmin" || role==="owner";
        isOwner = role==="owner";
      }
    }

    /* ===== UI refs ===== */
    const appEl  = document.getElementById('app');
    const gateEl = document.getElementById('gate');
    const openGateSignin = document.getElementById('openGateSignin');

    const signinBtn  = document.getElementById('signinBtn');
    const authModal  = document.getElementById('authModal');
    const closeAuth  = document.getElementById('closeAuth');
    const emailEl    = document.getElementById('email');
    const passEl     = document.getElementById('password');
    const inviteEl   = document.getElementById('invite');
    const suFirst    = document.getElementById('suFirst');
    const suLast     = document.getElementById('suLast');
    const doSignIn   = document.getElementById('doSignIn');
    const doSignUp   = document.getElementById('doSignUp');
    const doReset    = document.getElementById('doReset');
    const signOutBtn = document.getElementById('signOutBtn');
    const authMsg    = document.getElementById('authMsg');

    function openAuth(){ authModal.classList.add('open'); authModal.setAttribute('aria-hidden','false'); authMsg.textContent=""; }
    function closeAuthFn(){ authModal.classList.remove('open'); authModal.setAttribute('aria-hidden','true'); }
    document.getElementById('openGateSignin').addEventListener('click', openAuth);
    document.getElementById('signinBtn').addEventListener('click', openAuth);
    closeAuth.addEventListener('click', closeAuthFn);
    authModal.addEventListener('click', e=>{ if(e.target===authModal) closeAuthFn(); });
    // Enter-to-submit: if invite/first/last present -> SignUp else SignIn
    authModal.addEventListener('keydown', (e)=>{
      if(e.key==="Enter"){
        const wantsSignup = (inviteEl.value||"").trim() || (suFirst.value||"").trim() || (suLast.value||"").trim();
        if(wantsSignup) doSignUp.click(); else doSignIn.click();
      }
    });

    doSignIn.addEventListener('click', async ()=>{
      const email = (emailEl.value||"").trim(); const pass = passEl.value;
      if(!email||!pass){ authMsg.textContent="Enter email and password."; return; }
      try{ await signInWithEmailAndPassword(auth,email,pass); authMsg.textContent="Signed in."; closeAuthFn(); }
      catch(err){ authMsg.textContent = err.message; }
    });

    doSignUp.addEventListener('click', async ()=>{
      const email=(emailEl.value||"").trim();
      const pass=passEl.value;
      const code=(inviteEl.value||"").trim();
      const first=(suFirst.value||"").trim();
      const last=(suLast.value||"").trim();
      if(!email||!pass||!code||!first||!last){ authMsg.textContent="First, Last, Email, Password, and Invite Code are required."; return; }
      try{
        // Validate invite exists and not disabled
        const invRef = doc(db,"invites",code);
        const invSnap = await getDoc(invRef);
        if(!invSnap.exists() || invSnap.data().disabled===true){ authMsg.textContent="Invalid/disabled invite code."; return; }

        const cred = await createUserWithEmailAndPassword(auth,email,pass);
        await sendEmailVerification(cred.user);
        const baseData = {
          uid: cred.user.uid, email, firstName:first, lastName:last,
          emailVerified:false, active:true, role:"user",
          createdAt: serverTimestamp(), updatedAt: serverTimestamp()
        };
        await Promise.all([
          setDoc(doc(db,"profiles",cred.user.uid), baseData, {merge:true}),
          setDoc(doc(db,"members", cred.user.uid), baseData, {merge:true}),
          updateDoc(invRef, { used:true, usedByLast:cred.user.uid, usedAtLast:serverTimestamp() })
        ]);
        authMsg.textContent="Account created. Check your email to verify.";
      }catch(err){ authMsg.textContent=err.message; }
    });

    doReset.addEventListener('click', async ()=>{
      const email=(emailEl.value||"").trim(); if(!email){ authMsg.textContent="Enter your email first."; return; }
      try{ await sendPasswordResetEmail(auth,email); authMsg.textContent="Password reset email sent."; }
      catch(err){ authMsg.textContent=err.message; }
    });
    signOutBtn.addEventListener('click', async ()=>{ await signOut(auth); });

    /* ===== Gate + header text ===== */
    let pageAllowed = false;
    onAuthChanged(async (user) => {
      currentUser = user || null;

      if (currentUser) {
        const shortEmail = currentUser.email && currentUser.email.length > 25
          ? currentUser.email.slice(0, 25) + "â€¦"
          : (currentUser.email || "");
        signinBtn.textContent = `Account â€“ ${shortEmail}`;
        await loadRole(currentUser.uid);
      } else {
        signinBtn.textContent = "Sign In";
        role="user"; isAdmin=false; isSuper=false; isOwner=false;
      }

      let canUse = false;
      if (currentUser) {
        const gate = await requireActiveMember(currentUser);
        canUse = gate.ok;
      }
      pageAllowed = canUse;

      appEl.style.display  = canUse ? '' : 'none';
      gateEl.style.display = canUse ? 'none' : '';

      // Prefill email in booking modal fields when opened
      if (currentUser) emailField.value = currentUser.email || "";

      // Begin/refresh live subscription
      subscribe();
      render();
    });

    /* ===== Mail helper (admin+ only) ===== */
    async function getActiveEmails(){
      try{
        const list=[];
        const qP = query(collection(db,"profiles"), where("active","==",true));
        const snap = await getDocs(qP);
        snap.forEach(d=>{ const e=(d.data().email||"").trim(); if(e) list.push(e); });
        return list;
      }catch{ return []; }
    }
    function mailAll(bccList, subject, body){
      if(!bccList.length) return;
      const url = `mailto:?bcc=${encodeURIComponent(bccList.join(','))}&subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
      window.location.href = url;
    }

    /* ===== Calendar state & helpers ===== */
    const calEl = document.getElementById('calendar');
    const state = { filter:'all', view:'month', cursor:new Date() };

    // toolbar
    const filterBtns = {
      all: document.getElementById('fltAll'),
      c172: document.getElementById('flt172'),
      c150: document.getElementById('flt150'),
    };
    function setFilter(which){
      state.filter = which;
      Object.values(filterBtns).forEach(b=>b.classList.remove('active'));
      if(which==='all') filterBtns.all.classList.add('active');
      if(which==='N78710') filterBtns.c172.classList.add('active');
      if(which==='N10921') filterBtns.c150.classList.add('active');
      render();
    }
    filterBtns.all.addEventListener('click', ()=>setFilter('all'));
    filterBtns.c172.addEventListener('click', ()=>setFilter('N78710'));
    filterBtns.c150.addEventListener('click', ()=>setFilter('N10921'));

    const viewMonth = document.getElementById('viewMonth');
    const viewWeek  = document.getElementById('viewWeek');
    const viewDay   = document.getElementById('viewDay');
    function setView(v){
      state.view = v;
      [viewMonth,viewWeek,viewDay].forEach(b=>b.classList.remove('active'));
      (v==='month'?viewMonth:(v==='week'?viewWeek:viewDay)).classList.add('active');
      render();
    }
    viewMonth.addEventListener('click', ()=>setView('month'));
    viewWeek.addEventListener('click',  ()=>setView('week'));
    viewDay.addEventListener('click',   ()=>setView('day'));

    document.getElementById('btnPrev').addEventListener('click', ()=>{
      const d = new Date(state.cursor);
      if(state.view==='month') d.setMonth(d.getMonth()-1);
      else if(state.view==='week') d.setDate(d.getDate()-7);
      else d.setDate(d.getDate()-1);
      state.cursor = d; render();
    });
    document.getElementById('btnNext').addEventListener('click', ()=>{
      const d = new Date(state.cursor);
      if(state.view==='month') d.setMonth(d.getMonth()+1);
      else if(state.view==='week') d.setDate(d.getDate()+7);
      else d.setDate(d.getDate()+1);
      state.cursor = d; render();
    });
    document.getElementById('btnToday').addEventListener('click', ()=>{ state.cursor = new Date(); render(); });
    document.getElementById('newBooking').addEventListener('click', ()=>{
      if (!pageAllowed) { openAuth(); return; }
      openBookingModal(null, new Date(state.cursor));
    });

    function pad(n){ return String(n).padStart(2,'0'); }
    function startOfMonth(d){ const x=new Date(d); x.setDate(1); x.setHours(0,0,0,0); return x; }
    function endOfMonth(d){ const x=new Date(d); x.setMonth(x.getMonth()+1); x.setDate(0); x.setHours(23,59,59,999); return x; }
    function startOfWeek(d){ const x=new Date(d); const day=(x.getDay()+6)%7; x.setDate(x.getDate()-day); x.setHours(0,0,0,0); return x; }
    function endOfWeek(d){ const s=startOfWeek(d); const x=new Date(s); x.setDate(x.getDate()+6); x.setHours(23,59,59,999); return x; }
    function sameDate(a,b){ return a.getFullYear()===b.getFullYear() && a.getMonth()===b.getMonth() && a.getDate()===b.getDate(); }

    function labelText(bk){
      const s=new Date(bk.start);
      const time=`${pad(s.getHours()%12||12)}:${pad(s.getMinutes())}${s.getHours()<12?'a':'p'}`;
      const who=[bk.first,bk.last].filter(Boolean).join(' ');
      const title=(bk.title||'Booking').trim();
      return `${time} â€“ ${title}${who?' â€” '+who:''}`;
    }

    function eventClass(bk){
      const cls=[];
      cls.push(bk.aircraft==='N78710'?'c172':'c150');
      if(bk.withInstr && bk.withInstr!=='no' && bk.withInstr!=='none') cls.push('instr');
      if(/maintenance/i.test(bk.title||'')) cls.push('maintenance');
      if(currentUser && (bk.ownerEmail||"").toLowerCase()===(currentUser.email||"").toLowerCase()) cls.push('mine');
      return cls.join(' ');
    }

    /* ===== Live bookings (Firestore) ===== */
    let unsub = null;
    let bookings = []; // array of {id, ...}
    function subscribe(){
      if(unsub) unsub();
      unsub = onSnapshot(query(collection(db,"bookings"), orderBy("start","asc")), (snap)=>{
        bookings = [];
        snap.forEach(d=>{
          const m=d.data();
          bookings.push({
            id:d.id,
            aircraft:m.aircraft,
            title:m.title||"",
            start:m.start?.toDate ? m.start.toDate().toISOString() : m.start,
            end:m.end?.toDate ? m.end.toDate().toISOString() : m.end,
            withInstr:m.withInstr||"none",
            tachStart:m.tachStart||"",
            tachEnd:m.tachEnd||"",
            hobbsStart:m.hobbsStart||"",
            hobbsEnd:m.hobbsEnd||"",
            comments:m.comments||"",
            ownerEmail:(m.ownerEmail||"").toLowerCase(),
            first:m.first||"",
            last:m.last||""
          });
        });
        render();
      });
    }

    function relevant(bk, rangeStart, rangeEnd){
      if(state.filter!=='all' && bk.aircraft!==state.filter) return false;
      const s=new Date(bk.start), e=new Date(bk.end);
      return e>=rangeStart && s<=rangeEnd;
    }

    function render(){
      calEl.innerHTML='';
      const today = new Date();

      if(state.view==='month'){
        const start = startOfWeek(startOfMonth(state.cursor));
        const end   = endOfWeek(endOfMonth(state.cursor));

        const head=document.createElement('div'); head.className='cal-header';
        ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'].forEach(d=>{ const el=document.createElement('div'); el.textContent=d; head.appendChild(el); });
        calEl.appendChild(head);

        let d=new Date(start);
        while(d<=end){
          const row=document.createElement('div'); row.className='cal-row';
          for(let i=0;i<7;i++){
            const dayDate = new Date(d);
            const cell=document.createElement('div'); cell.className='cell'+(sameDate(d,today)?' today':'');
            const dayNum=document.createElement('div'); dayNum.className='d'; dayNum.textContent=d.getDate();
            cell.appendChild(dayNum);

            cell.addEventListener('click', (ev)=>{
              if(ev.target===cell || ev.target===dayNum){
                if (!pageAllowed) { openAuth(); return; }
                openBookingModal(null, dayDate);
              }
            });

            const dayStart=new Date(d.getFullYear(),d.getMonth(),d.getDate(),0,0,0,0);
            const dayEnd  =new Date(d.getFullYear(),d.getMonth(),d.getDate(),23,59,59,999);

            bookings.filter(b=>relevant(b,dayStart,dayEnd)).forEach(bk=>{
              const e=document.createElement('div');
              e.className='evt '+eventClass(bk);
              const s=new Date(bk.start), eD=new Date(bk.end);
              e.textContent=labelText(bk);
              e.title=`${bk.title||'Booking'} â€¢ ${s.toLocaleString()} â†’ ${eD.toLocaleString()}`;
              e.addEventListener('click', (evt)=>{ evt.stopPropagation(); if(!pageAllowed){openAuth();return;} openBookingModal(bk); });
              cell.appendChild(e);
            });

            row.appendChild(cell);
            d.setDate(d.getDate()+1);
          }
          calEl.appendChild(row);
        }
      } else if(state.view==='week' || state.view==='day'){
        const start = state.view==='week' ? startOfWeek(state.cursor) : new Date(state.cursor.getFullYear(),state.cursor.getMonth(),state.cursor.getDate());

        const head=document.createElement('div'); head.className='cal-header';
        const days = state.view==='week'?7:1;
        for(let i=0;i<days;i++){
          const dt=new Date(start); dt.setDate(start.getDate()+i);
          const el=document.createElement('div');
          el.textContent=`${dt.toLocaleDateString(undefined,{weekday:'short'})} ${dt.getMonth()+1}/${dt.getDate()}`;
          head.appendChild(el);
        }
        calEl.appendChild(head);

        const row=document.createElement('div'); row.className='cal-row'; row.style.gridTemplateColumns=`repeat(${days},1fr)`;
        for(let i=0;i<days;i++){
          const dt=new Date(start); dt.setDate(start.getDate()+i);
          const cell=document.createElement('div'); cell.className='cell'; cell.style.minHeight='520px';

          cell.addEventListener('click', ()=> { if(!pageAllowed){openAuth();return;} openBookingModal(null, dt); });

          const d0=new Date(dt.getFullYear(),dt.getMonth(),dt.getDate(),0,0,0,0);
          const d1=new Date(dt.getFullYear(),dt.getMonth(),dt.getDate(),23,59,59,999);

          bookings.filter(b=>relevant(b,d0,d1)).forEach(bk=>{
            const s=new Date(bk.start), eD=new Date(bk.end);
            const totalMinutes=(eD-s)/60000;
            const top=((s.getHours()*60 + s.getMinutes())/(24*60))*100;
            const height=Math.max(28,(totalMinutes/(24*60))*100);
            const slot=document.createElement('div');
            slot.className='slot '+eventClass(bk);
            slot.style.top=`calc(${top}% - 6px)`;
            slot.style.height=`calc(${height}% - 6px)`;
            slot.textContent=labelText(bk);
            slot.addEventListener('click', (evt)=>{ evt.stopPropagation(); if(!pageAllowed){openAuth();return;} openBookingModal(bk); });
            cell.appendChild(slot);
          });

          row.appendChild(cell);
        }
        calEl.appendChild(row);
      }
    }

    /* ===== Booking modal ===== */
    const modal = document.getElementById('bookingModal');
    const closeBtn = document.getElementById('bkClose');
    const saveBtn  = document.getElementById('saveBtn');
    const delBtn   = document.getElementById('delBtn');
    const ownBadge = document.getElementById('ownBadge');

    const firstName = document.getElementById('firstName');
    const lastName  = document.getElementById('lastName');
    const emailField= document.getElementById('emailField');
    const aircraftSel=document.getElementById('aircraftSel');
    const titleField= document.getElementById('titleField');
    const startDate = document.getElementById('startDate');
    const endDate   = document.getElementById('endDate');
    const startTime = document.getElementById('startTime');
    const endTime   = document.getElementById('endTime');
    const withInstr = document.getElementById('withInstr');
    const tachStart = document.getElementById('tachStart');
    const tachEnd   = document.getElementById('tachEnd');
    const hobbsStart= document.getElementById('hobbsStart');
    const hobbsEnd  = document.getElementById('hobbsEnd');
    const comments  = document.getElementById('comments');
    const mismatchWrap   = document.getElementById('mismatchWrap');
    const overwritePrev  = document.getElementById('overwritePrev');

    let editingId = null;

    function openBookingModal(bk=null, presetDate=null){
      editingId = bk ? bk.id : null;
      ownBadge.style.display='none';
      delBtn.style.display='none';
      overwritePrev.checked=false;
      mismatchWrap.style.display='none';

      emailField.value = currentUser?.email || "";
      // keep names sticky once typed; don't auto-overwrite

      if(bk){
        document.getElementById('bkTitle').textContent = "Booking details";
        const mine = currentUser && (bk.ownerEmail||"").toLowerCase()===(currentUser.email||"").toLowerCase();
        ownBadge.style.display = mine ? 'inline-flex' : 'none';
        delBtn.style.display   = (mine || isSuper || isOwner) ? 'inline-block' : 'none';
        fill(bk);
        setReadOnly(!(mine || isSuper || isOwner)); // only mine or super/owner can edit
      }else{
        document.getElementById('bkTitle').textContent = "Add title and time";
        setReadOnly(false);
        const s = presetDate ? new Date(presetDate) : new Date(state.cursor);
        const mm=String(s.getMonth()+1).padStart(2,'0'), dd=String(s.getDate()).padStart(2,'0');
        startDate.value = `${s.getFullYear()}-${mm}-${dd}`;
        endDate.value   = startDate.value;
        startTime.value = "10:00";
        endTime.value   = "11:00";
        aircraftSel.value = (state.filter==='N78710'||state.filter==='N10921')?state.filter:'N78710';
        titleField.value = "";
        withInstr.value="none";
        tachStart.value=tachEnd.value=hobbsStart.value=hobbsEnd.value="";
        comments.value="";
      }

      modal.classList.add('open'); modal.setAttribute('aria-hidden','false');
      titleField.focus();
      checkMismatch();
    }
    function setReadOnly(ro){
      [firstName,lastName,startDate,endDate,startTime,endTime,titleField,withInstr,tachStart,tachEnd,hobbsStart,hobbsEnd,comments,aircraftSel]
        .forEach(el=> el.readOnly = ro);
      withInstr.disabled = ro;
      aircraftSel.disabled = ro;
      saveBtn.style.display = ro ? 'none' : 'inline-block';
    }
    function fill(bk){
      firstName.value=bk.first||"";
      lastName.value=bk.last||"";
      emailField.value=bk.ownerEmail||"";
      aircraftSel.value=bk.aircraft;
      titleField.value=bk.title||"";
      const s=new Date(bk.start), e=new Date(bk.end);
      startDate.value=`${s.getFullYear()}-${String(s.getMonth()+1).padStart(2,'0')}-${String(s.getDate()).padStart(2,'0')}`;
      endDate.value  =`${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,'0')}-${String(e.getDate()).padStart(2,'0')}`;
      startTime.value=`${String(s.getHours()).padStart(2,'0')}:${String(s.getMinutes()).padStart(2,'0')}`;
      endTime.value  =`${String(e.getHours()).padStart(2,'0')}:${String(e.getMinutes()).padStart(2,'0')}`;
      withInstr.value=bk.withInstr||'none';
      tachStart.value=bk.tachStart||"";
      tachEnd.value  =bk.tachEnd||"";
      hobbsStart.value=bk.hobbsStart||"";
      hobbsEnd.value  =bk.hobbsEnd||"";
      comments.value=bk.comments||"";
    }
    function closeBooking(){ modal.classList.remove('open'); modal.setAttribute('aria-hidden','true'); }
    closeBtn.addEventListener('click', closeBooking);
    // click outside to close
    modal.addEventListener('click', (e)=>{ if(e.target===modal) closeBooking(); });

    // basic overlap + maintenance conflict on client
    function overlaps(candidate, ignoreId=null){
      const cs=new Date(candidate.start), ce=new Date(candidate.end);
      return bookings.some(b=>{
        if(b.aircraft!==candidate.aircraft) return false;
        if(ignoreId && b.id===ignoreId) return false;
        const bs=new Date(b.start), be=new Date(b.end);
        return (cs<be) && (ce>bs);
      });
    }
    function findPrevForTailBefore(tail, when){
      const list = bookings.filter(b=>b.aircraft===tail && new Date(b.end) <= when)
                           .sort((a,b)=> new Date(b.end)-new Date(a.end));
      return list[0] || null;
    }
    function checkMismatch(){
      const tail=aircraftSel.value;
      const startIso = new Date(`${startDate.value}T${startTime.value||"00:00"}`);
      if(isNaN(startIso.getTime())){ mismatchWrap.style.display='none'; return; }
      const prev = findPrevForTailBefore(tail,startIso);
      if(!prev){ mismatchWrap.style.display='none'; return; }
      let mismatch=false;
      if(tachStart.value && prev.tachEnd   && Number(tachStart.value)!=Number(prev.tachEnd)) mismatch=true;
      if(hobbsStart.value && prev.hobbsEnd && Number(hobbsStart.value)!=Number(prev.hobbsEnd)) mismatch=true;
      mismatchWrap.style.display = mismatch ? 'block' : 'none';
    }
    [aircraftSel,startDate,startTime,tachStart,hobbsStart].forEach(el=> el.addEventListener('input', checkMismatch));

    /* ===== Save/Delete (Firestore) ===== */
    saveBtn.addEventListener('click', async ()=>{
      if(!currentUser){ alert("Please sign in first."); return; }

      const first=(firstName.value||"").trim();
      const last =(lastName.value||"").trim();
      if(!first || !last){ alert("First and Last name are required."); return; }

      const s = new Date(`${startDate.value}T${startTime.value||"00:00"}`);
      const e = new Date(`${endDate.value}T${endTime.value||"00:00"}`);
      if(isNaN(s)||isNaN(e)|| e<=s){ alert("Please enter a valid start/end."); return; }

      const data = {
        aircraft: aircraftSel.value,
        title: (titleField.value||"").trim(),
        start: Timestamp.fromDate(s),
        end:   Timestamp.fromDate(e),
        withInstr: withInstr.value,
        tachStart: tachStart.value || "",
        tachEnd:   tachEnd.value   || "",
        hobbsStart: hobbsStart.value || "",
        hobbsEnd:   hobbsEnd.value   || "",
        comments: (comments.value||"").trim(),
        ownerEmail: (currentUser.email||"").toLowerCase(),
        first, last,
        createdByUid: currentUser.uid,
        updatedAt: serverTimestamp()
      };

      // Client-side guard: prevent non-admin creating maintenance blocks
      const isMaint = /maintenance/i.test(data.title);
      if(isMaint && !isAdmin){ alert("Only admins/superadmins/owner can create maintenance blocks."); return; }

      // Client-side overlap check (server rules still enforce)
      if(overlaps({ ...data, start:s.toISOString(), end:e.toISOString() }, editingId)){
        alert("This overlaps an existing booking for this aircraft."); return;
      }

      // Tach/Hobbs mismatch resolve
      const prev = findPrevForTailBefore(data.aircraft, s);
      if(prev){
        const needFix = (data.tachStart && prev.tachEnd && Number(data.tachStart)!=Number(prev.tachEnd))
                     || (data.hobbsStart && prev.hobbsEnd && Number(data.hobbsStart)!=Number(prev.hobbsEnd));
        if(needFix && overwritePrev.checked){
          // Logically this will be corrected on the previous booking by an admin via UI later;
          // Firestore security prevents changing others here unless super/owner.
        }else if(needFix){
          alert("Start Tach/Hobbs do not match the previous end. Check the overwrite box to proceed (admin/super/owner will reconcile).");
          return;
        }
      }

      try{
        if(editingId){
          await updateDoc(doc(db,"bookings",editingId), data);
        }else{
          await addDoc(collection(db,"bookings"), { ...data, createdAt: serverTimestamp() });
        }

        // notify (admin+ only) and broadcast refresh
        if(isAdmin){
          const all = await getActiveEmails();
          if(all.length){
            const subj = isMaint ? "MAINTENANCE block posted" : "New booking posted";
            const body =
`Title: ${data.title||'(none)'}
Aircraft: ${data.aircraft}
When: ${s.toLocaleString()} â†’ ${e.toLocaleString()}
By: ${first} ${last} <${data.ownerEmail}>${isMaint ? "\n\nNOTE: Maintenance blocks prevent other bookings during this period." : ""}`;
            mailAll(all, `The Flying 64th â€“ ${subj}`, body);
          }
        }

        broadcastRefresh();
        closeBooking();
      }catch(err){
        alert(err.message);
      }
    });

    delBtn.addEventListener('click', async ()=>{
      if(!currentUser || !editingId) return;
      if(!confirm("Delete this booking?")) return;

      try{
        await deleteDoc(doc(db,"bookings",editingId));

        if(isAdmin){
          const all = await getActiveEmails();
          if(all.length){
            mailAll(all, "The Flying 64th â€“ Booking deleted", "A booking was deleted from the calendar.");
          }
        }

        broadcastRefresh();
        closeBooking();
      }catch(err){
        alert(err.message);
      }
    });

    function setReadOnly(ro){
      [firstName,lastName,startDate,endDate,startTime,endTime,titleField,withInstr,tachStart,tachEnd,hobbsStart,hobbsEnd,comments,aircraftSel]
        .forEach(el=> el.readOnly = ro);
      withInstr.disabled = ro;
      aircraftSel.disabled = ro;
      saveBtn.style.display = ro ? 'none' : 'inline-block';
    }
  </script>
</body>
</html>
