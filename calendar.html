<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Calendar â€“ The Flying 64th</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#0b1117; --ink:#e6edf3; --muted:#9fb1c3;
      --panel:#0f1722; --panel2:#0c141f; --rule:#1f2a38; --accent:#58a6ff;
      --radius:16px;
      --c172:#4da3ff;
      --c150:#8bd26a;
      --instr:#b384ff;
      --mine:#ffd166;
    }
    *{box-sizing:border-box}
    html,body{height:100%; margin:0}
    body{font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--ink)}

    /* ===== NAV ===== */
    .site-header{
      position:sticky; top:0; z-index:50;
      backdrop-filter:saturate(160%) blur(8px);
      background:rgba(11,17,23,.75);
      border-bottom:1px solid var(--rule);
    }
    .nav{
      max-width:1200px; margin:0 auto; padding:12px 18px;
      display:flex; align-items:center; justify-content:space-between; gap:12px;
    }
    .brand{
      display:flex; align-items:center; gap:10px; font-weight:800;
      color:var(--ink); text-decoration:none; font-size:22px;
    }
    .brand img{ height:34px; width:auto }
    header nav{ display:flex; align-items:center; gap:18px }
    header nav a{
      color:var(--muted); text-decoration:none; padding:8px 12px; border-radius:10px; transition:all .18s ease;
    }
    header nav a:hover{ color:var(--ink); background:rgba(255,255,255,.06) }
    header nav a.active{ color:#001a33; background:var(--accent); font-weight:700 }

    /* ===== LOCKED VIEW ===== */
    .locked{
      display:grid; place-items:center;
      min-height:58vh; padding:24px;
    }
    .locked-card{
      width:min(560px,94vw);
      background:linear-gradient(180deg, var(--panel), var(--panel2));
      border:1px solid var(--rule);
      border-radius:14px; padding:20px;
      box-shadow:0 10px 30px rgba(0,0,0,.35);
    }

    /* ===== Banner ===== */
    .banner{
      max-width:1600px; width:96vw; margin:12px auto 0; padding:10px 14px;
      border:1px solid var(--rule); border-radius:14px;
      background:linear-gradient(180deg, var(--panel), var(--panel2));
      display:flex; gap:10px; align-items:center;
    }

    /* ===== Cards ===== */
    .note-card, .cal-card{
      background:#0e1520;
      border:1px solid var(--rule);
      border-radius:12px;
      padding:10px;
    }
    .note-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;}
    .notes-row{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin:12px auto;max-width:1600px;width:96vw;}
    @media(max-width:1080px){.notes-row{grid-template-columns:1fr}}

    .calendar{
      min-height:64vh;
      border:1px dashed rgba(255,255,255,.12);
      border-radius:10px;
      padding:8px;
      overflow:auto;
    }

    .btn{border:1px solid var(--rule);background:#121b29;color:#e6edf3;padding:10px 14px;border-radius:10px;cursor:pointer;}
    .btn:hover{border-color:#30507a;background:#142036;}
    .btn.primary{background:var(--accent);color:#001a33;border-color:transparent;font-weight:700;}
    .btn.primary:hover{filter:brightness(1.05);}
    .btn-sm{border:1px solid var(--rule);background:#121b29;color:#e6edf3;padding:6px 10px;border-radius:8px;cursor:pointer;font-size:13px;}

    .chip{
      display:inline-flex;align-items:center;gap:6px;background:#132031;
      border:1px solid #203148;color:#cfe1ff;padding:6px 10px;
      border-radius:100px;font-size:13px;cursor:pointer;
    }
    .chip.active{background:#152238;color:#e6f0ff;font-weight:700}
  </style>
</head>

<body>
  <!-- ===== NAV ===== -->
  <header class="site-header">
    <div class="nav">
      <a class="brand" href="home.html">
        <img src="images/flying64thlogo.png" alt="The Flying 64th Logo">
        <span>The Flying 64th</span>
      </a>
      <nav>
        <a id="signinBtn" class="btn" style="margin-left:8px;">Sign In</a>
        <a href="home.html">Home</a>
        <a class="active" href="calendar.html">Calendar</a>
        <a href="becomeamember.html">Become a Member</a>
        <a href="photos.html">Photos</a>
        <a href="poh&manuals.html">POH &amp; Manuals</a>
      </nav>
    </div>
  </header>

  <!-- ===== LOCKED SCREEN ===== -->
  <section id="locked" class="locked">
    <div class="locked-card">
      <h2>Members Only</h2>
      <p id="lockMsg" class="muted">Please sign in to view the calendar and aircraft notes.</p>
      <div style="display:flex;gap:10px;flex-wrap:wrap;">
        <button id="lockSignIn" class="btn primary">Sign In</button>
        <a href="home.html" class="btn">Go to Home</a>
      </div>
    </div>
  </section>

  <!-- ===== APP ===== -->
  <main id="app" style="display:none">
    <div class="banner"><span>ðŸ””</span>
      <div><b>Reminder:</b> Enter <b>Tach</b> &amp; <b>Hobbs</b> start/end after every flight.</div>
    </div>

    <div class="notes-row">
      <section class="note-card">
        <header class="note-head">
          <strong>N78710 â€” Cessna 172</strong>
          <button id="saveNote172" class="btn-sm">Save note</button>
        </header>
        <textarea id="note172" placeholder="e.g., N78710 oil change or maintenance note."></textarea>
      </section>

      <section class="note-card">
        <header class="note-head">
          <strong>N10921 â€” Cessna 150</strong>
          <button id="saveNote150" class="btn-sm">Save note</button>
        </header>
        <textarea id="note150" placeholder="e.g., N10921 flap issue, avoid touch-and-goâ€™s."></textarea>
      </section>
    </div>

    <section class="cal-card">
      <header class="cal-head" style="display:flex;justify-content:space-between;flex-wrap:wrap;gap:10px;">
        <div>
          <button id="fltAll" class="chip active">All</button>
          <button id="flt172" class="chip">N78710</button>
          <button id="flt150" class="chip">N10921</button>
        </div>
        <div>
          <button id="btnToday" class="btn-sm">Today</button>
          <button id="btnPrev" class="btn-sm">â€¹</button>
          <button id="btnNext" class="btn-sm">â€º</button>
          <button id="newBooking" class="btn primary">+ New booking</button>
        </div>
      </header>
      <div id="calendar" class="calendar"></div>
    </section>
  </main>

  <!-- ===== AUTH MODAL ===== -->
  <div id="authModal" class="modal" aria-hidden="true" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.55);place-items:center;z-index:2000;">
    <div class="card" style="width:min(500px,95vw);background:linear-gradient(180deg,var(--panel),var(--panel2));border:1px solid var(--rule);border-radius:14px;padding:20px;">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">
        <h4 id="authTitle" style="margin:0;">Member Sign In</h4>
        <button id="closeAuth" class="btn">âœ•</button>
      </div>

       <div class="row" style="display:grid;gap:10px;margin-top:10px;">
        <div><div class="label">First name (sign up)</div><input id="signupFirst" class="input" type="text"></div>
        <div><div class="label">Last name (sign up)</div><input id="signupLast" class="input" type="text"></div>
      </div>
     
      <label class="label" for="email">Email</label>
      <input id="email" class="input" type="email" placeholder="you@example.com">

      <label class="label" for="password">Password</label>
      <input id="password" class="input" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">

     <label class="label" for="invite">Invite Code (new accounts)</label>
      <input id="invite" class="input" type="text" placeholder="Board Admin Will Provide Invite Code">

      <div class="modal-actions" style="display:flex;gap:10px;flex-wrap:wrap;margin-top:14px;">
        <button id="doReset" class="btn">Forgot password?</button>
        <button id="doSignUp" class="btn">Create Account</button>
        <button id="doSignIn" class="btn primary">Sign In</button>
      </div>
      <div id="authMsg" class="muted" style="margin-top:10px;min-height:18px;"></div>
      <div class="modal-actions" style="display:flex;justify-content:flex-end;margin-top:10px;">
        <button id="signOutBtn" class="btn">Sign out</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { auth, onAuthChanged, requireActiveMember, signOut } from './auth.js';
    import {
      signInWithEmailAndPassword,
      createUserWithEmailAndPassword,
      sendPasswordResetEmail,
      sendEmailVerification,
      updateProfile
    } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";

    const signinBtn = document.getElementById('signinBtn');
    const authModal = document.getElementById('authModal');
    const closeAuth = document.getElementById('closeAuth');
    const emailEl = document.getElementById('email');
    const passEl = document.getElementById('password');
    const inviteEl = document.getElementById('invite');
    const doSignIn = document.getElementById('doSignIn');
    const doSignUp = document.getElementById('doSignUp');
    const doReset = document.getElementById('doReset');
    const signOutBtn = document.getElementById('signOutBtn');
    const authMsg = document.getElementById('authMsg');

    const openAuth = ()=>{authModal.style.display="grid";authMsg.textContent="";}
    const closeAuthFn = ()=>{authModal.style.display="none";}
    signinBtn.addEventListener('click',openAuth);
    closeAuth.addEventListener('click',closeAuthFn);
    authModal.addEventListener('click',e=>{if(e.target===authModal)closeAuthFn();});

    doSignIn.addEventListener('click',async()=>{
      const email=(emailEl.value||"").trim();const pass=passEl.value;
      if(!email||!pass){authMsg.textContent="Enter email and password.";return;}
      try{await signInWithEmailAndPassword(auth,email,pass);authMsg.textContent="Signed in.";closeAuthFn();}
      catch(err){authMsg.textContent=err.message;}
    });

    doSignUp.addEventListener('click',async()=>{
      const email=(emailEl.value||"").trim();
      const pass=passEl.value;
      const code=(inviteEl.value||"").trim();
      const first=(document.getElementById('signupFirst')?.value||"").trim();
      const last=(document.getElementById('signupLast')?.value||"").trim();
      if(!email||!pass||!code){authMsg.textContent="Email, password, and invite code are required.";return;}
      if(!first||!last){authMsg.textContent="Please enter your first and last name.";return;}
      try{
        const cred=await createUserWithEmailAndPassword(auth,email,pass);
        await updateProfile(cred.user,{displayName:`${first} ${last}`});
        await sendEmailVerification(cred.user);
        authMsg.textContent="Account created. Check your email to verify.";
      }catch(err){authMsg.textContent=err.message;}
    });

    doReset.addEventListener('click',async()=>{
      const email=(emailEl.value||"").trim();
      if(!email){authMsg.textContent="Enter email first.";return;}
      try{await sendPasswordResetEmail(auth,email);authMsg.textContent="Password reset email sent.";}
      catch(err){authMsg.textContent=err.message;}
    });

    signOutBtn.addEventListener('click',async()=>{await signOut(auth);});

    // Gate logic
    let currentUser=null;
    const appEl=document.getElementById('app');
    const lockedEl=document.getElementById('locked');
    const lockMsg=document.getElementById('lockMsg');
    const lockSignInBtn=document.getElementById('lockSignIn');
    lockSignInBtn.addEventListener('click',()=>openAuth());

    function showLocked(msg){
      if(lockMsg&&msg)lockMsg.textContent=msg;
      appEl.style.display='none';
      lockedEl.style.display='grid';
    }
    function showApp(){
      lockedEl.style.display='none';
      appEl.style.display='block';
    }

    onAuthChanged(async(user)=>{
      currentUser=user||null;
      signinBtn.textContent=currentUser?`Account â€“ ${currentUser.email}`:"Sign In";
      let canUse=false;
      if(currentUser){
        const gate=await requireActiveMember(currentUser);
        canUse=gate.ok;
        if(!canUse){showLocked(gate.msg||"Verify your email or wait for activation.");}
        else{showApp();}
      }else{
        showLocked("Please sign in to view the calendar and notes.");
      }
    });
  </script>
</body>
</html>
